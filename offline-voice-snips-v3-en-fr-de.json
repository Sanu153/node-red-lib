[
    {
        "id": "eaca0ac7.88c298",
        "type": "tab",
        "label": "SNIPS V3"
    },
    {
        "id": "eb60198e.f18468",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": true,
        "x": 2070,
        "y": 240,
        "wires": [
            [
                "10cc755a.0d8ceb",
                "dccacc10.26c4c"
            ]
        ]
    },
    {
        "id": "95ff4b2d.165d88",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "========================================================================SNIPS INTENTS INPUT=======================================================================",
        "info": "",
        "x": 2410,
        "y": 100,
        "wires": []
    },
    {
        "id": "e2545062.c8de6",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "endSession",
        "func": "msg.payload = {\n    \"sessionId\": msg.payload.sessionId    \n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 790,
        "y": 160,
        "wires": [
            [
                "7ab57f9d.b7ce4"
            ]
        ]
    },
    {
        "id": "7ab57f9d.b7ce4",
        "type": "mqtt out",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "hermes/dialogueManager/endSession",
        "qos": "",
        "retain": "",
        "broker": "c0e0d49d.594088",
        "x": 1028.99995803833,
        "y": 159.9999942779541,
        "wires": []
    },
    {
        "id": "c62731aa.851a5",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "delay",
        "timeout": "250",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 630,
        "y": 160,
        "wires": [
            [
                "e2545062.c8de6"
            ]
        ]
    },
    {
        "id": "545a2016.1cec2",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "===================================================================================SNIPS CORE FUNCTIONS===================================================================================",
        "info": "",
        "x": 790,
        "y": 20,
        "wires": []
    },
    {
        "id": "cf51487e.8d77a8",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "=================================================================================HOME AUTOMATION INTENTS===================================================================================",
        "info": "",
        "x": 2420,
        "y": 20,
        "wires": []
    },
    {
        "id": "ab6f545a.9f0c38",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "===============================CLOSE SNIPS SESSION=================================",
        "info": "",
        "x": 510,
        "y": 100,
        "wires": []
    },
    {
        "id": "c8aa1b9f.0682e8",
        "type": "link in",
        "z": "eaca0ac7.88c298",
        "name": "Session OUT",
        "links": [
            "dccacc10.26c4c",
            "5d2f2827.88ca68",
            "93009144.1645d",
            "b54336f8.fbad28",
            "83cb1008.359f4"
        ],
        "x": 515,
        "y": 160,
        "wires": [
            [
                "c62731aa.851a5"
            ]
        ]
    },
    {
        "id": "3a674cbc.fb2a84",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "GET devices",
        "method": "GET",
        "ret": "txt",
        "url": "http://localhost:3000/rest/alexa/skill/items",
        "tls": "",
        "x": 550,
        "y": 480,
        "wires": [
            [
                "11a997b2.504cd8"
            ]
        ]
    },
    {
        "id": "11a997b2.504cd8",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 690,
        "y": 480,
        "wires": [
            [
                "a4f3aa90.707498"
            ]
        ]
    },
    {
        "id": "16a3ac74.0dbb84",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "List_devices",
        "func": "flow.set(\"msgDeviceList\", msg.payload); // save for later use\nflow.set(\"msgProServIP\", msg.proServIP); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1150,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "b30a8798.12dee8",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "GET ProServIP",
        "method": "GET",
        "ret": "txt",
        "url": "http://{{{payload}}}:3000/proservip",
        "tls": "",
        "x": 1200,
        "y": 400,
        "wires": [
            [
                "92aba60f.b5fb48"
            ]
        ]
    },
    {
        "id": "92aba60f.b5fb48",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "proServIP",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1390,
        "y": 400,
        "wires": [
            [
                "3a674cbc.fb2a84"
            ]
        ]
    },
    {
        "id": "edcfdd29.991d5",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 280,
        "y": 300,
        "wires": [
            [
                "fb12a6d4.114a88",
                "68a63664.b02aa8",
                "466f8cc6.190634",
                "e47126c6.967d48",
                "478e1b8.8594ae4",
                "6ace3b8c.4fcb14"
            ]
        ]
    },
    {
        "id": "14cf6e5c.6113c2",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "===============================GET LIST OF DEVICES==================================",
        "info": "",
        "x": 510,
        "y": 240,
        "wires": []
    },
    {
        "id": "4bd98a40.6362a4",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"on\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 160,
        "wires": [
            [
                "4d0770e0.41328"
            ]
        ]
    },
    {
        "id": "b3b9fcfa.6c32e",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "=============================GET CURRENT LANGUAGE================================",
        "info": "",
        "x": 510,
        "y": 900,
        "wires": []
    },
    {
        "id": "7b6e6f.5450619",
        "type": "mqtt out",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "hermes/tts/say",
        "qos": "",
        "retain": "",
        "broker": "c0e0d49d.594088",
        "x": 2880,
        "y": 2040,
        "wires": []
    },
    {
        "id": "78e27823.d50078",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Absolute command feedback",
        "func": "if (msg.payload[0].Result === true) {\n    msg.payload = {\n        text: \"Okay\",\n        siteId: msg.cmd.siteId\n    };\n} else if (msg.current[0].Result !== false || msg.target[0].Result !== false) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Der Server hat nicht korrekt reagiert\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Le serveur n'a pas répondu correctement\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"The server did not answer correctly\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n} else {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Der Server antwortet nicht\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Le serveur ne répond pas\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"The server did not respond\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2361.000030517578,
        "y": 1934.0000886917114,
        "wires": [
            [
                "d127177c.99a708"
            ]
        ]
    },
    {
        "id": "4fa41a34.d3e974",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1891.0000305175781,
        "y": 1894.0000886917114,
        "wires": [
            [
                "8e922b4c.d2c178"
            ]
        ]
    },
    {
        "id": "8e922b4c.d2c178",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "error",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2061.000030517578,
        "y": 1894.0000886917114,
        "wires": [
            [
                "711f0d59.da70c4"
            ]
        ]
    },
    {
        "id": "711f0d59.da70c4",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "8",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 2761.000030517578,
        "y": 1894.0000886917114,
        "wires": [
            [
                "2534b2a6.b8d3ce"
            ]
        ]
    },
    {
        "id": "dbea080a.27c228",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "======================================================================SPOKEN FEEDBACK==========================================================================",
        "info": "",
        "x": 2389.9998168945312,
        "y": 1843.9998817443848,
        "wires": []
    },
    {
        "id": "aeff6d7b.9a0df",
        "type": "link in",
        "z": "eaca0ac7.88c298",
        "name": "ERROR OUT",
        "links": [
            "a568cecd.16763",
            "1e302784.344688",
            "107efe87.051941",
            "34ef1b78.ad6c74",
            "de9d2514.ef8d38",
            "ce53f6dc.03d708",
            "f676ee98.2e9e3",
            "4e5bb705.ff10d8",
            "3fadc4ce.b39a3c",
            "40c62a0f.a10a74",
            "9cf44e2e.82f2a",
            "d0824d3b.62ce",
            "c1b01312.c2995",
            "7b0693f2.1dd4bc",
            "233c19e.cdf7ee6",
            "97964b61.a46138",
            "70eb9258.650d8c",
            "f56f4b09.b89648",
            "f58a3e81.c8a76",
            "ab2083.f8a76f8",
            "204353c.a04fcac",
            "bc210db9.fe0b5",
            "d99aa975.34edb8",
            "69001fbb.9529b",
            "3693fdda.5fee72",
            "c10a1b8a.f25cf8",
            "99c6772f.c603d8",
            "ad4135.841dfec8",
            "4aa110f9.a482d",
            "27aedf0a.2d754",
            "2b525da6.a5ead2",
            "5c87043d.8d4bec",
            "a673cbd6.ea8e98",
            "f4249068.8daf8",
            "90d47db3.aca5f",
            "7d780d15.2d88f4",
            "11da80e0.36178f",
            "3f0f076c.ee86b8"
        ],
        "x": 1796.0000305175781,
        "y": 1894.0000886917114,
        "wires": [
            [
                "4fa41a34.d3e974"
            ]
        ]
    },
    {
        "id": "ecfff23f.2ca8a",
        "type": "file in",
        "z": "eaca0ac7.88c298",
        "name": "Get current langage",
        "filename": "/usr/share/snips/assistant/custom_asr/config.json",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 760,
        "y": 960,
        "wires": [
            [
                "be36c4cb.f84a58"
            ]
        ]
    },
    {
        "id": "be36c4cb.f84a58",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 930,
        "y": 960,
        "wires": [
            [
                "264c357e.8c156a"
            ]
        ]
    },
    {
        "id": "9fbe3d70.93c5e",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 580,
        "y": 960,
        "wires": [
            [
                "ecfff23f.2ca8a"
            ]
        ]
    },
    {
        "id": "264c357e.8c156a",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Store_language",
        "func": "flow.set(\"msgLang\", msg.payload.language); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1080,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "7cb916.e05336ec",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Store supported commands",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\ntest_lights = [\"on\",\"off\",\"an\",\"aus\",\"allume\",\"éteins\"];\ntest_dimmers = [\"on\",\"off\",\"set\",\"increase\",\"decrease\",\"lower\",\"dim\",\"brighten\",\"more\",\"less\",\"stelle\",\"dimme\",\"aus\",\"an\",\"erhohe\",\"verringere\",\"allume\",\"éteins\",\"augmente\",\"baisse\",\"règle\"];\ntest_heating = [\"set\",\"increase\",\"decrease\",\"warmer\",\"cooler\",\"dim\",\"less\",\"more\",\"stelle\",\"erhohe\",\"verringere\",\"règle\",\"augmente\",\"baisse\",\"plus chaud\",\"moins chaud\",\"trop chaud\",\"trop froid\",\"zu warm\",\"zu kalt\",\"too cold\",\"too warm\"];\ntest_blinds = [\"open\",\"close\",\"set\",\"increase\",\"decrease\",\"higher\",\"lower\",\"oeffne\",\"schliesse\",\"stelle\",\"erhohe\",\"verringere\",\"ouvre\",\"règle\",\"ferme\",\"ouvre moins\",\"ouvre plus\",\"ouvre davantage\",\"baisse\",\"monte\",\"ferme davantage\"];\ntest_scenes = [\"on\",\"activate\",\"aktiviere\",\"an\",\"allume\",\"active\"];\ntest_aux = [\"on\",\"activate\",\"deactivate\",\"off\",\"set\",\"increase\",\"decrease\",\"more\",\"less\",\"aktiviere\",\"deaktiviere\",\"erhohe\",\"verringere\",\"aus\",\"an\",\"active\",\"désactive\",\"allume\",\"éteins\",\"ouvre\",\"ferme\",\"augmente\",\"baisse\",\"monte\"];\n\nmsg.commandCat = [\n    {\n        on: {\n            \"on\":\"\",\n            \"activate\":\"\",\n            \"open\":\"\",\n            \"oeffne\":\"\",\n            \"an\":\"\",\n            \"aktiviere\":\"\",\n            \"allume\":\"\",\n            \"ouvre\":\"\",\n            \"active\":\"\"\n        },\n        off: {\n            \"off\":\"\",\n            \"deactivate\":\"\",\n            \"close\":\"\",\n            \"deaktiviere\":\"\",\n            \"aus\":\"\",\n            \"schliesse\":\"\",\n            \"éteins\":\"\",\n            \"eteins\":\"\",\n            \"ferme\":\"\",\n            \"désactive\":\"\",\n            \"desactive\":\"\"\n        },\n        set: {\n            \"set\":\"\",\n            \"stelle\":\"\",\n            \"règle\":\"\",\n            \"regle\":\"\"\n        },\n        increase: {\n            \"increase\":\"\",\n            \"higher\":\"\",\n            \"warmer\":\"\",\n            \"brighten\":\"\",\n            \"more\":\"\",\n            \"erhohe\":\"\",\n            \"plus chaud\":\"\",\n            \"ouvre plus\":\"\",\n            \"ouvre davantage\":\"\",\n            \"trop froid\":\"\",\n            \"augmente\":\"\",\n            \"monte\":\"\",\n            \"too cold\":\"\",\n            \"zu kalt\":\"\",\n        },\n        decrease: {\n            \"decrease\":\"\",\n            \"lower\":\"\",\n            \"colder\":\"\",\n            \"darker\":\"\",\n            \"dim\":\"\",\n            \"less\":\"\",\n            \"cooler\":\"\",\n            \"abnehme\":\"\",\n            \"dimme\":\"\",\n            \"verringere\":\"\",\n            \"baisse\":\"\",\n            \"ouvre moins\":\"\",\n            \"trop chaud\":\"\",\n            \"moins chaud\":\"\",\n            \"too warm\":\"\",\n            \"zu warm\":\"\",\n            \"ferme davantage\":\"\"\n        }\n    }\n];\n\nflow.set(\"msg_test_lights\", test_lights); // save for later use\nflow.set(\"msg_test_dimmers\", test_dimmers); // save for later use\nflow.set(\"msg_test_heating\", test_heating); // save for later use\nflow.set(\"msg_test_blinds\", test_blinds); // save for later use\nflow.set(\"msg_test_scenes\", test_scenes); // save for later use\nflow.set(\"msg_test_aux\", test_aux); // save for later use\nflow.set(\"msgCommandCat\", msg.commandCat); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "915f7460.0d39a8",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "===========================GET SUPPORTED COMMANDS===============================",
        "info": "",
        "x": 510,
        "y": 1040,
        "wires": []
    },
    {
        "id": "e745dada.cb7748",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 700,
        "y": 1100,
        "wires": [
            [
                "7cb916.e05336ec"
            ]
        ]
    },
    {
        "id": "f0eb7eb6.90bdf",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "=======================================================================EXECUTE COMMAND========================================================================",
        "info": "",
        "x": 2411.000030517578,
        "y": 1114.0000886917114,
        "wires": []
    },
    {
        "id": "62466314.d3ef3c",
        "type": "link in",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION OUT",
        "links": [
            "508fe008.41f8b",
            "c3dc35f5.c94108",
            "4d0770e0.41328",
            "675be6d1.72ec88",
            "a2f8aac9.bd6fc8",
            "fd7fc068.412a9",
            "d6766e42.838c6",
            "6a427699.8d79d8",
            "2a73e744.3344e8",
            "24c6e88a.c33a08",
            "3f0a8b83.1fa2e4",
            "96c61aed.b33ce8",
            "7ab64b18.83e804",
            "663cc209.8d0b9c",
            "c025a9b3.6415f8",
            "bf412a2c.6856b8",
            "8d37fe4.b5811",
            "270bc488.6ab09c",
            "20477952.5810b6",
            "14796e56.0d7942",
            "9597294b.e208c8",
            "71f5196a.3363c8",
            "e1699e4c.6183b"
        ],
        "x": 1796.0000305175781,
        "y": 1274.0000886917114,
        "wires": [
            [
                "a6334bfe.e290a8",
                "2577957b.27d15a"
            ]
        ]
    },
    {
        "id": "ca563501.100cd8",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Prepare request",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.url = [];\n\nif (msg.cmd.type === \"heating\") {\n   \tfor (var i = 0; i < msg.items.length; i++) {\n   \t\tvar val = msg.cmd.value;\n   \t\tif (val < 18){\n\t            val = 18;\n        \t} else if (val > 28) {\n        \t    val = 28;\n\t        } else {\n    \t        val = val;\n\t        }\n   \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, val];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n   \t\t\n\t}\n} else if (msg.cmd.type === \"lights\") {\n    if (msg.cmd.value !== undefined) {\n       \tfor (var i = 0; i < msg.items.length; i++) {\n       \t\tif (msg.items[i].type === \"dimmers\" && msg.cmd.cmd !== \"off\") {\n       \t\t\tvar val = msg.cmd.value*2.55;\n       \t\t\tval = precisionRound(val, 1);\n       \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n       \t\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n       \t\t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n       \t\t} \n       \t\telse if (msg.cmd.value > 0) {\n    \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n       \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n       \t\t}\n       \t\telse {\n    \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n       \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n       \t\t}\n    \t}\n    }\n    else if (msg.cmd.cmd === \"on\") {\n    \tfor (var i = 0; i < msg.items.length; i++) {\n    \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n       \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t}\n    }\n    else if (msg.cmd.cmd === \"off\") {\n    \tfor (var i = 0; i < msg.items.length; i++) {\n    \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n       \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t}\n    }\n} else if (msg.cmd.type === \"blinds\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \tif (msg.cmd.cmd === \"on\" && msg.cmd.value === undefined) {\n        \tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n    \t    msg.url[i] = \"\".concat(...msg.url[i]);\n    \t}\n    \telse if (msg.cmd.cmd === \"off\" && msg.cmd.value === undefined) {\n        \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n    \t    msg.url[i] = \"\".concat(...msg.url[i]);\n        }\n        else if (msg.cmd.value !== undefined) {\n            if (msg.cmd.cmd === \"on\" || msg.cmd.cmd === \"set\") {\n           \t\tvar val = (100-msg.cmd.value)*2.55;\n           \t\tval = precisionRound(val, 1);\n           \t\tif (val > 255) {val=255;} else if (val < 0) {val=0;}\n           \t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n           \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n           \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n            } else if (msg.cmd.cmd === \"off\") {\n                msg.test=\"j'en ai marre ptn\";\n                var val = (msg.cmd.value)*2.55;\n           \t\tval = precisionRound(val, 1);\n           \t\tif (val > 255) {val=255;} else if (val < 0) {val=0;}\n           \t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n           \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n           \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n            }\n        }\n    }\n} else if (msg.cmd.type === \"aux\" || msg.cmd.type === \"scenes\") {\n    if (msg.cmd.cmd === \"on\" || msg.cmd.cmd === \"set\") {\n        if (msg.cmd.value !== undefined) {\n           \tfor (var i = 0; i < msg.items.length; i++) {\n           \t\tif (msg.items[i].setDimUrl !== undefined) {\n           \t\t\tvar val = msg.cmd.value*2.55;\n           \t\t\tval = precisionRound(val, 1);\n           \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n           \t\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n           \t\t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n           \t\t} \n           \t\telse if (msg.cmd.value > 0) {\n        \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n           \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n           \t\t}\n           \t\telse {\n        \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n           \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n           \t\t}\n        \t}\n        }\n        else {\n    \t    for (var i = 0; i < msg.items.length; i++) {\n    \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n       \t    \tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n        }\n    }\n    else if (msg.cmd.cmd === \"off\") {\n    \tfor (var i = 0; i < msg.items.length; i++) {\n    \t\tif (msg.items[i].setOffUrl !== undefined) {\n        \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n           \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n        \t}\n    \t}\n    }\n}\n\nreturn msg; ",
        "outputs": 1,
        "noerr": 0,
        "x": 1941.0000305175781,
        "y": 1174.0000886917114,
        "wires": [
            [
                "af853ad4.338cf8",
                "cca062f2.14118"
            ]
        ]
    },
    {
        "id": "af853ad4.338cf8",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2091.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "d1fd1720.eb1a78"
            ],
            [
                "d0824d3b.62ce"
            ]
        ]
    },
    {
        "id": "d0824d3b.62ce",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2176.000030517578,
        "y": 1194.0000886917114,
        "wires": []
    },
    {
        "id": "15b5d3ef.c69bcc",
        "type": "split",
        "z": "eaca0ac7.88c298",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2431.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "9c0fa67.1a98a58"
            ]
        ]
    },
    {
        "id": "d1fd1720.eb1a78",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2281.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "15b5d3ef.c69bcc"
            ]
        ]
    },
    {
        "id": "9c0fa67.1a98a58",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "50ms",
        "pauseType": "delay",
        "timeout": "20",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2551.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "54e6d355.a993bc"
            ]
        ]
    },
    {
        "id": "a6334bfe.e290a8",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Cmd ?",
        "property": "cmd.cmd",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "set",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "increase",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "decrease",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 5,
        "x": 1891.0000305175781,
        "y": 1274.0000886917114,
        "wires": [
            [
                "ca563501.100cd8"
            ],
            [
                "ca563501.100cd8"
            ],
            [
                "ca563501.100cd8"
            ],
            [
                "c99a5370.2b4e9"
            ],
            [
                "c99a5370.2b4e9"
            ]
        ]
    },
    {
        "id": "7331ea73.eeb8a4",
        "type": "link in",
        "z": "eaca0ac7.88c298",
        "name": "FEEDBACK OUT",
        "links": [
            "4dd6b4bb.0ab68c",
            "aed4458.47c95b8",
            "d5e81494.4feb68"
        ],
        "x": 1796.0000305175781,
        "y": 1994.0000886917114,
        "wires": [
            [
                "aa8e2227.dba3c"
            ]
        ]
    },
    {
        "id": "f246e3ae.4bd33",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Type ?",
        "property": "cmd.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "heating",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "heating",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1891.0000305175781,
        "y": 1594.0000886917114,
        "wires": [
            [
                "d8a17066.f47c2"
            ],
            [
                "efead412.a1e888"
            ]
        ]
    },
    {
        "id": "c99a5370.2b4e9",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "GET Current",
        "func": "msg.url = [];\n\nif (msg.items[0].type === \"heating\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \tmsg.url[i] = [msg.proServIP, msg.items[i].getTargetUrl];\n    \tmsg.url[i] = \"\".concat(...msg.url[i]);\n    }\n} else if (msg.cmd.type === \"aux\" || msg.cmd.type === \"scenes\" || msg.cmd.type === \"lights\" || msg.cmd.type === \"dimmers\" || msg.cmd.type === \"blinds\") {\n    var cptok=0;\n    var cpter=0;\n    msg.itemsok=[];\n    msg.itemser=[];\n    for (var i = 0; i < msg.items.length; i++) {\n        if(msg.items[i].getCurrentUrl !== undefined && msg.items[i].setDimUrl !== undefined && msg.items[i].type !== \"lights\") {\n            msg.itemsok[cptok]=msg.items[i];\n            cptok++;\n        } else {\n            msg.itemser[cpter]=msg.items[i];\n            cpter++;\n        }\n    }\n    if (msg.itemsok[0] !== undefined) {\n        msg.items = msg.itemsok;\n        for (var i = 0; i < msg.itemsok.length; i++) {\n        \tmsg.url[i] = [msg.proServIP, msg.itemsok[i].getCurrentUrl];\n        \tmsg.url[i] = \"\".concat(...msg.url[i]);\n        }\n    }\n\n    if (msg.itemser.length > 0 && msg.itemsok.length === 0) {\n        if (msg.itemser.length > 1) {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" und \";\n                text3 = msg.itemser.length-1;\n                text4 = \" andere Geräte verstehen diesen Befehl nicht\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" et \";\n                text3 = msg.itemser.length-1;\n                text4 = \" autres appareils ne supportent pas cette commande\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemser[0].name;\n                text2 = \" and \";\n                text3 = msg.itemser.length-1;\n                text4 = \" other devices do not support this command\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        } else {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" versteht diesen Befehl nicht\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" ne supporte pas cette commande\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemser[0].name;\n                text2 = \" does not support this command\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2071.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "6cb1a7d6.3ca9a8"
            ]
        ]
    },
    {
        "id": "55f2cd01.e64644",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "GET Current",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2811.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "5a0b6aa.b5bb694"
            ]
        ]
    },
    {
        "id": "12dbbd12.e21413",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "50ms",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2671.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "55f2cd01.e64644"
            ]
        ]
    },
    {
        "id": "aaabdc61.d141c",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "move msg.payload",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "current",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2231.000030517578,
        "y": 1314.0000886917114,
        "wires": [
            [
                "8458fffd.2ffb"
            ]
        ]
    },
    {
        "id": "531dd383.47137c",
        "type": "split",
        "z": "eaca0ac7.88c298",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2551.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "12dbbd12.e21413"
            ]
        ]
    },
    {
        "id": "1cdc04b7.b74abb",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2401.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "531dd383.47137c"
            ]
        ]
    },
    {
        "id": "7c6b8390.b9501c",
        "type": "join",
        "z": "eaca0ac7.88c298",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2071.000030517578,
        "y": 1314.0000886917114,
        "wires": [
            [
                "aaabdc61.d141c"
            ]
        ]
    },
    {
        "id": "5a0b6aa.b5bb694",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 2951.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "7c6b8390.b9501c"
            ]
        ]
    },
    {
        "id": "8458fffd.2ffb",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Prepare_request",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.url = [];\nmsg.newVal= [];\n\nif (msg.items[0].type === \"heating\" && msg.cmd.cmd === \"decrease\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tif (msg.cmd.value !== undefined) {\n\t\t    var val = msg.cmd.value;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target-val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t\telse {\n\t\t    var val = 2;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target-val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t}\n} else if (msg.items[0].type === \"heating\" && msg.cmd.cmd === \"increase\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tif (msg.cmd.value !== undefined) {\n\t\t    var val = msg.cmd.value;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target+val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t\telse {\n\t\t    var val = 2;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target+val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t}\n} else if (msg.cmd.type === \"lights\" && msg.cmd.cmd ===\"increase\") {\n    cptok = 0;\n    for (var i = 0; i < msg.items.length; i++) {\n        if (msg.items[i].type === \"dimmers\") {\n    \t    if (msg.cmd.value !== undefined){\n    \t\t    var val = msg.cmd.value*2.55;\n    \t\t    val = precisionRound(val, 1);\n    \t\t    var newVal = msg.current[i].Data[0].Value+val;\n    \t\t    if (newVal > 255) {\n    \t    \t    newVal = 255;\n    \t        }\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[cptok] = \"\".concat(...msg.url[cptok]);\n    \t\t    cptok++;\n    \t    }\n    \t    else {\n    \t        var newVal = msg.current[i].Data[0].Value+51;\n    \t\t    if (newVal > 255) {\n    \t    \t    newVal = 255;\n    \t        }\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[cptok] = \"\".concat(...msg.url[cptok]);\n    \t\t    cptok++;\n    \t    }\n        }\n    }\n} else if (msg.cmd.type === \"lights\" && msg.cmd.cmd ===\"decrease\") {\n    cptok = 0;\n    for (var i = 0; i < msg.items.length; i++) {\n        if (msg.items[i].type === \"dimmers\") {\n       \t\tif (msg.cmd.value !== undefined) {\n       \t\t    var val = msg.cmd.value*2.55;\n       \t\t    val = precisionRound(val, 1);\n       \t\t    var newVal = msg.current[i].Data[0].Value-val;\n       \t\t    if (newVal < 0) {\n       \t\t        newVal = 0;\n       \t\t    }\n       \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n       \t\t    msg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n       \t    \tmsg.url[cptok] = \"\".concat(...msg.url[cptok]);\n       \t    \tcptok++;\n       \t\t} else {\n                var newVal = msg.current[i].Data[0].Value-51;\n       \t\t    if (newVal < 0) {\n       \t\t        newVal = 0;\n       \t\t    }\n       \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n            \tmsg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n        \t\tmsg.url[cptok] = \"\".concat(...msg.url[cptok]);\n        \t\tcptok++;\n       \t\t}\n        }\n    }\n} else if (msg.cmd.type === \"blinds\" && msg.cmd.cmd ===\"decrease\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \t    if (msg.cmd.value !== undefined){\n    \t\t    var val = msg.cmd.value*2.55;\n    \t\t    val = precisionRound(val, 1);\n    \t\t    var newVal = msg.current[i].Data[0].Value+val;\n    \t\t    if (newVal > 255) {newVal=255;} else if (newVal < 0) {newVal=0;}\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n    \t    else {\n    \t        var newVal = msg.current[i].Data[0].Value+51;\n    \t\t    if (newVal > 255) {newVal=255;} else if (newVal < 0) {newVal=0;}\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n    }\n} else if (msg.cmd.type === \"blinds\" && msg.cmd.cmd === \"increase\") {\n        for (var i = 0; i < msg.items.length; i++) {\n    \t    if (msg.cmd.value !== undefined) {\n    \t        var val = msg.cmd.value*2.55;\n    \t    \tval = precisionRound(val, 1);\n    \t    \tvar newVal = msg.current[i].Data[0].Value-val;\n           \t\tif (newVal > 255) {newVal=255;} else if (newVal < 0) {newVal=0;}\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n        \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n    \t    else {\n    \t        var newVal = msg.current[i].Data[0].Value-51;\n    \t    \tif (newVal > 255) {newVal=255;} else if (newVal < 0) {newVal=0;}\n                msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n            \tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n        \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n        \t}\n        }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2431.000030517578,
        "y": 1314.0000886917114,
        "wires": [
            [
                "f871a467.b49608",
                "fb4de923.9a0638"
            ]
        ]
    },
    {
        "id": "38c3507e.11baf",
        "type": "split",
        "z": "eaca0ac7.88c298",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2774.5714263916016,
        "y": 1314.0002460479736,
        "wires": [
            [
                "2aa25513.c97d4a"
            ]
        ]
    },
    {
        "id": "f871a467.b49608",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2621.7143173217773,
        "y": 1314.0001754760742,
        "wires": [
            [
                "38c3507e.11baf"
            ]
        ]
    },
    {
        "id": "2aa25513.c97d4a",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "50ms",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2897.4287757873535,
        "y": 1314.0002279281616,
        "wires": [
            [
                "7bce7526.31d6bc"
            ]
        ]
    },
    {
        "id": "4dd6b4bb.0ab68c",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "FEEDBACK IN",
        "links": [
            "7331ea73.eeb8a4",
            "fb3a84d7.87d6d8",
            "fa8fd201.bc662"
        ],
        "x": 3036.000030517578,
        "y": 1374.0000886917114,
        "wires": []
    },
    {
        "id": "d5e81494.4feb68",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "FEEDBACK IN",
        "links": [
            "7331ea73.eeb8a4",
            "fb3a84d7.87d6d8",
            "fa8fd201.bc662"
        ],
        "x": 3036.000030517578,
        "y": 1174.0000886917114,
        "wires": []
    },
    {
        "id": "6cb1a7d6.3ca9a8",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2211.000030517578,
        "y": 1254.0000886917114,
        "wires": [
            [
                "1cdc04b7.b74abb"
            ],
            [
                "7b0693f2.1dd4bc"
            ]
        ]
    },
    {
        "id": "7b0693f2.1dd4bc",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2296.000030517578,
        "y": 1274.0000886917114,
        "wires": []
    },
    {
        "id": "d8a17066.f47c2",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "GET_Target",
        "func": "//Prepare all HTTP requests for GET Current Temp and put them in msg.url\n\nmsg.url = [];\n\nfor (var i = 0; i < msg.items.length; i++) {\n\tmsg.url[i] = [msg.proServIP, msg.items[i].getTargetUrl];\n\tmsg.url[i] = \"\".concat(...msg.url[i]);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2071.000030517578,
        "y": 1534.0000886917114,
        "wires": [
            [
                "d6141400.4297d8",
                "582af36d.43b0cc"
            ]
        ]
    },
    {
        "id": "bdb708b6.d26b88",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "GET Target",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2691.000030517578,
        "y": 1534.0000886917114,
        "wires": [
            [
                "cb993a63.3cac68"
            ]
        ]
    },
    {
        "id": "fa6597ad.099cb8",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2531.000030517578,
        "y": 1534.0000886917114,
        "wires": [
            [
                "bdb708b6.d26b88"
            ]
        ]
    },
    {
        "id": "f21c85c.f93f078",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "target",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2531.000030517578,
        "y": 1594.0000886917114,
        "wires": [
            [
                "efead412.a1e888"
            ]
        ]
    },
    {
        "id": "e72f2816.872b18",
        "type": "split",
        "z": "eaca0ac7.88c298",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2391.000030517578,
        "y": 1534.0000886917114,
        "wires": [
            [
                "fa6597ad.099cb8"
            ]
        ]
    },
    {
        "id": "d6141400.4297d8",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2241.000030517578,
        "y": 1534.0000886917114,
        "wires": [
            [
                "e72f2816.872b18"
            ]
        ]
    },
    {
        "id": "c9175caf.ba123",
        "type": "join",
        "z": "eaca0ac7.88c298",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2951.000030517578,
        "y": 1534.0000886917114,
        "wires": [
            [
                "f21c85c.f93f078"
            ]
        ]
    },
    {
        "id": "cb993a63.3cac68",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 2829.571388244629,
        "y": 1534.000096321106,
        "wires": [
            [
                "c9175caf.ba123"
            ]
        ]
    },
    {
        "id": "efead412.a1e888",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "GET_Current",
        "func": "msg.url = [];\n\nif (msg.cmd.type === \"heating\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \tmsg.url[i] = [msg.proServIP, msg.items[i].getCurrentUrl];\n    \tmsg.url[i] = \"\".concat(...msg.url[i]);\n    }\n} else if (msg.cmd.type === \"aux\" || msg.cmd.type === \"scenes\" || msg.cmd.type === \"lights\" || msg.cmd.type === \"dimmers\" || msg.cmd.type === \"blinds\") {\n    var cptok=0;\n    var cpter=0;\n    msg.itemsok=[];\n    msg.itemser=[];\n    for (var i = 0; i < msg.items.length; i++) {\n        if(msg.items[i].getCurrentUrl !== undefined) {\n            msg.itemsok[cptok]=msg.items[i];\n            cptok++;\n        } else {\n            msg.itemser[cpter]=msg.items[i];\n            cpter++;\n        }\n    }\n    \n    if (msg.itemsok[0] !== undefined) {\n        for (var i = 0; i < msg.itemsok.length; i++) {\n        \tmsg.url[i] = [msg.proServIP, msg.itemsok[i].getCurrentUrl];\n        \tmsg.url[i] = \"\".concat(...msg.url[i]);\n        }\n    }\n    \n    if (msg.itemser.length > 0 && msg.itemsok.length === 0) {\n        if (msg.itemser.length > 1) {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" und \";\n                text3 = msg.itemser.length-1;\n                text4 = \" \";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" et \";\n                text3 = msg.itemser.length-1;\n                text4 = \" autres appareils ne supportent pas cette commande\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemser[0].name;\n                text2 = \" and \";\n                text3 = msg.itemser.length-1;\n                text4 = \" other devices do not support this command\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        } else {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" \";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" ne supporte pas cette commande\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemser[0].name;\n                text2 = \" does not support this command\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2061.000030517578,
        "y": 1654.0000886917114,
        "wires": [
            [
                "4579df2b.4c8ca",
                "92295a2e.e4c2a8"
            ]
        ]
    },
    {
        "id": "7d92fd81.473dc4",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "GET Current",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2911.000030517578,
        "y": 1654.0000886917114,
        "wires": [
            [
                "57309174.a0c09"
            ]
        ]
    },
    {
        "id": "6f324635.119398",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2728.8573112487793,
        "y": 1654.0001401901245,
        "wires": [
            [
                "7d92fd81.473dc4"
            ]
        ]
    },
    {
        "id": "a8295691.2dfde8",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "current",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2371.000030517578,
        "y": 1734.0000886917114,
        "wires": [
            [
                "aed4458.47c95b8"
            ]
        ]
    },
    {
        "id": "e9be5d5e.68d7f",
        "type": "split",
        "z": "eaca0ac7.88c298",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2571.000030517578,
        "y": 1654.0000886917114,
        "wires": [
            [
                "6f324635.119398"
            ]
        ]
    },
    {
        "id": "9dcfd4ac.a2e308",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2401.000030517578,
        "y": 1654.0000886917114,
        "wires": [
            [
                "e9be5d5e.68d7f"
            ]
        ]
    },
    {
        "id": "26aea8a3.7aa688",
        "type": "join",
        "z": "eaca0ac7.88c298",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2191.000030517578,
        "y": 1734.0000886917114,
        "wires": [
            [
                "a8295691.2dfde8"
            ]
        ]
    },
    {
        "id": "57309174.a0c09",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 2051.000030517578,
        "y": 1734.0000886917114,
        "wires": [
            [
                "26aea8a3.7aa688"
            ]
        ]
    },
    {
        "id": "aed4458.47c95b8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "FEEDBACK IN",
        "links": [
            "7331ea73.eeb8a4",
            "fb3a84d7.87d6d8",
            "fa8fd201.bc662"
        ],
        "x": 2516.000030517578,
        "y": 1734.0000886917114,
        "wires": []
    },
    {
        "id": "4579df2b.4c8ca",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2211.000030517578,
        "y": 1654.0000886917114,
        "wires": [
            [
                "9dcfd4ac.a2e308"
            ],
            [
                "233c19e.cdf7ee6"
            ]
        ]
    },
    {
        "id": "233c19e.cdf7ee6",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2296.000030517578,
        "y": 1674.0000886917114,
        "wires": []
    },
    {
        "id": "a7d3de52.cf769",
        "type": "link in",
        "z": "eaca0ac7.88c298",
        "name": "QUERY EXECUTION OUT",
        "links": [
            "a940c273.c4976",
            "483102fe.64f09c",
            "17c7a2ae.24b62d",
            "b1af9c7d.b1a12"
        ],
        "x": 1796.0000305175781,
        "y": 1594.0000886917114,
        "wires": [
            [
                "f246e3ae.4bd33",
                "f61fe28e.722fc"
            ]
        ]
    },
    {
        "id": "54e6d355.a993bc",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "Send URL",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2691.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "a52096b9.b36a78"
            ]
        ]
    },
    {
        "id": "d8b494d2.7b6488",
        "type": "join",
        "z": "eaca0ac7.88c298",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2951.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "d5e81494.4feb68"
            ]
        ]
    },
    {
        "id": "a52096b9.b36a78",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 2831.000030517578,
        "y": 1174.0000886917114,
        "wires": [
            [
                "d8b494d2.7b6488"
            ]
        ]
    },
    {
        "id": "7bce7526.31d6bc",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "Send URL",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2691.000030517578,
        "y": 1374.0000886917114,
        "wires": [
            [
                "d0909e45.e7b69"
            ]
        ]
    },
    {
        "id": "ac6c3456.f41d48",
        "type": "join",
        "z": "eaca0ac7.88c298",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2951.000030517578,
        "y": 1374.0000886917114,
        "wires": [
            [
                "4dd6b4bb.0ab68c"
            ]
        ]
    },
    {
        "id": "d0909e45.e7b69",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 2831.000030517578,
        "y": 1374.0000886917114,
        "wires": [
            [
                "ac6c3456.f41d48"
            ]
        ]
    },
    {
        "id": "91c2c660.bf80a8",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "========================================================================EXECUTE QUERY==========================================================================",
        "info": "",
        "x": 2411.000030517578,
        "y": 1474.0000886917114,
        "wires": []
    },
    {
        "id": "aa8e2227.dba3c",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Query ?",
        "property": "cmd.query",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1901.0000305175781,
        "y": 1994.0000886917114,
        "wires": [
            [
                "cbf75a1c.c7f158"
            ],
            [
                "e1be3224.fd6bd"
            ]
        ]
    },
    {
        "id": "cbf75a1c.c7f158",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "cmd.cmd",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "set",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "increase",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "decrease",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 5,
        "x": 2151.000030517578,
        "y": 1954.0000886917114,
        "wires": [
            [
                "78e27823.d50078"
            ],
            [
                "78e27823.d50078"
            ],
            [
                "78e27823.d50078"
            ],
            [
                "4a75c7d5.5ba5a8"
            ],
            [
                "4a75c7d5.5ba5a8"
            ]
        ]
    },
    {
        "id": "4a75c7d5.5ba5a8",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Relative command feedback",
        "func": "if (msg.cmd.type === \"aux\" || msg.cmd.type === \"lights\" || msg.cmd.type === \"blinds\") {\n    if (msg.payload[0].Result === true) {\n        msg.payload = {\n            text: \"Okay\",\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n} else if (msg.cmd.type === \"heating\") {\n    msg.text = [];\n    if (msg.cmd.lang === \"fr\") {\n        for (var i = 0; i < msg.payload.length; i++) {\n            if (msg.payload[i].Result === true) {\n                var room = msg.items[i].zone;\n                var target = msg.newVal[i];\n                var text1 = \"Okay, le thermostat est réglé sur \";\n                var text2 = \" degrés dans la zone \";\n                msg.text[i] = [text1, target, text2, room];\n                var endText = \"\".concat(...msg.text[i]);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"de\") {\n        for (var i = 0; i < msg.payload.length; i++) {\n            if (msg.payload[i].Result === true) {\n                var room = msg.items[i].zone;\n                var target = msg.newVal[i];\n                var text1 = \"Okay, die Heizung ist aus \";\n                var text2 = \" Grad in \";\n                var text3 = \" eingestellt\";\n                msg.text[i] = [text1, target, text2, room, text3];\n                var endText = \"\".concat(...msg.text[i]);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else {\n        for (var i = 0; i < msg.payload.length; i++) {\n            if (msg.payload[i].Result === true) {\n                var room = msg.items[i].zone;\n                var target = msg.newVal[i];\n                var text1 = \"Okay, setting the heating to \";\n                var text2 = \" degrees in the \";\n                msg.text[i] = [text1, target, text2, room];\n                var endText = \"\".concat(...msg.text[i]);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2361.000030517578,
        "y": 1974.0000886917114,
        "wires": [
            [
                "2896b5f8.7d12ba"
            ]
        ]
    },
    {
        "id": "475b338d.5dd5cc",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Query feedback",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.payload = [];\nmsg.text = [];\n\nif (msg.cmd.type === \"lights\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.lang === \"fr\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Die Helligkeit von \";\n                    var text3 = \" ist aus \";\n                    var text4 = \" Prozent eingestellt\";\n                    msg.text[i] = [text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"'s luminosity is set to  \";\n                    var text3 = \" percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} else if (msg.cmd.type === \"heating\" && msg.current !== undefined && msg.target !== undefined) {\n    if (msg.cmd.lang === \"fr\"){\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Le thermostat est réglé sur \";\n                var text2 = \" dans la zone \";\n                var text3 = \" pour une température actuelle de \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Die Heizung ist aus \";\n                var text2 = \" grad in \";\n                var text3 = \" eingestellt bei einer aktuellen Temperatur von \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n                var text1 = \"Heating is set to \";\n                var text2 = \" degrees in the \";\n                var text3 = \", with a current temperature of \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n} if (msg.cmd.type === \"aux\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Das Gerät \";\n                    var text3 = \"ist aus \";\n                    var text4 = \"Prozent eingestellt\";\n                    msg.text[i] = [text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is set to  \";\n                    var text3 = \"percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} if (msg.cmd.type === \"blinds\" && msg.current !== undefined){\n    if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist geöffnet\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \"ist geschlossen\"; \n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus \";\n                    var text3 = \" Prozent gestellt\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"fr\") {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est ouvert\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \"est fermé\"; \n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est réglé sur \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is fully open\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is closed\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is \";\n                    var text3 = \" percent open\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang:\"en-EN\"\n                };\n            }\n        }\n    }\n\n\n} else if ((msg.cmd.type === \"heating\" && (msg.current === undefined || msg.target === undefined))|| \n(msg.current === undefined && msg.cmd.type !== \"heating\")) {\n    msg.error = [];\n    if (msg.current[0].Result !== false || msg.target[0].Result !== false) {\n        if (msg.cmd.lang === \"de\") {\n            msg.error = {\n                text: \"Der Server hat nicht korrekt reagiert\",\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            msg.error = {\n                text: \"Le serveur n'a pas répondu correctement\",\n                siteId: msg.cmd.siteId,\n                lang:\"fr-FR\"\n            };\n        } else {\n            msg.error = {\n                text: \"The server did not react correctly\",\n                siteId: msg.cmd.siteId,\n                lang:\"en-EN\"\n            };\n        }\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2280,
        "y": 2020,
        "wires": [
            [
                "c9bf95c3.767638"
            ]
        ]
    },
    {
        "id": "656a3745.48ef08",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:turnOnLights",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 160,
        "wires": [
            [
                "eb60198e.f18468"
            ]
        ]
    },
    {
        "id": "a4f3aa90.707498",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "test ProServIP",
        "func": "msg.cmd=[];\nmsg.cmd.lang = flow.get(\"msgLang\");\n\nif (msg.proServIP === \"\" || msg.proServIP.search(\"ECONNREFUSED\") !== -1 || msg.proServIP === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        text = \"Bitte überprüfen Sie die adresse von ProServ\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        text = \"Veuillez vérifier l'adresse du Proserv\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"fr-FR\"\n        };\n    } else {\n        text = \"Please check the configuration of the ProServ address\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 480,
        "wires": [
            [
                "703c10da.b7596"
            ]
        ]
    },
    {
        "id": "703c10da.b7596",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 970,
        "y": 480,
        "wires": [
            [
                "16a3ac74.0dbb84"
            ],
            [
                "70eb9258.650d8c"
            ]
        ]
    },
    {
        "id": "70eb9258.650d8c",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 1055,
        "y": 500,
        "wires": []
    },
    {
        "id": "d127177c.99a708",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2551.000030517578,
        "y": 1934.0000886917114,
        "wires": [
            [
                "711f0d59.da70c4"
            ],
            [
                "f56f4b09.b89648"
            ]
        ]
    },
    {
        "id": "f56f4b09.b89648",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df"
        ],
        "x": 2636.000030517578,
        "y": 1954.0000886917114,
        "wires": []
    },
    {
        "id": "2896b5f8.7d12ba",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2551.000030517578,
        "y": 1974.0000886917114,
        "wires": [
            [
                "711f0d59.da70c4"
            ],
            [
                "f58a3e81.c8a76"
            ]
        ]
    },
    {
        "id": "f58a3e81.c8a76",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df"
        ],
        "x": 2636.000030517578,
        "y": 1994.0000886917114,
        "wires": []
    },
    {
        "id": "3e7fdadb.d21ff6",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2551.000030517578,
        "y": 2014.0000886917114,
        "wires": [
            [
                "2534b2a6.b8d3ce"
            ],
            [
                "ab2083.f8a76f8"
            ]
        ]
    },
    {
        "id": "ab2083.f8a76f8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df"
        ],
        "x": 2636.000030517578,
        "y": 2034.0000886917114,
        "wires": []
    },
    {
        "id": "eba6ccd8.bcc9c",
        "type": "link in",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG OUT",
        "links": [
            "e443f6e.2335a08",
            "22c6aed9.bb0942",
            "cca062f2.14118",
            "582af36d.43b0cc",
            "fb4de923.9a0638",
            "92295a2e.e4c2a8",
            "2577957b.27d15a",
            "f61fe28e.722fc",
            "7a651595.5860ac",
            "42472400.29b25c",
            "6ea14c45.3e6cf4",
            "4d0770e0.41328",
            "2a73e744.3344e8",
            "24c6e88a.c33a08",
            "3f0a8b83.1fa2e4",
            "96c61aed.b33ce8",
            "17c7a2ae.24b62d",
            "7ab64b18.83e804",
            "663cc209.8d0b9c",
            "c025a9b3.6415f8",
            "bf412a2c.6856b8",
            "8d37fe4.b5811",
            "270bc488.6ab09c",
            "20477952.5810b6",
            "14796e56.0d7942",
            "9597294b.e208c8",
            "e1699e4c.6183b",
            "71f5196a.3363c8",
            "b1af9c7d.b1a12"
        ],
        "x": 675,
        "y": 1640,
        "wires": [
            [
                "6d12a874.393fb8",
                "e54216b9.7363b8",
                "71638156.8e913",
                "db020d09.af5af",
                "39f5fba1.cbf2e4",
                "96a2f3da.18fbf",
                "794011d8.02a11",
                "e892010c.91599",
                "f465d6e2.7eb228",
                "5a328faa.09a1a",
                "97788aef.b21758",
                "ea2225e.77320d8",
                "a47cfb7b.f86e88",
                "7c9afbf3.8fd9d4"
            ]
        ]
    },
    {
        "id": "f465d6e2.7eb228",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.room",
        "x": 840,
        "y": 1560,
        "wires": []
    },
    {
        "id": "5a328faa.09a1a",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.cmd",
        "x": 840,
        "y": 1520,
        "wires": []
    },
    {
        "id": "e892010c.91599",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.device",
        "x": 840,
        "y": 1600,
        "wires": []
    },
    {
        "id": "794011d8.02a11",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.value",
        "x": 840,
        "y": 1640,
        "wires": []
    },
    {
        "id": "96a2f3da.18fbf",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.query",
        "x": 840,
        "y": 1680,
        "wires": []
    },
    {
        "id": "97788aef.b21758",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.lang",
        "x": 840,
        "y": 1480,
        "wires": []
    },
    {
        "id": "e54216b9.7363b8",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "deviceList",
        "x": 839.8571341378347,
        "y": 1440,
        "wires": []
    },
    {
        "id": "39f5fba1.cbf2e4",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "commandList",
        "x": 850,
        "y": 1720,
        "wires": []
    },
    {
        "id": "db020d09.af5af",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.type",
        "x": 840,
        "y": 1760,
        "wires": []
    },
    {
        "id": "71638156.8e913",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "proServIP",
        "x": 840,
        "y": 1800,
        "wires": []
    },
    {
        "id": "6d12a874.393fb8",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.all",
        "x": 830,
        "y": 1400,
        "wires": []
    },
    {
        "id": "ea2225e.77320d8",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 830,
        "y": 1840,
        "wires": []
    },
    {
        "id": "abd63e25.c18b9",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "================================DEBUGGING TOOLS===================================",
        "info": "",
        "x": 510,
        "y": 1340,
        "wires": []
    },
    {
        "id": "e1be3224.fd6bd",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "items[1]",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2090,
        "y": 2020,
        "wires": [
            [
                "475b338d.5dd5cc"
            ],
            [
                "475b338d.5dd5cc"
            ]
        ]
    },
    {
        "id": "c0c8894d.ec8de8",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Query feedback",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction searchStatusDevice() {\n    msg.itemson = [];\n    msg.itemsoff = [];\n    cpton = 0;\n    cptoff = 0;\n    for (var i = 0; i < msg.items.length; i++) {\n        if (msg.current[i].Data[0].Value === true || (msg.current[i].Data[0].Value > 0 && msg.current[i].Data[0].Value <256)) {\n            msg.itemson[cpton] = msg.items[i];\n            cpton++;\n        } else if (msg.current[i].Data[0].Value === false || msg.current[i].Data[0].Value === 0) {\n            msg.itemsoff[cptoff] = msg.items[i];\n            cptoff++;\n        }\n    }\n}\n\nfunction searchStatusBlinds() {\n    msg.itemson = [];\n    msg.itemsoff = [];\n    cpton = 0;\n    cptoff = 0;\n    for (var i = 0; i < msg.items.length; i++) {\n        if (msg.current[i].Data[0].Value === false || msg.current[i].Data[0].Value === 255) {\n            msg.itemson[cpton] = msg.items[i];\n            cpton++;\n        } else if (msg.current[i].Data[0].Value === true || (msg.current[i].Data[0].Value >= 0 && msg.current[i].Data[0].Value <255)) {\n            msg.itemsoff[cptoff] = msg.items[i];\n            cptoff++;\n        }\n    }\n}\n\nmsg.payload = [];\nmsg.text = [];\n\nif (msg.cmd.type === \"lights\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        searchStatusDevice();\n        if (msg.itemson.length === 0) {\n            if (msg.cmd.lang === \"fr\"){\n                var text1 = \"Toutes les lumières sont éteintes\";\n                texttabl = [text1];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n            else if (msg.cmd.lang === \"de\"){\n                var text1 = \" alles ist aus\";\n                texttabl = [text1];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else {\n                var text1 = \" all lights are off\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n        else if (msg.itemson.length === 1) {\n            if (msg.cmd.lang === \"fr\"){\n                var text1 = msg.itemson[0].name;\n                var text2 = \" est allumé\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n            else if (msg.cmd.lang === \"de\"){\n                var text1 = msg.itemson[0].name;\n                var text2 = \" ist an\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else {\n                var text1 = msg.itemson[0].name;\n                var text2 = \" is on\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        } if (msg.itemson.length > 1 && msg.itemsoff.length !== 0) {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemson[0].name;\n                text2 = \" und \";\n                text3 = msg.itemson.length-1;\n                text4 = \" andere Licht sind an\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.payload = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemson[0].name;\n                text2 = \" et \";\n                text3 = msg.itemson.length-1;\n                text4 = \" autres lumières sont allumées\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.payload = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemson[0].name;\n                text2 = \" and \";\n                text3 = msg.itemson.length-1;\n                text4 = \" other lights are on\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.payload = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n        if (msg.itemsoff.length === 0) {\n            if (msg.cmd.lang === \"fr\"){\n                var text1 = \"Toutes les lumières sont allumées\";\n                texttabl = [text1];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n            else if (msg.cmd.lang === \"de\"){\n                var text1 = \" alles ist an\";\n                texttabl = [text1];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else {\n                var text1 = \" all lights are on\";\n                texttabl = [text1];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n        else if (msg.itemsoff.length === 1) {\n            if (msg.cmd.lang === \"fr\"){\n                var text1 = msg.itemsoff[0].name;\n                var text2 = \" est éteints\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n            else if (msg.cmd.lang === \"de\"){\n                var text1 = msg.itemsoff[0].name;\n                var text2 = \" ist aus\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else {\n                var text1 = msg.itemsoff[0].name;\n                var text2 = \" is off\";\n                texttabl = [text1, text2];\n                var endText = \"\".concat(...texttabl);\n                msg.payload =[];\n                msg.payload.push({\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                });\n            }\n        } if (msg.itemsoff.length > 1) {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemsoff[0].name;\n                text2 = \" und \";\n                text3 = msg.itemsoff.length-1;\n                text4 = \" andere Licht sind auf\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.payload = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemsoff[0].name;\n                text2 = \" et \";\n                text3 = msg.itemsoff.length-1;\n                text4 = \" autres lumières sont éteintes\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.payload = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemsoff[0].name;\n                text2 = \" and \";\n                text3 = msg.itemsoff.length-1;\n                text4 = \" other lights are off\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.payload = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n}\n/*\nif (msg.cmd.type === \"blinds\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if ((msg.cmd.cmd === \"on\" && msg.cmd.room !== undefined) || (msg.cmd.cmd === \"on\" && msg.cmd.all === \"everywhere\") || (msg.cmd.cmd === \"off\" && (msg.cmd.all !== undefined || msg.cmd.room !== undefined))) {\n            searchOnBlinds();\n            if (msg.itemsok.length === 0) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = \" tous les volets sont fermés\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = \" alles ist geschlossen\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = \" all shutters are off\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n            else if (msg.itemsok.length === 1) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" est ouvert\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" ist geöffnet\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" is open\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            } if (msg.itemsok.length > 1) {\n                if (msg.cmd.lang === \"de\") {\n                    if (msg.true === true) { var text5 = \"Ja, \";} else if (msg.true === false) { var text5 = \"Nein, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" und \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" andere Fensterladen sind geoeffnet\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else if (msg.cmd.lang === \"fr\") {\n                    if (msg.true === true) { var text5 = \"Oui, \";} else if (msg.true === false) { var text5 = \"Non, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" et \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" autres volets sont ouverts\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                } else {\n                    if (msg.true === true) { var text5 = \"Yes, \";} else if (msg.true === false) { var text5 = \"No, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" and \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" other blinds are open\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n        } else if (msg.cmd.cmd === \"on\" && msg.cmd.all === \"all\") {\n            searchStatusBlinds();\n            if (msg.itemsok.length === 0) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = \" tous les volets sont ouverts\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = \" alles ist geöffnet\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = \" all blinds are open\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n            else if (msg.itemsok.length === 1) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" est fermé\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" ist geschlossen\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" is closed\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            } if (msg.itemsok.length > 1) {\n                if (msg.cmd.lang === \"de\") {\n                    if (msg.true === true) { var text5 = \"Ja, \";} else if (msg.true === false) { var text5 = \"Nein, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" und \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" andere Fensterladen sind geschlossen\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else if (msg.cmd.lang === \"fr\") {\n                    if (msg.true === true) { var text5 = \"Oui, \";} else if (msg.true === false) { var text5 = \"Non, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" et \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" autres volets sont fermés\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                } else {\n                    if (msg.true === true) { var text5 = \"Yes, \";} else if (msg.true === false) { var text5 = \"No, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" and \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" other blinds are closed\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n        }\n    }\n}\n\nif (msg.cmd.type === \"aux\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if ((msg.cmd.cmd === \"on\" && msg.cmd.room !== undefined) || (msg.cmd.cmd === \"on\" && msg.cmd.all === \"everywhere\") || (msg.cmd.cmd === \"off\" && (msg.cmd.all !== undefined || msg.cmd.room !== undefined))) {\n            searchStatusDevice();\n            if (msg.itemsok.length === 0) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = \" tous les appareils sont éteints\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = \" alles ist aus\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = \" all devices are off\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n            else if (msg.itemsok.length === 1) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" est allumé\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" ist an\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" is on\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            } if (msg.itemsok.length > 1) {\n                if (msg.cmd.lang === \"de\") {\n                    if (msg.true === true) { var text5 = \"Ja, \";} else if (msg.true === false) { var text5 = \"Nein, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" und \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" andere Geräte sind an\";\n                    texttabl = [text5,text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else if (msg.cmd.lang === \"fr\") {\n                    if (msg.true === true) { var text5 = \"Oui, \";} else if (msg.true === false) { var text5 = \"Non, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" et \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" autres appareils sont allumés\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                } else {\n                    if (msg.true === true) { var text5 = \"Yes, \";} else if (msg.true === false) { var text5 = \"No, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" and \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" other devices are on\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n        } else if (msg.cmd.cmd === \"on\" && msg.cmd.all === \"all\") {\n            searchStatusDevice();\n            if (msg.itemsok.length === 0) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = \" tous les appareils sont allumés\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = \" alles ist an\";\n                    texttabl = [text4, text1];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = \" all devices are on\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n            else if (msg.itemsok.length === 1) {\n                if (msg.cmd.lang === \"fr\"){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" est éteints\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                }\n                else if (msg.cmd.lang === \"de\"){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" ist aus\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else {\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.itemsok[0].name;\n                    var text2 = \" is off\";\n                    texttabl = [text4, text1, text2];\n                    var endText = \"\".concat(...texttabl);\n                    msg.payload = {\n                        text: endText,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            } if (msg.itemsok.length > 1) {\n                if (msg.cmd.lang === \"de\") {\n                    if (msg.true === true) { var text5 = \"Ja, \";} else if (msg.true === false) { var text5 = \"Nein, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" und \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" andere Geräte sind auf\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"de-DE\"\n                    };\n                } else if (msg.cmd.lang === \"fr\") {\n                    if (msg.true === true) { var text5 = \"Oui, \";} else if (msg.true === false) { var text5 = \"Non, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" et \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" autres appareils sont éteints\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"fr-FR\"\n                    };\n                } else {\n                    if (msg.true === true) { var text5 = \"Yes, \";} else if (msg.true === false) { var text5 = \"No, \";} else {var text5 = \"\";}\n                    text1 = msg.itemsok[0].name;\n                    text2 = \" and \";\n                    text3 = msg.itemsok.length-1;\n                    text4 = \" other devices are off\";\n                    texttabl = [text5, text1, text2, text3, text4];\n                    var text = \"\".concat(...texttabl);            \n                    msg.payload = {\n                        text: text,\n                        siteId: msg.cmd.siteId,\n                        lang: \"en-EN\"\n                    };\n                }\n            }\n        }\n    }\n}*/\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2280,
        "y": 2060,
        "wires": [
            [
                "c9bf95c3.767638"
            ]
        ]
    },
    {
        "id": "478e1b8.8594ae4",
        "type": "trigger",
        "z": "eaca0ac7.88c298",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "pay",
        "duration": "1",
        "extend": false,
        "units": "min",
        "reset": "",
        "name": "",
        "x": 330,
        "y": 360,
        "wires": [
            [
                "c29f36fe.b3da58"
            ]
        ]
    },
    {
        "id": "e47126c6.967d48",
        "type": "trigger",
        "z": "eaca0ac7.88c298",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "pay",
        "duration": "2",
        "extend": false,
        "units": "min",
        "reset": "",
        "name": "",
        "x": 330,
        "y": 380,
        "wires": [
            [
                "c29f36fe.b3da58"
            ]
        ]
    },
    {
        "id": "466f8cc6.190634",
        "type": "trigger",
        "z": "eaca0ac7.88c298",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "pay",
        "duration": "3",
        "extend": false,
        "units": "min",
        "reset": "",
        "name": "",
        "x": 330,
        "y": 400,
        "wires": [
            [
                "c29f36fe.b3da58"
            ]
        ]
    },
    {
        "id": "fb12a6d4.114a88",
        "type": "trigger",
        "z": "eaca0ac7.88c298",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "pay",
        "duration": "4",
        "extend": false,
        "units": "min",
        "reset": "",
        "name": "",
        "x": 330,
        "y": 420,
        "wires": [
            [
                "c29f36fe.b3da58"
            ]
        ]
    },
    {
        "id": "68a63664.b02aa8",
        "type": "trigger",
        "z": "eaca0ac7.88c298",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "pay",
        "duration": "5",
        "extend": false,
        "units": "min",
        "reset": "",
        "name": "",
        "x": 330,
        "y": 440,
        "wires": [
            [
                "c29f36fe.b3da58"
            ]
        ]
    },
    {
        "id": "717d4ec.d49d0b",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Starting up feedback",
        "func": "msg.cmd=[];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.serverSiteId = flow.get(\"msgServerSiteId\");\n\nif (msg.cmd.siteId === undefined) {\n    msg.cmd.siteId = msg.serverSiteId;\n}\n\nif (msg.cmd.lang === \"de\") {\n    text = \"Startet, bitte warten\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"de-DE\"\n    };\n} else if (msg.cmd.lang === \"fr\") {\n    text = \"Démarrage, veuillez patienter\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"fr-FR\"\n    };\n} else {\n    text = \"Starting up, please wait\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"en-EN\"\n    };\n}\n\ncptok = 0;\ncpter = 0;\nflow.set(\"cptok\", cptok); // save for later use\nflow.set(\"cpter\", cpter); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 300,
        "wires": [
            [
                "bc210db9.fe0b5"
            ]
        ]
    },
    {
        "id": "bc210db9.fe0b5",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 845,
        "y": 300,
        "wires": []
    },
    {
        "id": "6ace3b8c.4fcb14",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 480,
        "y": 300,
        "wires": [
            [
                "717d4ec.d49d0b"
            ]
        ]
    },
    {
        "id": "183cf52a.29efbb",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Process connection status",
        "func": "msg.cmd=[];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.proServIP = flow.get(\"msgProServIP\");\ncptok = flow.get(\"cptok\");\ncpter = flow.get(\"cpter\");\nmsg.serverSiteId = flow.get(\"msgServerSiteId\");\n\n/*if (msg.cmd.siteId === undefined) {\n    msg.cmd.siteId = msg.serverSiteId;\n}*/\n\nif (msg.deviceList !== undefined && msg.proServIP !== undefined && cptok === 0 && msg.statusCode === 200) {\n    cpter = 0;\n    if (msg.cmd.lang === \"de\") {\n        text = \"real KNX Air ist betriebsbereit\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        text = \"real KNX Air est à présent prêt à l'emploi\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"fr-FR\"\n        };\n    } else {\n        text = \"real KNX Air is now ready to use\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n    cptok++;\n    flow.set(\"cptok\", cptok); // save for later use\n    flow.set(\"cpter\", cpter); // save for later use\n} else if (msg.deviceList === undefined || msg.proServIP === undefined || msg.statusCode !== 200) {\n    cptok = 0;\n    cpter++;\n    if (cpter > 3) {\n        cpter = -1;\n        if (msg.cmd.lang === \"de\") {\n            text = \"Snips hat Probleme, sich mit dem KNX-Netzwerk zu verbinden\";\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            text = \"Real KNX Air rencontre des problèmes pour se connecter au réseau KNX\";\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"fr-FR\"\n            };\n        } else {\n            text = \"Real KNX Air is having problem to connect to the KNX network\";\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"en-EN\"\n            };\n        }\n    }\n    flow.set(\"cptok\", cptok); // save for later use\n    flow.set(\"cpter\", cpter); // save for later use\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1170,
        "y": 820,
        "wires": [
            [
                "d99aa975.34edb8"
            ]
        ]
    },
    {
        "id": "72629f8c.e561d",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "=============================GET CONNECTION STATUS================================",
        "info": "",
        "x": 510,
        "y": 760,
        "wires": []
    },
    {
        "id": "488125dd.25cb3c",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "60",
        "crontab": "",
        "once": true,
        "x": 490,
        "y": 820,
        "wires": [
            [
                "d97a2ffd.66dde"
            ]
        ]
    },
    {
        "id": "d97a2ffd.66dde",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "delay",
        "timeout": "10",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 640,
        "y": 820,
        "wires": [
            [
                "4012e63d.fa2118"
            ]
        ]
    },
    {
        "id": "d99aa975.34edb8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 1315,
        "y": 820,
        "wires": []
    },
    {
        "id": "a97f6276.a0726",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Store server siteId",
        "func": "tmp = msg.payload.split(\"\\\"\");\ntmp1 = tmp[1].split(\"@\");\nmsg.serverSiteId = tmp1[0];\n\nflow.set(\"msgServerSiteId\", msg.serverSiteId); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 1240,
        "wires": [
            []
        ]
    },
    {
        "id": "fcf47721.326ae8",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "================================GET SERVER SITE ID==================================",
        "info": "",
        "x": 510,
        "y": 1180,
        "wires": []
    },
    {
        "id": "eed494d9.af90c8",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 600,
        "y": 1240,
        "wires": [
            [
                "e58e844.e1af278"
            ]
        ]
    },
    {
        "id": "e58e844.e1af278",
        "type": "exec",
        "z": "eaca0ac7.88c298",
        "command": "grep \"bind*\" /etc/snips.toml",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": true,
        "name": "GET server siteId",
        "x": 790,
        "y": 1240,
        "wires": [
            [
                "a97f6276.a0726"
            ],
            [],
            []
        ]
    },
    {
        "id": "af7e2f25.b62c4",
        "type": "http request",
        "z": "eaca0ac7.88c298",
        "name": "GET devices",
        "method": "GET",
        "ret": "txt",
        "url": "http://{{{proServIP}}}",
        "tls": "",
        "x": 970,
        "y": 820,
        "wires": [
            [
                "183cf52a.29efbb"
            ]
        ]
    },
    {
        "id": "4012e63d.fa2118",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "GET proServIP",
        "func": "msg.proServIP = flow.get(\"msgProServIP\");\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 820,
        "wires": [
            [
                "af7e2f25.b62c4"
            ]
        ]
    },
    {
        "id": "a47cfb7b.f86e88",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "items",
        "x": 830,
        "y": 1880,
        "wires": []
    },
    {
        "id": "cca062f2.14118",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG IN",
        "links": [
            "eba6ccd8.bcc9c"
        ],
        "x": 2076.000030517578,
        "y": 1214.0000886917114,
        "wires": []
    },
    {
        "id": "582af36d.43b0cc",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG IN",
        "links": [
            "eba6ccd8.bcc9c"
        ],
        "x": 2196.000030517578,
        "y": 1574.0000886917114,
        "wires": []
    },
    {
        "id": "fb4de923.9a0638",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG IN",
        "links": [
            "eba6ccd8.bcc9c"
        ],
        "x": 2576.000030517578,
        "y": 1354.0000886917114,
        "wires": []
    },
    {
        "id": "92295a2e.e4c2a8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG IN",
        "links": [
            "eba6ccd8.bcc9c"
        ],
        "x": 2176.000030517578,
        "y": 1694.0000886917114,
        "wires": []
    },
    {
        "id": "7c9afbf3.8fd9d4",
        "type": "debug",
        "z": "eaca0ac7.88c298",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "url",
        "x": 820,
        "y": 1920,
        "wires": []
    },
    {
        "id": "2577957b.27d15a",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG IN",
        "links": [
            "eba6ccd8.bcc9c"
        ],
        "x": 1896.0000305175781,
        "y": 1334.0000886917114,
        "wires": []
    },
    {
        "id": "f61fe28e.722fc",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "DEBUG IN",
        "links": [
            "eba6ccd8.bcc9c"
        ],
        "x": 1876.0000305175781,
        "y": 1634.0000886917114,
        "wires": []
    },
    {
        "id": "c29f36fe.b3da58",
        "type": "exec",
        "z": "eaca0ac7.88c298",
        "command": "sudo ip addr show eth0 | grep \"inet\\b\" | awk '{print $2}' | cut -d/ -f1",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": true,
        "name": "GET local IP (eth)",
        "x": 530,
        "y": 400,
        "wires": [
            [
                "e4d46a52.a0a3e8"
            ],
            [],
            []
        ]
    },
    {
        "id": "e4d46a52.a0a3e8",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "outputs": 2,
        "x": 690,
        "y": 400,
        "wires": [
            [
                "eb2a555e.67c428"
            ],
            [
                "49de0273.59987c"
            ]
        ]
    },
    {
        "id": "eb2a555e.67c428",
        "type": "exec",
        "z": "eaca0ac7.88c298",
        "command": "sudo ip addr show wlan0 | grep \"inet\\b\" | awk '{print $2}' | cut -d/ -f1",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": true,
        "name": "GET local IP (wlan)",
        "x": 850,
        "y": 400,
        "wires": [
            [
                "49de0273.59987c"
            ],
            [],
            []
        ]
    },
    {
        "id": "49de0273.59987c",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Trim answer",
        "func": "msg.payload = msg.payload.trim();\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1030,
        "y": 400,
        "wires": [
            [
                "b30a8798.12dee8"
            ]
        ]
    },
    {
        "id": "1b1a6184.98b5ae",
        "type": "file in",
        "z": "eaca0ac7.88c298",
        "name": "Get existing names",
        "filename": "/usr/share/snips/assistant/nlu_engine/nlu_engine.json",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 470,
        "y": 620,
        "wires": [
            [
                "463a452b.91c98c"
            ]
        ]
    },
    {
        "id": "18dffe74.6c3212",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "00 05 * * *",
        "once": false,
        "x": 290,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "579624c5.9f8fdc",
        "type": "change",
        "z": "eaca0ac7.88c298",
        "name": "Move names",
        "rules": [
            {
                "t": "move",
                "p": "payload.dataset_metadata.entities.device.utterances",
                "pt": "msg",
                "to": "existingNames.device",
                "tot": "msg"
            },
            {
                "t": "move",
                "p": "payload.dataset_metadata.entities.room.utterances",
                "pt": "msg",
                "to": "existingNames.room",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 770,
        "y": 620,
        "wires": [
            [
                "9e29f0c2.18b8f"
            ]
        ]
    },
    {
        "id": "9e29f0c2.18b8f",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Create/Compare",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction findNamesByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction buildETSNamesList(array) {\n    ETSNamesDevice = [];\n    ETSNamesRoom = [];\n    for (var i = 0; i < array.length; i++) {\n        if (ETSNamesDevice.indexOf(array[i].object.toLowerCase().sansAccent()) === -1) {\n            ETSNamesDevice.push(array[i].object.toLowerCase().sansAccent());\n        }\n        if (ETSNamesRoom.indexOf(array[i].zone.toLowerCase().sansAccent()) === -1) {\n            ETSNamesRoom.push(array[i].zone.toLowerCase().sansAccent());\n        }\n    }\n    return null;\n}\n\nfunction buildSNIPSDeviceList(array) {\n    array = JSON.stringify(array);\n    array = array.replace(/\\{\\\"/g, \"\\[\\{\\\"\");\n    array = array.replace(/\\\"\\}/g, \"\\\"\\}\\]\");\n    array = array.replace(/,/g, \"\\},\\{\");\n    array = JSON.parse(array);\n    SNIPSNamesDevice = [];\n    for (var i = 0; i < array.length; i++) {\n        tmp = JSON.stringify(array[i]);\n        tmp = tmp.split(\":\");\n        tmp = tmp[1].replace(\"\\\"\", \"\");\n        tmp = tmp.replace(/\\\"\\}/g, \"\");\n        if (SNIPSNamesDevice.indexOf(tmp.toLowerCase().sansAccent()) === -1) {\n            SNIPSNamesDevice.push(tmp.toLowerCase().sansAccent());\n        }\n    }\n    return null;\n}\n\nfunction buildSNIPSRoomList(array) {\n    array = JSON.stringify(array);\n    array = array.replace(/\\{\\\"/g, \"\\[\\{\\\"\");\n    array = array.replace(/\\\"\\}/g, \"\\\"\\}\\]\");\n    array = array.replace(/,/g, \"\\},\\{\");\n    array = JSON.parse(array);\n    SNIPSNamesRoom = [];\n    for (var i = 0; i < array.length; i++) {\n        tmp = JSON.stringify(array[i]);\n        tmp = tmp.split(\":\");\n        tmp = tmp[1].replace(\"\\\"\", \"\");\n        tmp = tmp.replace(/\\\"\\}/g, \"\");\n        if (SNIPSNamesRoom.indexOf(tmp.toLowerCase().sansAccent()) === -1) {\n            SNIPSNamesRoom.push(tmp.toLowerCase().sansAccent());\n        }\n    }\n    return null;\n}\n\nfunction compareDeviceLists(SNIPSList, ETSList) {\n    deviceToInject = [];\n    cpt = 0;\n    for (var i = 0; i < ETSList.length; i++) {\n        exist = false;\n        for (var x = 0; x < SNIPSList.length; x++) {\n            if (ETSList[i] === SNIPSList[x]) {\n                exist = true;\n            }\n        }\n        if (exist === false) {\n            deviceToInject[cpt] = \"\\\"\"+ETSList[i]+\"\\\"\";\n        }\n    }\n}\n\nfunction compareRoomLists(SNIPSList, ETSList) {\n    roomToInject = [];\n    cpt = 0;\n    for (var i = 0; i < ETSList.length; i++) {\n        exist = false;\n        for (var x = 0; x < SNIPSList.length; x++) {\n            if (ETSList[i] === SNIPSList[x]) {\n                exist = true;\n            }\n        }\n        if (exist === false) {\n            roomToInject[cpt] = \"\\\"\"+ETSList[i]+\"\\\"\";\n        }\n    }\n}\n\nmsg.deviceList = flow.get(\"msgDeviceList\");\n\nif (msg.deviceList !== undefined && msg.existingNames !== undefined) {\n    buildETSNamesList(msg.deviceList, 'type', 'lights');\n    buildETSNamesList(msg.deviceList, 'type', 'dimmers');\n    buildETSNamesList(msg.deviceList, 'type', 'blinds');\n    buildETSNamesList(msg.deviceList, 'type', 'heating');\n    buildETSNamesList(msg.deviceList, 'type', 'scenes');\n    buildETSNamesList(msg.deviceList, 'type', 'aux');\n    buildETSNamesList(msg.deviceList, 'type', 'controls');\n    \n    buildSNIPSDeviceList(msg.existingNames.device);\n    buildSNIPSRoomList(msg.existingNames.room);\n    \n    compareDeviceLists(SNIPSNamesDevice, ETSNamesDevice);\n    compareRoomLists(SNIPSNamesRoom, ETSNamesRoom);\n    \n    if (roomToInject !== undefined || deviceToInject !== undefined) {\n        msg.inject = true;\n        template1 = \"{\\\"operations\\\": [\";\n        template2 = \"]}\";\n        if (roomToInject !== undefined) {\n            newRoomList1 = \"[\\\"addFromVanilla\\\",{\\\"room\\\":[\";\n            newRoomList2 = roomToInject;\n            if (deviceToInject !== undefined) {newRoomList3 = \"]}],\";} else {newRoomList3 = \"]}]\";}\n            tmpNRL = [newRoomList1, newRoomList2, newRoomList3];\n            newRoomList = \"\".concat(...tmpNRL);\n        } else {\n            newRoomlist = \"\";\n        }\n        if (deviceToInject !== undefined) {\n            newDeviceList1 = \"[\\\"addFromVanilla\\\",{\\\"device\\\":[\";\n            newDeviceList2 = deviceToInject;\n            newDeviceList3 = \"]}]\";\n            tmpNDL = [newDeviceList1, newDeviceList2, newDeviceList3];\n            newDeviceList = \"\".concat(...tmpNDL);\n        } else {\n            newDevicelist = \"\";\n        }\n        injectionString = [template1, newRoomList, newDeviceList, template2];\n        tmpInject = \"\".concat(...injectionString);\n        msg.payload = JSON.parse(tmpInject);\n    }\n}\n\nmsg.one = roomToInject;\nmsg.two = deviceToInject;\nmsg.three = tmpInject;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 940,
        "y": 620,
        "wires": [
            [
                "43231aab.f22cd4"
            ]
        ]
    },
    {
        "id": "8087c294.4df22",
        "type": "exec",
        "z": "eaca0ac7.88c298",
        "command": "sudo mosquitto_pub -t hermes/injection/perform -f /usr/share/snips/injections.json",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": true,
        "name": "Inject new words",
        "x": 1400,
        "y": 620,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "9d6b2c78.c64f1",
        "type": "file",
        "z": "eaca0ac7.88c298",
        "name": "",
        "filename": "/usr/share/snips/injections.json",
        "appendNewline": true,
        "createDir": false,
        "overwriteFile": "true",
        "x": 1340,
        "y": 660,
        "wires": []
    },
    {
        "id": "463a452b.91c98c",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": false,
        "x": 630,
        "y": 620,
        "wires": [
            [
                "579624c5.9f8fdc"
            ]
        ]
    },
    {
        "id": "43231aab.f22cd4",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "inject",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1100,
        "y": 620,
        "wires": [
            [
                "71e1be03.5f88d",
                "9d6b2c78.c64f1"
            ],
            []
        ]
    },
    {
        "id": "71e1be03.5f88d",
        "type": "delay",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 1230,
        "y": 620,
        "wires": [
            [
                "8087c294.4df22"
            ]
        ]
    },
    {
        "id": "1785b3b0.9e2e3c",
        "type": "comment",
        "z": "eaca0ac7.88c298",
        "name": "=============================DYNAMIC VOCABULARY================================",
        "info": "",
        "x": 500,
        "y": 560,
        "wires": []
    },
    {
        "id": "10cc755a.0d8ceb",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "payload.intent.probability",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0.5",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2190,
        "y": 240,
        "wires": [
            [
                "53f423a5.f9e73c"
            ],
            [
                "a5a1d83b.9b8ec8"
            ]
        ]
    },
    {
        "id": "b4038211.36c5a",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:shiftUpLights",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 240,
        "wires": [
            [
                "eb60198e.f18468"
            ]
        ]
    },
    {
        "id": "fc087ff0.519ca",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:turnOffLights",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 200,
        "wires": [
            [
                "eb60198e.f18468"
            ]
        ]
    },
    {
        "id": "5e3593cb.fb406c",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:shiftDownLights",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 280,
        "wires": [
            [
                "eb60198e.f18468"
            ]
        ]
    },
    {
        "id": "cb5c51a.1254ab",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:setBrightnessLights",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 320,
        "wires": [
            [
                "eb60198e.f18468"
            ]
        ]
    },
    {
        "id": "2d695cf8.312014",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": true,
        "x": 2070,
        "y": 480,
        "wires": [
            [
                "d333ef90.4178c",
                "5d2f2827.88ca68"
            ]
        ]
    },
    {
        "id": "8469a9dd.fc31c8",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:openSetShutters",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 420,
        "wires": [
            [
                "2d695cf8.312014"
            ]
        ]
    },
    {
        "id": "d333ef90.4178c",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "payload.intent.probability",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0.45",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2190,
        "y": 480,
        "wires": [
            [
                "3dd9690a.f84f16"
            ],
            [
                "519bbfd4.4b6fa"
            ]
        ]
    },
    {
        "id": "78c3d2a.5b1022c",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:shiftUpShutters",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 500,
        "wires": [
            [
                "2d695cf8.312014"
            ]
        ]
    },
    {
        "id": "229ce68a.03ac2a",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:closeSetShutters",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 460,
        "wires": [
            [
                "2d695cf8.312014"
            ]
        ]
    },
    {
        "id": "50f7c29e.0976dc",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:shiftDownShutters",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 540,
        "wires": [
            [
                "2d695cf8.312014"
            ]
        ]
    },
    {
        "id": "8df6cac8.1a2e58",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": true,
        "x": 2070,
        "y": 660,
        "wires": [
            [
                "1fa40536.9f39cb",
                "93009144.1645d"
            ]
        ]
    },
    {
        "id": "c71b4cf7.79dbc",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:setThermostats",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 640,
        "wires": [
            [
                "8df6cac8.1a2e58"
            ]
        ]
    },
    {
        "id": "1fa40536.9f39cb",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "payload.intent.probability",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0.4",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2190,
        "y": 660,
        "wires": [
            [
                "2098bebe.db1312"
            ],
            [
                "ddef9880.502558"
            ]
        ]
    },
    {
        "id": "f32df5e2.572578",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:shiftThermostats",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 680,
        "wires": [
            [
                "8df6cac8.1a2e58"
            ]
        ]
    },
    {
        "id": "7b7fad2b.8a5e14",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": true,
        "x": 2070,
        "y": 800,
        "wires": [
            [
                "97d28f0.f5fca7",
                "b54336f8.fbad28"
            ]
        ]
    },
    {
        "id": "97d28f0.f5fca7",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "payload.intent.probability",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0.5",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2190,
        "y": 800,
        "wires": [
            [
                "c57b0579.d514e8"
            ],
            [
                "16555c0f.80e714"
            ]
        ]
    },
    {
        "id": "5a089882.406a68",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:activateScenes",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 800,
        "wires": [
            [
                "7b7fad2b.8a5e14"
            ]
        ]
    },
    {
        "id": "df5d3096.85af3",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Route requests",
        "property": "payload.intent.intentName",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "ProKNX:turnOnLights",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:turnOffLights",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:shiftUpLights",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:shiftDownLights",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:setBrightnessLights",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 5,
        "x": 2660,
        "y": 240,
        "wires": [
            [
                "4bd98a40.6362a4"
            ],
            [
                "6cfe5096.0aec6"
            ],
            [
                "d03939ce.7b7858"
            ],
            [
                "5cee5fcb.bbbe3"
            ],
            [
                "c32db7bd.b88688"
            ]
        ]
    },
    {
        "id": "a5a1d83b.9b8ec8",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "func": "msg.cmd = [];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\n\nif (msg.cmd.lang === \"de\") {\n    text = \"Entschuldigung, Ich habe deine Anweisung nicht verstanden\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"de-DE\"\n    };\n} else if (msg.cmd.lang === \"fr\") {\n    text = \"Désolé, je n'ai pas compris la commande\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"fr-FR\"\n    };\n} else {\n    text = \"Sorry, I do not understand your command\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"en-EN\"\n    };\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2310,
        "y": 260,
        "wires": [
            [
                "4aa110f9.a482d"
            ]
        ]
    },
    {
        "id": "4aa110f9.a482d",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2395,
        "y": 260,
        "wires": []
    },
    {
        "id": "53f423a5.f9e73c",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Array_intent",
        "func": "msg.cmd = [];\nmsg.items = [];\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.proServIP = flow.get(\"msgProServIP\");\n\nString.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction findObjectByKey(array, key, value) {\n    items=[];\n    var cpt=0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            items[cpt]=array[i];\n            cpt++;\n        }\n    }\n    if (items[0] !== undefined) {\n        return items;\n    } else {\n        return null;\n    }\n}\n\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawDevice = findObjectByKey(msg.payload.slots, 'slotName', 'light_device');\nvar rawValue = findObjectByKey(msg.payload.slots, 'slotName', 'value');\nmsg.cmd.type = \"lights\";\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\nif (rawRoom !== null) {\n    msg.cmd.room = [];\n    for (var i = 0; i < rawRoom.length; i++) {\n        msg.cmd.room[i] = rawRoom[i].value.value.toLowerCase().sansAccent();\n        if (msg.cmd.room[i] === \"here\" ||msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\" ) {\n            msg.cmd.room[i] = msg.payload.siteId.replace(/_/g,\" \");\n        }\n        if (msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"uberall\"){\n            delete msg.cmd.room;\n            break;\n        }\n    }\n} else {\n    msg.cmd.room = [];\n    msg.cmd.room[0] = msg.payload.siteId.replace(/_/g,\" \");\n}\n\nif (rawDevice !== null) {\n    msg.rawDevice = rawDevice;\n    msg.cmd.device = [];\n    cpt = 0;\n    for (var i = 0; i < rawDevice.length; i++) {\n    \t    msg.cmd.device[cpt] = rawDevice[i].value.value.toLowerCase().sansAccent();\n            cpt++;\n        if (msg.cmd.device[i] === \"licht\" || msg.cmd.device[i] === \"light\") {\n            delete msg.cmd.device[i];\n            cpt--;\n            if (rawDevice.length == 1) {delete msg.cmd.device;}\n        } else if (msg.cmd.device[i] === \"everything\" ) {\n            delete msg.cmd.device;\n            break;\n        }\n    }\n}\n\nif (rawValue !== null) {\n\tmsg.cmd.value = precisionRound(rawValue[0].value.value, 1);\n}\n\ntmp = [];\nfindSwitchByKey(msg.deviceList, 'type', 'lights');\nfindDimmerByKey(msg.deviceList, 'type', 'dimmers');\nmsg.items = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\ntmp = msg.items;\n\nif (msg.cmd.device !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.device.length; i++) {\n        findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n}\n\nif (msg.cmd.room !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.room.length; i++) {\n        findRoomByKey(tmp, 'zone', msg.cmd.room[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n}\n\nmsg.items = tmp;\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Ich kann dieses Licht nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Je n'ai pas pu trouver cette lumière\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"I can not find this light\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2330,
        "y": 220,
        "wires": [
            [
                "fd85e2e1.6e7c5"
            ]
        ]
    },
    {
        "id": "fd85e2e1.6e7c5",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2480,
        "y": 220,
        "wires": [
            [
                "27aedf0a.2d754"
            ],
            [
                "df5d3096.85af3"
            ]
        ]
    },
    {
        "id": "27aedf0a.2d754",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2615,
        "y": 160,
        "wires": []
    },
    {
        "id": "6cfe5096.0aec6",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"off\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 200,
        "wires": [
            [
                "2a73e744.3344e8"
            ]
        ]
    },
    {
        "id": "d03939ce.7b7858",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"increase\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 240,
        "wires": [
            [
                "24c6e88a.c33a08"
            ]
        ]
    },
    {
        "id": "5cee5fcb.bbbe3",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"decrease\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 280,
        "wires": [
            [
                "3f0a8b83.1fa2e4"
            ]
        ]
    },
    {
        "id": "c32db7bd.b88688",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"on\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 320,
        "wires": [
            [
                "96c61aed.b33ce8"
            ]
        ]
    },
    {
        "id": "4d0770e0.41328",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 160,
        "wires": []
    },
    {
        "id": "2a73e744.3344e8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 200,
        "wires": []
    },
    {
        "id": "24c6e88a.c33a08",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 240,
        "wires": []
    },
    {
        "id": "3f0a8b83.1fa2e4",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 280,
        "wires": []
    },
    {
        "id": "96c61aed.b33ce8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 320,
        "wires": []
    },
    {
        "id": "70a73811.5bf748",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "",
        "payload": "{\"sessionId\":\"40951a47-03ec-447e-8bf8-9302374e892e\",\"customData\":null,\"siteId\":\"bedroom\",\"input\":\"set the brightness of the wall to fifty percent in the home cinema\",\"asrTokens\":[[{\"value\":\"set\",\"confidence\":1,\"range_start\":0,\"range_end\":3,\"time\":{\"start\":0,\"end\":0.48}},{\"value\":\"the\",\"confidence\":1,\"range_start\":4,\"range_end\":7,\"time\":{\"start\":0.48,\"end\":0.63}},{\"value\":\"brightness\",\"confidence\":1,\"range_start\":8,\"range_end\":18,\"time\":{\"start\":0.63,\"end\":1.29}},{\"value\":\"of\",\"confidence\":1,\"range_start\":19,\"range_end\":21,\"time\":{\"start\":1.29,\"end\":1.5}},{\"value\":\"the\",\"confidence\":1,\"range_start\":22,\"range_end\":25,\"time\":{\"start\":1.5,\"end\":1.68}},{\"value\":\"wall\",\"confidence\":0.974062,\"range_start\":26,\"range_end\":30,\"time\":{\"start\":1.68,\"end\":2.4031124}},{\"value\":\"to\",\"confidence\":1,\"range_start\":31,\"range_end\":33,\"time\":{\"start\":2.4031124,\"end\":2.9099998}},{\"value\":\"fifty\",\"confidence\":0.9698206,\"range_start\":34,\"range_end\":39,\"time\":{\"start\":2.9099998,\"end\":3.36}},{\"value\":\"percent\",\"confidence\":0.6872867,\"range_start\":40,\"range_end\":47,\"time\":{\"start\":3.36,\"end\":3.57}},{\"value\":\"in\",\"confidence\":1,\"range_start\":48,\"range_end\":50,\"time\":{\"start\":3.57,\"end\":3.78}},{\"value\":\"the\",\"confidence\":1,\"range_start\":51,\"range_end\":54,\"time\":{\"start\":3.78,\"end\":3.87}},{\"value\":\"home\",\"confidence\":1,\"range_start\":55,\"range_end\":59,\"time\":{\"start\":3.87,\"end\":3.87}},{\"value\":\"cinema\",\"confidence\":1,\"range_start\":60,\"range_end\":66,\"time\":{\"start\":3.87,\"end\":5.46}}]],\"intent\":{\"intentName\":\"ProKNX:turnOffLights\",\"probability\":0.75861675},\"slots\":[{\"confidence\":0.9698206,\"rawValue\":\"fifty\",\"value\":{\"kind\":\"custom\",\"value\":\"light\"},\"range\":{\"start\":34,\"end\":39},\"entity\":\"light_device\",\"slotName\":\"light_device\"},{\"confidence\":1,\"rawValue\":\"home cinema\",\"value\":{\"kind\":\"Custom\",\"value\":\"home cinema\"},\"range\":{\"start\":55,\"end\":66},\"entity\":\"house_room\",\"slotName\":\"room\"}]}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2070,
        "y": 280,
        "wires": [
            [
                "10cc755a.0d8ceb"
            ]
        ]
    },
    {
        "id": "2534b2a6.b8d3ce",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "siteID replace ' ' with '_'",
        "func": "if(msg.payload.siteId)\n    msg.payload.siteId = msg.payload.siteId.replace(/ /g,\"_\");\nelse\n    msg.payload.siteId = \"default\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2839.196075439453,
        "y": 1953.369351387024,
        "wires": [
            [
                "7b6e6f.5450619"
            ]
        ]
    },
    {
        "id": "dccacc10.26c4c",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "Session IN",
        "links": [
            "c8aa1b9f.0682e8"
        ],
        "x": 2155,
        "y": 200,
        "wires": []
    },
    {
        "id": "5d2f2827.88ca68",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "Session IN",
        "links": [
            "c8aa1b9f.0682e8"
        ],
        "x": 2155,
        "y": 440,
        "wires": []
    },
    {
        "id": "93009144.1645d",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "Session IN",
        "links": [
            "c8aa1b9f.0682e8"
        ],
        "x": 2155,
        "y": 620,
        "wires": []
    },
    {
        "id": "b54336f8.fbad28",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "Session IN",
        "links": [
            "c8aa1b9f.0682e8"
        ],
        "x": 2155,
        "y": 760,
        "wires": []
    },
    {
        "id": "2321637.1a57f9c",
        "type": "mqtt in",
        "z": "eaca0ac7.88c298",
        "name": "MQTT IN",
        "topic": "hermes/intent/ProKNX:deviceStatusCheck",
        "qos": "2",
        "broker": "c0e0d49d.594088",
        "x": 1880,
        "y": 960,
        "wires": [
            [
                "7bf23593.7c193c"
            ]
        ]
    },
    {
        "id": "7bf23593.7c193c",
        "type": "json",
        "z": "eaca0ac7.88c298",
        "name": "",
        "pretty": true,
        "x": 2070,
        "y": 960,
        "wires": [
            [
                "83cb1008.359f4",
                "81198276.3ae09"
            ]
        ]
    },
    {
        "id": "83cb1008.359f4",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "Session IN",
        "links": [
            "c8aa1b9f.0682e8"
        ],
        "x": 2155,
        "y": 920,
        "wires": []
    },
    {
        "id": "b3729d1f.246e",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"on\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 420,
        "wires": [
            [
                "7ab64b18.83e804"
            ]
        ]
    },
    {
        "id": "b1cfb1f.0f9b05",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Route requests",
        "property": "payload.intent.intentName",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "ProKNX:openSetShutters",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:closeSetShutters",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:shiftUpShutters",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:shiftDownShutters",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 4,
        "x": 2660,
        "y": 480,
        "wires": [
            [
                "b3729d1f.246e"
            ],
            [
                "64e3ab92.d341f4"
            ],
            [
                "16f30843.d53268"
            ],
            [
                "21bf2ce2.27a3f4"
            ]
        ]
    },
    {
        "id": "519bbfd4.4b6fa",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "func": "msg.cmd = [];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\n\nif (msg.cmd.lang === \"de\") {\n    text = \"Entschuldigung, Ich habe deine Anweisung nicht verstanden\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"de-DE\"\n    };\n} else if (msg.cmd.lang === \"fr\") {\n    text = \"Désolé, je n'ai pas compris la commande\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"fr-FR\"\n    };\n} else {\n    text = \"Sorry, I do not understand your command\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"en-EN\"\n    };\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2310,
        "y": 500,
        "wires": [
            [
                "2b525da6.a5ead2"
            ]
        ]
    },
    {
        "id": "2b525da6.a5ead2",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2395,
        "y": 500,
        "wires": []
    },
    {
        "id": "3dd9690a.f84f16",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Array_intent",
        "func": "msg.cmd = [];\nmsg.items = [];\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.proServIP = flow.get(\"msgProServIP\");\n\nString.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction findObjectByKey(array, key, value) {\n    items=[];\n    var cpt=0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            items[cpt]=array[i];\n            cpt++;\n        }\n    }\n    if (items[0] !== undefined) {\n        return items;\n    } else {\n        return null;\n    }\n}\n\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawDevice = findObjectByKey(msg.payload.slots, 'slotName', 'window_device');\nvar rawValue = findObjectByKey(msg.payload.slots, 'slotName', 'value');\nmsg.cmd.type = \"blinds\";\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\nif (rawRoom !== null) {\n    msg.cmd.room = [];\n    for (var i = 0; i < rawRoom.length; i++) {\n        msg.cmd.room[i] = rawRoom[i].value.value.toLowerCase().sansAccent();\n        if (msg.cmd.room[i] === \"here\" ||msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\" ) {\n            msg.cmd.room[i] = msg.payload.siteId.replace(/_/g,\" \");\n        }\n        if (msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"uberall\"){\n            delete msg.cmd.room;\n            break;\n        }\n    }\n} else {\n    msg.cmd.room = [];\n    msg.cmd.room[0] = msg.payload.siteId.replace(/_/g,\" \");\n}\nif (rawDevice !== null) {\n    msg.cmd.device = [];\n    for (var i = 0; i < rawDevice.length; i++) {\n\t    msg.cmd.device[i] = rawDevice[i].value.value.toLowerCase().sansAccent();\n    }\n}\n\nif (rawValue !== null) {\n\tmsg.cmd.value = precisionRound(rawValue[0].value.value, 1);\n}\n\ntmp = [];\nfindTypeByKey(msg.deviceList, 'type', msg.cmd.type);\ntmp = msg.items;\n\nif (msg.cmd.device !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.device.length; i++) {\n        findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    if (tmpList[0][0]!== undefined) {\n            if (tmpList[0][0].name!== undefined) {\n                tmp = [];\n                for (var i = 0; i < tmpList.length; i++) {\n                    for (var n = 0; n < tmpList[i].length; n++) {\n                        tmp.push(tmpList[i][n]);\n                    }\n                }\n            }\n        } else {}\n}\nif (msg.cmd.room !== undefined && tmp !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.room.length; i++) {\n        findRoomByKey(tmp, 'zone', msg.cmd.room[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n}\n\nmsg.items = tmp;\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Ich kann dieses Rolladen nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Je n'ai pas pu trouver ce volet\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"I can not find this shutter\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2330,
        "y": 460,
        "wires": [
            [
                "bb5d3bab.8bcd18"
            ]
        ]
    },
    {
        "id": "bb5d3bab.8bcd18",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2480,
        "y": 460,
        "wires": [
            [
                "5c87043d.8d4bec"
            ],
            [
                "b1cfb1f.0f9b05"
            ]
        ]
    },
    {
        "id": "5c87043d.8d4bec",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2595,
        "y": 420,
        "wires": []
    },
    {
        "id": "64e3ab92.d341f4",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"off\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 460,
        "wires": [
            [
                "663cc209.8d0b9c"
            ]
        ]
    },
    {
        "id": "16f30843.d53268",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"increase\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 500,
        "wires": [
            [
                "c025a9b3.6415f8"
            ]
        ]
    },
    {
        "id": "21bf2ce2.27a3f4",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"decrease\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 540,
        "wires": [
            [
                "bf412a2c.6856b8"
            ]
        ]
    },
    {
        "id": "7ab64b18.83e804",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 420,
        "wires": []
    },
    {
        "id": "663cc209.8d0b9c",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 460,
        "wires": []
    },
    {
        "id": "c025a9b3.6415f8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 500,
        "wires": []
    },
    {
        "id": "bf412a2c.6856b8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 540,
        "wires": []
    },
    {
        "id": "b0d55f87.56bee",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction findObjectByKey(array, key, value) {\n    items=[];\n    var cpt=0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            items[cpt]=array[i];\n            cpt++;\n        }\n    }\n    if (items[0] !== undefined) {\n        return items;\n    } else {\n        return null;\n    }\n}\n\nvar rawAction = findObjectByKey(msg.payload.slots, 'slotName', 'up_down');\n\nif (rawAction[0].value.value.toLowerCase().sansAccent() === \"up\" || rawAction[0].value.value.toLowerCase().sansAccent() === \"hoher\") {\n    msg.cmd.cmd = \"increase\";\n} else if (rawAction[0].value.value.toLowerCase().sansAccent() === \"down\" || rawAction[0].value.value.toLowerCase().sansAccent() === \"niedriger\") {\n    msg.cmd.cmd = \"decrease\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 640,
        "wires": [
            [
                "270bc488.6ab09c"
            ]
        ]
    },
    {
        "id": "528fb094.9f43f",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Route requests",
        "property": "payload.intent.intentName",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "ProKNX:shiftThermostats",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ProKNX:setThermostats",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2660,
        "y": 660,
        "wires": [
            [
                "b0d55f87.56bee"
            ],
            [
                "ffc18eaf.c3f4b"
            ]
        ]
    },
    {
        "id": "ddef9880.502558",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "func": "msg.cmd = [];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\n\nif (msg.cmd.lang === \"de\") {\n    text = \"Entschuldigung, Ich habe deine Anweisung nicht verstanden\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"de-DE\"\n    };\n} else if (msg.cmd.lang === \"fr\") {\n    text = \"Désolé, je n'ai pas compris la commande\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"fr-FR\"\n    };\n} else {\n    text = \"Sorry, I do not understand your command\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"en-EN\"\n    };\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2310,
        "y": 680,
        "wires": [
            [
                "a673cbd6.ea8e98"
            ]
        ]
    },
    {
        "id": "a673cbd6.ea8e98",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2395,
        "y": 680,
        "wires": []
    },
    {
        "id": "2098bebe.db1312",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Array_intent",
        "func": "msg.cmd = [];\nmsg.items = [];\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.proServIP = flow.get(\"msgProServIP\");\n\nString.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction findObjectByKey(array, key, value) {\n    items=[];\n    var cpt=0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            items[cpt]=array[i];\n            cpt++;\n        }\n    }\n    if (items[0] !== undefined) {\n        return items;\n    } else {\n        return null;\n    }\n}\n\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawDevice = findObjectByKey(msg.payload.slots, 'slotName', 'temperature_device');\nvar rawValue = findObjectByKey(msg.payload.slots, 'slotName', 'temperature');\nvar rawUpDown = findObjectByKey(msg.payload.slots, 'slotName', 'up_down');\nmsg.cmd.type = \"heating\";\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\n\nif (rawRoom !== null) {\n    msg.cmd.room = [];\n    for (var i = 0; i < rawRoom.length; i++) {\n        msg.cmd.room[i] = rawRoom[i].value.value.toLowerCase().sansAccent();\n        if (msg.cmd.room[i] === \"here\" ||msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\" ) {\n            msg.cmd.room[i] = msg.payload.siteId.replace(/_/g,\" \");\n        }\n        if (msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"uberall\"){\n            delete msg.cmd.room;\n            break;\n        }\n    }\n} else {\n    msg.cmd.room = [];\n    msg.cmd.room[0] = msg.payload.siteId.replace(/_/g,\" \");\n}\n\nif (rawDevice !== null) {\n    msg.cmd.device = [];\n    for (var i = 0; i < rawDevice.length; i++) {\n\t    msg.cmd.device[i] = rawDevice[i].value.value.toLowerCase().sansAccent();\n    }\n}\n\nif (rawValue !== null) {\n\tmsg.cmd.value = precisionRound(rawValue[0].value.value, 1);\n}\n\ntmp = [];\nfindTypeByKey(msg.deviceList, 'type', msg.cmd.type);\ntmp = msg.items;\n\nif (msg.cmd.device !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.device.length; i++) {\n        findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    if (tmpList[0][0]!== undefined) {\n            if (tmpList[0][0].name!== undefined) {\n                tmp = [];\n                for (var i = 0; i < tmpList.length; i++) {\n                    for (var n = 0; n < tmpList[i].length; n++) {\n                        tmp.push(tmpList[i][n]);\n                    }\n                }\n            }\n        } else {}\n}\nif (msg.cmd.room !== undefined && tmp !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.room.length; i++) {\n        findRoomByKey(tmp, 'zone', msg.cmd.room[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n}\n\nmsg.items = tmp;\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Ich kann dieses Thermostat nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Je n'ai pas pu trouver ce thermostat\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"I can not find this thermostat\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2330,
        "y": 640,
        "wires": [
            [
                "b882a683.4bec98"
            ]
        ]
    },
    {
        "id": "b882a683.4bec98",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2480,
        "y": 640,
        "wires": [
            [
                "f4249068.8daf8"
            ],
            [
                "528fb094.9f43f"
            ]
        ]
    },
    {
        "id": "f4249068.8daf8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2595,
        "y": 620,
        "wires": []
    },
    {
        "id": "ffc18eaf.c3f4b",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"set\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 680,
        "wires": [
            [
                "20477952.5810b6"
            ]
        ]
    },
    {
        "id": "270bc488.6ab09c",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 640,
        "wires": []
    },
    {
        "id": "20477952.5810b6",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "eba6ccd8.bcc9c",
            "62466314.d3ef3c"
        ],
        "x": 2975,
        "y": 680,
        "wires": []
    },
    {
        "id": "77674886.f92cd8",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "",
        "payload": "{\"sessionId\":\"40951a47-03ec-447e-8bf8-9302374e892e\",\"customData\":null,\"siteId\":\"bedroom\",\"input\":\"set the brightness of the wall to fifty percent in the home cinema\",\"intent\":{\"intentName\":\"ProKNX:shiftUpShutters\",\"probability\":0.75861675},\"slots\":[{\"confidence\":0.9698206,\"rawValue\":\"thirty\",\"value\":{\"kind\":\"Number\",\"value\":30},\"range\":{\"start\":34,\"end\":39},\"entity\":\"snips/number\",\"slotName\":\"value\"},{\"confidence\":1,\"rawValue\":\"bedroom\",\"value\":{\"kind\":\"Custom\",\"value\":\"bedroom\"},\"range\":{\"start\":55,\"end\":66},\"entity\":\"house_room\",\"slotName\":\"room\"},{\"confidence\":1,\"rawValue\":\"blinds\",\"value\":{\"kind\":\"Custom\",\"value\":\"blinds\"},\"range\":{\"start\":55,\"end\":66},\"entity\":\"window_device\",\"slotName\":\"window_device\"}]}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2070,
        "y": 520,
        "wires": [
            [
                "d333ef90.4178c"
            ]
        ]
    },
    {
        "id": "3cb9a4c6.f514ec",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "",
        "payload": "{\"sessionId\":\"40951a47-03ec-447e-8bf8-9302374e892e\",\"customData\":null,\"siteId\":\"bedroom\",\"input\":\"set the brightness of the wall to fifty percent in the home cinema\",\"intent\":{\"intentName\":\"ProKNX:shiftThermostats\",\"probability\":0.75861675},\"slots\":[{\"confidence\":0.974062,\"rawValue\":\"up\",\"value\":{\"kind\":\"Custom\",\"value\":\"down\"},\"range\":{\"start\":26,\"end\":30},\"entity\":\"up_down\",\"slotName\":\"up_down\"},{\"confidence\":1,\"rawValue\":\"home cinema\",\"value\":{\"kind\":\"Custom\",\"value\":\"home cinema\"},\"range\":{\"start\":55,\"end\":66},\"entity\":\"house_room\",\"slotName\":\"room\"}]}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2070,
        "y": 700,
        "wires": [
            [
                "1fa40536.9f39cb"
            ]
        ]
    },
    {
        "id": "bde3d191.f8182",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Set_cmd",
        "func": "msg.cmd.cmd = \"on\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 800,
        "wires": [
            [
                "e1699e4c.6183b"
            ]
        ]
    },
    {
        "id": "a2928364.c8912",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Route requests",
        "property": "payload.intent.intentName",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "ProKNX:activateScenes",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 2660,
        "y": 800,
        "wires": [
            [
                "bde3d191.f8182"
            ]
        ]
    },
    {
        "id": "16555c0f.80e714",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "func": "msg.cmd = [];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\n\nif (msg.cmd.lang === \"de\") {\n    text = \"Entschuldigung, Ich habe deine Anweisung nicht verstanden\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"de-DE\"\n    };\n} else if (msg.cmd.lang === \"fr\") {\n    text = \"Désolé, je n'ai pas compris la commande\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"fr-FR\"\n    };\n} else {\n    text = \"Sorry, I do not understand your command\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"en-EN\"\n    };\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2310,
        "y": 820,
        "wires": [
            [
                "90d47db3.aca5f"
            ]
        ]
    },
    {
        "id": "90d47db3.aca5f",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2395,
        "y": 820,
        "wires": []
    },
    {
        "id": "c57b0579.d514e8",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Array_intent",
        "func": "msg.cmd = [];\nmsg.items = [];\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.proServIP = flow.get(\"msgProServIP\");\n\nString.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction findObjectByKey(array, key, value) {\n    items=[];\n    var cpt=0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            items[cpt]=array[i];\n            cpt++;\n        }\n    }\n    if (items[0] !== undefined) {\n        return items;\n    } else {\n        return null;\n    }\n}\n\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawDevice = findObjectByKey(msg.payload.slots, 'slotName', 'scene_device');\nvar rawValue = findObjectByKey(msg.payload.slots, 'slotName', 'value');\nmsg.cmd.type = \"scenes\";\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\nif (rawRoom !== null) {\n    msg.cmd.room = [];\n    for (var i = 0; i < rawRoom.length; i++) {\n        msg.cmd.room[i] = rawRoom[i].value.value.toLowerCase().sansAccent();\n        if (msg.cmd.room[i] === \"here\" ||msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\" ) {\n            msg.cmd.room[i] = msg.payload.siteId.replace(/_/g,\" \");\n        }\n        if (msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"uberall\"){\n            delete msg.cmd.room;\n            break;\n        }\n    }\n} else {\n    msg.cmd.room = [];\n    msg.cmd.room[0] = msg.payload.siteId.replace(/_/g,\" \");\n}\n\nif (rawDevice !== null) {\n    msg.cmd.device = [];\n    cpt = 0;\n    for (var i = 0; i < rawDevice.length; i++) {\n        if (rawDevice[i].value.value.toLowerCase().sansAccent() !== \"scene\") {\n    \t    msg.cmd.device[cpt] = rawDevice[i].value.value.toLowerCase().sansAccent();\n            cpt++;\n        }\n    }\n}\n\nif (rawValue !== null) {\n\tmsg.cmd.value = precisionRound(rawValue[0].value.value, 1);\n}\n\ntmp = [];\nfindTypeByKey(msg.deviceList, 'type', msg.cmd.type);\ntmp = msg.items;\n\nif (msg.cmd.device !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.device.length; i++) {\n        findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n}\nif (msg.cmd.room !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.room.length; i++) {\n        findRoomByKey(tmp, 'zone', msg.cmd.room[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n} else {tmp = [];}\n\nmsg.items = tmp;\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Ich kann diese Szene nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Je n'ai pas pu trouver cette scène\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"I can not find this scene\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2330,
        "y": 780,
        "wires": [
            [
                "b3af30fc.54f79"
            ]
        ]
    },
    {
        "id": "b3af30fc.54f79",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2480,
        "y": 780,
        "wires": [
            [
                "7d780d15.2d88f4"
            ],
            [
                "a2928364.c8912"
            ]
        ]
    },
    {
        "id": "7d780d15.2d88f4",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2595,
        "y": 760,
        "wires": []
    },
    {
        "id": "e1699e4c.6183b",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "62466314.d3ef3c",
            "eba6ccd8.bcc9c"
        ],
        "x": 2975,
        "y": 800,
        "wires": []
    },
    {
        "id": "81198276.3ae09",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "",
        "property": "payload.intent.probability",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gte",
                "v": "0.4",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2190,
        "y": 960,
        "wires": [
            [
                "43314f3a.552c3"
            ],
            [
                "2b345b17.877eb4"
            ]
        ]
    },
    {
        "id": "2b345b17.877eb4",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Error ?",
        "func": "msg.cmd = [];\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\n\nif (msg.cmd.lang === \"de\") {\n    text = \"Entschuldigung, Ich habe deine Anweisung nicht verstanden\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"de-DE\"\n    };\n} else if (msg.cmd.lang === \"fr\") {\n    text = \"Désolé, je n'ai pas compris la commande\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"fr-FR\"\n    };\n} else {\n    text = \"Sorry, I do not understand your command\";\n    msg.error = {\n        text: text,\n        siteId: msg.cmd.siteId,\n        lang: \"en-EN\"\n    };\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2310,
        "y": 980,
        "wires": [
            [
                "11da80e0.36178f"
            ]
        ]
    },
    {
        "id": "11da80e0.36178f",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2395,
        "y": 980,
        "wires": []
    },
    {
        "id": "43314f3a.552c3",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "Array_intent",
        "func": "msg.cmd = [];\ntmp = [];\nmsg.items = [];\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.proServIP = flow.get(\"msgProServIP\");\n\nString.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction findObjectByKey(array, key, value) {\n    items=[];\n    var cpt=0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            items[cpt]=array[i];\n            cpt++;\n        }\n    }\n    if (items[0] !== undefined) {\n        return items;\n    } else {\n        return null;\n    }\n}\n\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawLight = findObjectByKey(msg.payload.slots, 'slotName', 'light_device');\nvar rawShutter = findObjectByKey(msg.payload.slots, 'slotName', 'window_device');\nvar rawTherm = findObjectByKey(msg.payload.slots, 'slotName', 'temperature_device');\nvar rawScene = findObjectByKey(msg.payload.slots, 'slotName', 'scene_device');\nvar rawValue = findObjectByKey(msg.payload.slots, 'slotName', 'value');\nmsg.cmd.siteId = msg.payload.siteId.replace(/_/g,\" \");\nmsg.cmd.query = true;\n\nif (rawRoom !== null) {\n    msg.cmd.room = [];\n    for (var i = 0; i < rawRoom.length; i++) {\n        msg.cmd.room[i] = rawRoom[i].value.value.toLowerCase().sansAccent();\n        if (msg.cmd.room[i] === \"here\" ||msg.cmd.room[i] === \"hier\" || msg.cmd.room[i] === \"ici\" ) {\n            msg.cmd.room[i] = msg.payload.siteId.replace(/_/g,\" \");\n        }\n        if (msg.cmd.room[i] === \"everywhere\" || msg.cmd.room[i] === \"uberall\"){\n            delete msg.cmd.room;\n            break;\n        }\n    }\n} else {\n    msg.cmd.room = [];\n    msg.cmd.room[0] = msg.payload.siteId.replace(/_/g,\" \");\n}\n\nif (rawLight !== null) {\n    msg.cmd.type = \"lights\";\n    msg.cmd.device = [];\n    cpt = 0;\n    for (var i = 0; i < rawLight.length; i++) {\n        if (rawLight[i].value.value.toLowerCase().sansAccent() !== \"light\" && rawLight[i].value.value.toLowerCase().sansAccent() !== \"all\") {\n    \t    msg.cmd.device[cpt] = rawLight[i].value.value.toLowerCase().sansAccent();\n            cpt++;\n        }\n    }\n    tmp = [];\n    findSwitchByKey(msg.deviceList, 'type', 'lights');\n    findDimmerByKey(msg.deviceList, 'type', 'dimmers');\n    msg.items = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\n    tmp = msg.items;\n    msg.test = tmp;\n\n    if (msg.cmd.device[0] !== undefined) {\n        msg.tmpList = [];\n        cpt = 0;\n        for (var i = 0; i < msg.cmd.device.length; i++) {\n            findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n            msg.tmpList[cpt] = msg.items;\n            cpt++;\n        }\n        tmp = [];\n        for (var i = 0; i < msg.tmpList.length; i++) {\n            for (var n = 0; n < msg.tmpList[i].length; n++) {\n                tmp.push(msg.tmpList[i][n]);\n            }\n        }\n    }\n} else if (rawShutter !== null) {\n    msg.cmd.type = \"blinds\";\n    cpt = 0;\n    msg.cmd.device = [];\n    for (var i = 0; i < rawShutter.length; i++) {\n        msg.cmd.device[cpt] = rawShutter[i].value.value.toLowerCase().sansAccent();\n    }\n\n    tmp = [];\n    findTypeByKey(msg.deviceList, 'type', msg.cmd.type);\n    tmp = msg.items;\n\n    if (msg.cmd.device[0] !== undefined) {\n        msg.test = \"faut tester\";\n        tmpList = [];\n        cpt = 0;\n        for (var i = 0; i < msg.cmd.device.length; i++) {\n            findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n            tmpList[cpt] = msg.items;\n            cpt++;\n        }\n        msg.test = tmp;\n        if (tmpList[0][0]!== undefined) {\n            if (tmpList[0][0].name!== undefined) {\n                tmp = [];\n                for (var i = 0; i < tmpList.length; i++) {\n                    for (var n = 0; n < tmpList[i].length; n++) {\n                        tmp.push(tmpList[i][n]);\n                    }\n                }\n            }\n        } else {}\n    }\n} else if (rawTherm !== null) {\n    msg.cmd.type = \"heating\";\n    cpt = 0;\n        msg.cmd.device = [];\n        for (var i = 0; i < rawTherm.length; i++) {\n\t        msg.cmd.device[cpt] = rawTherm[i].value.value.toLowerCase().sansAccent();\n        }\n        \n    tmp = [];\n    findTypeByKey(msg.deviceList, 'type', msg.cmd.type);\n    tmp = msg.items;\n\n    if (msg.cmd.device[0] !== undefined) {\n    tmpList = [];\n    cpt = 0;\n        for (var i = 0; i < msg.cmd.device.length; i++) {\n            findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n            tmpList[cpt] = msg.items;\n            cpt++;\n        }\n        if (tmpList[0][0]!== undefined) {\n            if (tmpList[0][0].name!== undefined) {\n                tmp = [];\n                for (var i = 0; i < tmpList.length; i++) {\n                    for (var n = 0; n < tmpList[i].length; n++) {\n                        tmp.push(tmpList[i][n]);\n                    }\n                }\n            }\n        } else {}\n    }\n} else if (rawScene !== null) {\n    msg.cmd.type = \"scenes\";\n    msg.cmd.device = [];\n    cpt = 0;\n    for (var i = 0; i < rawScene.length; i++) {\n        if (rawScene[i].value.value.toLowerCase().sansAccent() !== \"scene\" && RawScene[i].value.value.toLowerCase().sansAccent() !== \"all\") {\n    \t    msg.cmd.device[cpt] = rawScene[i].value.value.toLowerCase().sansAccent();\n            cpt++;\n        }\n    }\n    tmp = [];\n    findTypeByKey(msg.deviceList, 'type', msg.cmd.type);\n    tmp = msg.items;\n\n    if (msg.cmd.device[0] !== undefined) {\n        msg.tmpList = [];\n        cpt = 0;\n        for (var i = 0; i < msg.cmd.device.length; i++) {\n            findDeviceByKey(tmp, 'object', msg.cmd.device[i]);\n            msg.tmpList[cpt] = msg.items;\n            cpt++;\n        }\n        tmp = [];\n        for (var i = 0; i < msg.tmpList.length; i++) {\n            for (var n = 0; n < msg.tmpList[i].length; n++) {\n                tmp.push(msg.tmpList[i][n]);\n            }\n        }\n    }\n}\n\nif (msg.cmd.room !== undefined && tmp !== undefined) {\n    tmpList = [];\n    cpt = 0;\n    for (var i = 0; i < msg.cmd.room.length; i++) {\n        findRoomByKey(tmp, 'zone', msg.cmd.room[i]);\n        tmpList[cpt] = msg.items;\n        cpt++;\n    }\n    tmp = [];\n    for (var i = 0; i < tmpList.length; i++) {\n        for (var n = 0; n < tmpList[i].length; n++) {\n            tmp.push(tmpList[i][n]);\n        }\n    }\n}\n\nmsg.items = tmp;\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2330,
        "y": 940,
        "wires": [
            [
                "a9c8f32e.5f31d"
            ]
        ]
    },
    {
        "id": "a9c8f32e.5f31d",
        "type": "switch",
        "z": "eaca0ac7.88c298",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2480,
        "y": 960,
        "wires": [
            [
                "3f0f076c.ee86b8"
            ],
            [
                "b1af9c7d.b1a12"
            ]
        ]
    },
    {
        "id": "3f0f076c.ee86b8",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "ERROR IN",
        "links": [
            "aeff6d7b.9a0df",
            "8be6dbfa.f122e8",
            "ce8c5acd.622cd8"
        ],
        "x": 2595,
        "y": 940,
        "wires": []
    },
    {
        "id": "b1af9c7d.b1a12",
        "type": "link out",
        "z": "eaca0ac7.88c298",
        "name": "QUERY EXECUTION IN",
        "links": [
            "a7d3de52.cf769",
            "eba6ccd8.bcc9c"
        ],
        "x": 2595,
        "y": 980,
        "wires": []
    },
    {
        "id": "c31e4a61.1a6418",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "",
        "payload": "{\"sessionId\":\"ada95fa7-80bc-4a75-86dd-1c43e4921950\",\"customData\":null,\"siteId\":\"default\",\"input\":\"what 's the status of the blinds in the home cinema\",\"asrTokens\":[[{\"value\":\"what\",\"confidence\":1,\"range_start\":0,\"range_end\":4,\"time\":{\"start\":0,\"end\":1.02}},{\"value\":\"'s\",\"confidence\":1,\"range_start\":5,\"range_end\":7,\"time\":{\"start\":1.02,\"end\":1.14}},{\"value\":\"the\",\"confidence\":0.9781889,\"range_start\":8,\"range_end\":11,\"time\":{\"start\":1.14,\"end\":1.316074}},{\"value\":\"status\",\"confidence\":1,\"range_start\":12,\"range_end\":18,\"time\":{\"start\":1.316074,\"end\":1.8299999}},{\"value\":\"of\",\"confidence\":1,\"range_start\":19,\"range_end\":21,\"time\":{\"start\":1.8299999,\"end\":1.9799999}},{\"value\":\"the\",\"confidence\":0.9132247,\"range_start\":22,\"range_end\":25,\"time\":{\"start\":1.9799999,\"end\":2.7471087}},{\"value\":\"blinds\",\"confidence\":1,\"range_start\":26,\"range_end\":32,\"time\":{\"start\":2.7471087,\"end\":2.9099998}},{\"value\":\"in\",\"confidence\":1,\"range_start\":33,\"range_end\":35,\"time\":{\"start\":2.9099998,\"end\":3.06}},{\"value\":\"the\",\"confidence\":1,\"range_start\":36,\"range_end\":39,\"time\":{\"start\":3.06,\"end\":3.3}},{\"value\":\"home\",\"confidence\":1,\"range_start\":40,\"range_end\":44,\"time\":{\"start\":3.3,\"end\":3.3899999}},{\"value\":\"cinema\",\"confidence\":1,\"range_start\":45,\"range_end\":51,\"time\":{\"start\":3.3899999,\"end\":4.62}}]],\"intent\":{\"intentName\":\"ProKNX:deviceStatusCheck\",\"probability\":0.99101967},\"slots\":[{\"confidence\":1,\"rawValue\":\"blinds\",\"value\":{\"kind\":\"Custom\",\"value\":\"blinds\"},\"range\":{\"start\":26,\"end\":32},\"entity\":\"window_device\",\"slotName\":\"window_device\"},{\"confidence\":1,\"rawValue\":\"home cinema\",\"value\":{\"kind\":\"Custom\",\"value\":\"home cinema\"},\"range\":{\"start\":40,\"end\":51},\"entity\":\"house_room\",\"slotName\":\"room\"}]}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2070,
        "y": 1000,
        "wires": [
            [
                "81198276.3ae09"
            ]
        ]
    },
    {
        "id": "c9bf95c3.767638",
        "type": "split",
        "z": "eaca0ac7.88c298",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2430,
        "y": 2040,
        "wires": [
            [
                "3e7fdadb.d21ff6"
            ]
        ]
    },
    {
        "id": "cbf7b855.d9f008",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Inject English",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2485.9999771118164,
        "y": 2102.000647544861,
        "wires": [
            [
                "edc64f30.4f54b"
            ]
        ]
    },
    {
        "id": "edc64f30.4f54b",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "msg EN",
        "func": "\nmsg.payload = {\n    text: \"Hello, this is a test message!\",\n    siteId: \"default\",\n    lang: \"en-UK\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2639.999969482422,
        "y": 2102.000159263611,
        "wires": [
            [
                "7b6e6f.5450619"
            ]
        ]
    },
    {
        "id": "5a96ca63.53e324",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "msg FR",
        "func": "msg.payload = {\n    text: \"Bonjour, ceci est un message de test!\",\n    siteId: \"default\",\n    lang: \"fr-FR\"\n};\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2639.286865234375,
        "y": 2146.369384765625,
        "wires": [
            [
                "7b6e6f.5450619"
            ]
        ]
    },
    {
        "id": "dfb67798.237a48",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Inject French",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2485.2868728637695,
        "y": 2146.369873046875,
        "wires": [
            [
                "5a96ca63.53e324"
            ]
        ]
    },
    {
        "id": "7c736995.566c98",
        "type": "function",
        "z": "eaca0ac7.88c298",
        "name": "msg DE",
        "func": "msg.payload = {\n    text: \"Hallo, das ist eine Testnachricht!\",\n    siteId: \"default\",\n    lang: \"de-DE\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2640.286865234375,
        "y": 2190.369384765625,
        "wires": [
            [
                "7b6e6f.5450619"
            ]
        ]
    },
    {
        "id": "f6721d4c.a0647",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "Inject German",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2486.2868728637695,
        "y": 2190.369873046875,
        "wires": [
            [
                "7c736995.566c98"
            ]
        ]
    },
    {
        "id": "1272a0b8.74362f",
        "type": "inject",
        "z": "eaca0ac7.88c298",
        "name": "",
        "topic": "",
        "payload": "{\"sessionId\":\"f4bfcec4-95e6-4258-bbae-090cddd189db\",\"customData\":null,\"siteId\":\"bedroom\",\"input\":\"activate\",\"asrTokens\":[[{\"value\":\"activate\",\"confidence\":1,\"range_start\":0,\"range_end\":8,\"time\":{\"start\":0,\"end\":1.89}}]],\"intent\":{\"intentName\":\"ProKNX:activateScenes\",\"probability\":0.81419545},\"slots\":[{\"confidence\":1,\"rawValue\":\"activate\",\"value\":{\"kind\":\"Custom\",\"value\":\"activate\"},\"range\":{\"start\":0,\"end\":8},\"entity\":\"scene_name\",\"slotName\":\"scene_device\"}]}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 2070,
        "y": 840,
        "wires": [
            [
                "97d28f0.f5fca7"
            ]
        ]
    },
    {
        "id": "c0e0d49d.594088",
        "type": "mqtt-broker",
        "z": "eaca0ac7.88c298",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": true,
        "keepalive": "60",
        "cleansession": true,
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": ""
    }
]
