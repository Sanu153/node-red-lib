[
    {
        "id": "f8db463f.066338",
        "type": "tab",
        "label": "Telegram Bot",
        "disabled": false,
        "info": ""
    },
    {
        "id": "5c0df4a1.37d4ec",
        "type": "telegrambot-command",
        "z": "f8db463f.066338",
        "bot": "4359293f.ca2928",
        "command": "/T.",
        "commandType": "re",
        "commandCase": false,
        "x": 140,
        "y": 425,
        "wires": [
            [
                "62b78522.1ffdec"
            ]
        ]
    },
    {
        "id": "e3010db4.0a32e",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "save",
        "rules": [
            {
                "t": "set",
                "p": "chat",
                "pt": "flow",
                "to": "telegram.chat",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "deviceID",
                "pt": "flow",
                "to": "payload.text",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 375,
        "y": 420,
        "wires": [
            [
                "dfb37749.0d1098"
            ]
        ]
    },
    {
        "id": "a5a5151e.70e398",
        "type": "telegrambot-switch",
        "z": "f8db463f.066338",
        "name": "+/-1°",
        "bot": "4359293f.ca2928",
        "chatId": "",
        "question": "",
        "answers": [
            "-1°",
            "+1°",
            "Skip"
        ],
        "outputs": 4,
        "autoAnswerCallback": true,
        "timeoutValue": "20",
        "timeoutUnits": "s",
        "x": 275,
        "y": 535,
        "wires": [
            [
                "ffabd8dd.cbbd08"
            ],
            [
                "adb179d2.c859a8"
            ],
            [
                "d8791843.cca6f8"
            ],
            [
                "47b1a9a3.6356c8"
            ]
        ],
        "outputLabels": [
            "-1°",
            "+1°",
            "Skip",
            ""
        ]
    },
    {
        "id": "d8791843.cca6f8",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "skip",
        "rules": [
            {
                "t": "set",
                "p": "telegram.chat",
                "pt": "msg",
                "to": "chat",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "ok, skipped!  /start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 500,
        "y": 525,
        "wires": [
            [
                "e84b5123.46e6",
                "c06abf73.f337c"
            ]
        ]
    },
    {
        "id": "47b1a9a3.6356c8",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "timeout",
        "rules": [
            {
                "t": "set",
                "p": "telegram.chat",
                "pt": "msg",
                "to": "chat",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "timeout     /start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 560,
        "wires": [
            [
                "c06abf73.f337c"
            ]
        ]
    },
    {
        "id": "e84b5123.46e6",
        "type": "telegrambot-notify",
        "z": "f8db463f.066338",
        "name": "",
        "bot": "4359293f.ca2928",
        "chatId": "flow.chat.id",
        "message": "",
        "parseMode": "",
        "x": 760,
        "y": 675,
        "wires": []
    },
    {
        "id": "3b9f7b94.cf49a4",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "Prep req.",
        "func": "var mergedmsg = {};\nvar msgDeviceInfo = flow.get(\"msgDeviceInfo\");\nfor(var key in msg) mergedmsg[key] = msg[key];\nfor(var key in msgDeviceInfo) mergedmsg[key] = msgDeviceInfo[key];\nmsg = mergedmsg;\n\nif (msg.cmd === undefined)\n    msg.cmd = {};\nmsg.cmd.cmd = msg.op;\nvar id = parseInt(flow.get(\"deviceID\").substring(2));\nmsg.items = [];\nmsg.items[0] = msg.allitems[id];\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nvar outputID = 0;\n//Prepare all HTTP requests for \"SET\" commands and put them in msg.url\nmsg.url = [];\nvar msg1 = msg;\nif (msg.cmd.value !== undefined) {\n    outputID = 1;    \n   \tfor (var i = 0; i < msg.items.length; i++) {\n   \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, msg.cmd.value];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n\t}\n}\nelse if (msg.cmd.cmd === \"getCurrent\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tmsg.url[i] = [msg.proServIP, msg.items[i].getCurrentUrl];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n\t}\n}\nelse if (msg.cmd.cmd === \"getTarget\") {\n    outputID = 1;\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tmsg.url[i] = [msg.proServIP, msg.items[i].getTargetUrl];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n\t}\t\n}\n\n\nif (msg.url[0] === undefined && msg.error === undefined) {\n    msg.error = {\n        text: \"Sorry I can not find this device\"\n    };\n}\n\nif(outputID===0)\n    return [msg,null];\nelse \n    return [null,msg];\n",
        "outputs": "2",
        "noerr": 0,
        "x": 715,
        "y": 390,
        "wires": [
            [
                "40e7f9b0.8bcd38"
            ],
            [
                "c2216816.4f5428"
            ]
        ],
        "outputLabels": [
            "current",
            "target"
        ]
    },
    {
        "id": "588982.8299368",
        "type": "http request",
        "z": "f8db463f.066338",
        "name": "Send URL",
        "method": "GET",
        "ret": "obj",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 840,
        "y": 580,
        "wires": [
            [
                "cb46f567.699948"
            ]
        ]
    },
    {
        "id": "9d179a31.adb7e8",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "Feedback",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nvar name = msg.items[0].name.replace(\"  \",\"\");\n\nif( msg.op != \"getCurrent\" && msg.op != \"getTarget\"  ){\n    var id = flow.get(\"deviceID\");\n    if (msg.payload.Result === true) {\n        var val = \"\";\n        msg.payload = name + \" is set to \" + msg.cmd.value + '°   ' + id + '   /start';\n    }\n    else if (msg.payload.Result === \"false\") {\n        msg.payload = \" The request failed.  /start\";\n    }\n    else {\n        msg.payload = \"The server is not responding  /start\";\n    }\n    msg.op = '';\n    return [msg, null];\n} else {\n    var txt = '';\n    msg.oldTargetTemp = msg.payload.Data[0].Value;\n    var currentTemp = precisionRound(flow.get(\"currentTemp\"),1);\n    txt = name + \" is set to \" + precisionRound(msg.payload.Data[0].Value,1) + \"°. The current temp is \" + currentTemp + \"°\";\n    msg.op = '';\n    msg.payload = txt;\n    return [null, msg]\n}\n\n",
        "outputs": "2",
        "noerr": 0,
        "x": 111,
        "y": 685,
        "wires": [
            [
                "e84b5123.46e6"
            ],
            [
                "a5a5151e.70e398",
                "27003bf2.35f284"
            ]
        ],
        "outputLabels": [
            "get",
            "Temp"
        ]
    },
    {
        "id": "adb179d2.c859a8",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "+1",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "msg.oldTargetTemp+1",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 500,
        "y": 490,
        "wires": [
            [
                "e7f6bb55.d03118"
            ]
        ]
    },
    {
        "id": "dfb37749.0d1098",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "getCurrent",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "getCurrent",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 520,
        "y": 420,
        "wires": [
            [
                "3b9f7b94.cf49a4"
            ]
        ]
    },
    {
        "id": "5a879407.61466c",
        "type": "link in",
        "z": "f8db463f.066338",
        "name": "Send URL IN",
        "links": [
            "cb46f567.699948"
        ],
        "x": 75,
        "y": 640,
        "wires": [
            [
                "9d179a31.adb7e8"
            ]
        ]
    },
    {
        "id": "c2216816.4f5428",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "url -> payload",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 440,
        "wires": [
            [
                "9d97623a.7e088"
            ]
        ]
    },
    {
        "id": "9d97623a.7e088",
        "type": "split",
        "z": "f8db463f.066338",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 795,
        "y": 485,
        "wires": [
            [
                "a64ac1f2.1bf12"
            ]
        ]
    },
    {
        "id": "a64ac1f2.1bf12",
        "type": "delay",
        "z": "f8db463f.066338",
        "name": ".05s",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 805,
        "y": 530,
        "wires": [
            [
                "588982.8299368"
            ]
        ]
    },
    {
        "id": "9e29896c.866588",
        "type": "telegrambot-payload",
        "z": "f8db463f.066338",
        "name": "",
        "bot": "4359293f.ca2928",
        "chatId": "",
        "sendMethod": "sendMessage",
        "payload": "",
        "x": 565,
        "y": 270,
        "wires": [
            []
        ]
    },
    {
        "id": "e6ec87d8.58bc28",
        "type": "telegrambot-command",
        "z": "f8db463f.066338",
        "bot": "4359293f.ca2928",
        "command": "/help",
        "commandType": "str",
        "commandCase": false,
        "x": 140,
        "y": 95,
        "wires": [
            [
                "ffa4ad9a.15928"
            ]
        ]
    },
    {
        "id": "3b273bd8.c5cc64",
        "type": "comment",
        "z": "f8db463f.066338",
        "name": "Handler for Help & Start cmd",
        "info": "",
        "x": 170,
        "y": 54,
        "wires": []
    },
    {
        "id": "39909b14.4ee584",
        "type": "telegrambot-command",
        "z": "f8db463f.066338",
        "bot": "4359293f.ca2928",
        "command": "help",
        "commandType": "str",
        "commandCase": false,
        "x": 138,
        "y": 144,
        "wires": [
            [
                "ffa4ad9a.15928"
            ]
        ]
    },
    {
        "id": "dd16313f.f6927",
        "type": "telegrambot-command",
        "z": "f8db463f.066338",
        "bot": "4359293f.ca2928",
        "command": "/start",
        "commandType": "str",
        "commandCase": false,
        "x": 139,
        "y": 191,
        "wires": [
            [
                "ffa4ad9a.15928"
            ]
        ]
    },
    {
        "id": "17da831e.c7e29d",
        "type": "http request",
        "z": "f8db463f.066338",
        "name": "GET devices",
        "method": "GET",
        "ret": "txt",
        "url": "http://localhost:3000/rest/alexa/skill/items",
        "tls": "",
        "x": 410,
        "y": 211,
        "wires": [
            [
                "b66eed5d.0d0a4"
            ]
        ]
    },
    {
        "id": "6acb9c62.2445d4",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "save",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "proServIP",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 834,
        "y": 143,
        "wires": [
            [
                "17da831e.c7e29d"
            ]
        ]
    },
    {
        "id": "ffa4ad9a.15928",
        "type": "exec",
        "z": "f8db463f.066338",
        "command": "sudo ifconfig | grep 'inet' | grep '255.255.255.0' | cut -f2 -d: | awk '{print $1}'",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": true,
        "name": "GET local IP",
        "x": 379,
        "y": 142,
        "wires": [
            [
                "9d4b05e9.7f01c8"
            ],
            [],
            []
        ]
    },
    {
        "id": "9d4b05e9.7f01c8",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "Trim",
        "func": "msg.payload = msg.payload.trim();\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 525,
        "y": 143,
        "wires": [
            [
                "3c006a6.630c696"
            ]
        ]
    },
    {
        "id": "3c006a6.630c696",
        "type": "http request",
        "z": "f8db463f.066338",
        "name": "GET ProServIP",
        "method": "GET",
        "ret": "txt",
        "url": "http://{{{payload}}}:3000/proservip",
        "tls": "",
        "x": 681,
        "y": 143,
        "wires": [
            [
                "6acb9c62.2445d4"
            ]
        ]
    },
    {
        "id": "b66eed5d.0d0a4",
        "type": "json",
        "z": "f8db463f.066338",
        "name": "",
        "pretty": false,
        "x": 552,
        "y": 210,
        "wires": [
            [
                "80af19a3.e6cd78"
            ]
        ]
    },
    {
        "id": "80af19a3.e6cd78",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "List by Type",
        "func": "function findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\nfunction findHeatersByKey(array, key, value) {\n    msg.payload.heaters = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.heaters[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfindSwitchByKey(msg.payload, 'type', 'lights');\nfindDimmerByKey(msg.payload, 'type', 'dimmers');\nmsg.lights = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\n\nfindHeatersByKey(msg.payload, 'type', 'heating');\nmsg.heaters = msg.payload.heaters;\n\nmsg.allitems = msg.payload;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 210,
        "wires": [
            [
                "b82f621e.db691"
            ]
        ]
    },
    {
        "id": "b82f621e.db691",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "build tg payload",
        "func": "function pad(n, width, z) {\n  z = z || '0';\n  n = n + '';\n  return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;\n}\n\nmsg.lights.sort(function(a, b) {\n   return a.zone.localeCompare(b.zone);\n});\nmsg.heaters.sort(function(a, b) {\n   return a.zone.localeCompare(b.zone);\n});\nmsg.allitems.sort(function(a, b) {\n   return a.zone.localeCompare(b.zone);\n});\nflow.set(\"msgDeviceInfo\", msg); // save for later use\n\n\nvar text = '';\nvar curZone = '';\nvar header = '';\n\nfor (var i = 0; i < msg.allitems.length; i++) {\n    if(curZone != msg.allitems[i].zone){\n        curZone = msg.allitems[i].zone;\n        header = '*' + curZone + '*\\n';\n    }\n    if(msg.lights.indexOf(msg.allitems[i])!=-1){\n        if(header.length>0){\n            text += header;\n            header = \"\";\n        }\n        text += msg.allitems[i].object + ': [/L' + pad(i,3) + ']\\n';\n    } else if(msg.heaters.indexOf(msg.allitems[i])!=-1){\n        if(header.length>0){\n            text += header;\n            header = \"\";\n        }\n        text += msg.allitems[i].object + ': [/T' + pad(i,3) + ']\\n';\n    }  \n}\n\nmsg.payload = {\n    \"text\": text,\n    \"parse_mode\": \"Markdown\"\n}\nreturn msg;",
        "outputs": "1",
        "noerr": 0,
        "x": 860,
        "y": 210,
        "wires": [
            [
                "9e29896c.866588",
                "4f1a1d4a.fa1084"
            ]
        ]
    },
    {
        "id": "652a1a02.d734b4",
        "type": "comment",
        "z": "f8db463f.066338",
        "name": "Handler for /T command : Temperature control",
        "info": "",
        "x": 220,
        "y": 340,
        "wires": []
    },
    {
        "id": "27003bf2.35f284",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "busy!",
        "func": "flow.set(\"isWaiting\", true);",
        "outputs": "0",
        "noerr": 0,
        "x": 280,
        "y": 700,
        "wires": []
    },
    {
        "id": "b8a166e9.5afb58",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "busy",
        "rules": [
            {
                "t": "set",
                "p": "telegram.chat",
                "pt": "msg",
                "to": "chat",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "Busy, waiting for reply!",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 495,
        "y": 595,
        "wires": [
            [
                "e84b5123.46e6"
            ]
        ]
    },
    {
        "id": "c06abf73.f337c",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "not busy",
        "func": "flow.set(\"isWaiting\", false);\n",
        "outputs": "0",
        "noerr": 0,
        "x": 735,
        "y": 625,
        "wires": []
    },
    {
        "id": "e7f6bb55.d03118",
        "type": "link out",
        "z": "f8db463f.066338",
        "name": "set OUT",
        "links": [
            "89556f19.b908b"
        ],
        "x": 610,
        "y": 480,
        "wires": []
    },
    {
        "id": "89556f19.b908b",
        "type": "link in",
        "z": "f8db463f.066338",
        "name": "set IN",
        "links": [
            "e7f6bb55.d03118"
        ],
        "x": 620,
        "y": 530,
        "wires": [
            [
                "3b9f7b94.cf49a4",
                "c06abf73.f337c"
            ]
        ]
    },
    {
        "id": "62b78522.1ffdec",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "busy?",
        "func": "var isWaiting = flow.get(\"isWaiting\");\nif(isWaiting===true)\n    return [null, msg];\nelse\n    return [msg, null];",
        "outputs": "2",
        "noerr": 0,
        "x": 270,
        "y": 470,
        "wires": [
            [
                "e3010db4.0a32e"
            ],
            [
                "b8a166e9.5afb58"
            ]
        ],
        "outputLabels": [
            "continue",
            "iswaiting"
        ]
    },
    {
        "id": "131a208a.4d315f",
        "type": "telegrambot-command",
        "z": "f8db463f.066338",
        "bot": "4359293f.ca2928",
        "command": "/L.",
        "commandType": "re",
        "commandCase": false,
        "x": 135,
        "y": 865,
        "wires": [
            [
                "6444233a.7f001c"
            ]
        ]
    },
    {
        "id": "6f29eaed.e912f4",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "save",
        "rules": [
            {
                "t": "set",
                "p": "chat",
                "pt": "flow",
                "to": "telegram.chat",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "deviceID",
                "pt": "flow",
                "to": "payload.text",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 865,
        "wires": [
            [
                "3371afb6.82a8a"
            ]
        ]
    },
    {
        "id": "8ee91255.52a95",
        "type": "telegrambot-switch",
        "z": "f8db463f.066338",
        "name": "ON/OFF",
        "bot": "4359293f.ca2928",
        "chatId": "",
        "question": "",
        "answers": [
            "Turn OFF",
            "Turn ON",
            "Skip"
        ],
        "outputs": 4,
        "autoAnswerCallback": true,
        "timeoutValue": "20",
        "timeoutUnits": "s",
        "x": 270,
        "y": 985,
        "wires": [
            [
                "749a0639.826b18"
            ],
            [
                "88b8527b.6e9cf"
            ],
            [
                "eca02aa6.db88c8"
            ],
            [
                "ff19a742.9ba778"
            ]
        ],
        "outputLabels": [
            "Off",
            "On",
            "Skip",
            ""
        ]
    },
    {
        "id": "eca02aa6.db88c8",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "skip",
        "rules": [
            {
                "t": "set",
                "p": "telegram.chat",
                "pt": "msg",
                "to": "chat",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "ok, skipped!  /start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 495,
        "y": 1180,
        "wires": [
            [
                "d20f847a.e85fb8",
                "13f9654e.e5687b"
            ]
        ]
    },
    {
        "id": "ff19a742.9ba778",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "timeout",
        "rules": [
            {
                "t": "set",
                "p": "telegram.chat",
                "pt": "msg",
                "to": "chat",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "timeout     /start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 1220,
        "wires": [
            [
                "13f9654e.e5687b"
            ]
        ]
    },
    {
        "id": "d20f847a.e85fb8",
        "type": "telegrambot-notify",
        "z": "f8db463f.066338",
        "name": "",
        "bot": "4359293f.ca2928",
        "chatId": "flow.chat.id",
        "message": "",
        "parseMode": "",
        "x": 765,
        "y": 1285,
        "wires": []
    },
    {
        "id": "74396940.4b0958",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "Prep req.",
        "func": "var mergedmsg = {};\nvar msgDeviceInfo = flow.get(\"msgDeviceInfo\");\nfor(var key in msg) mergedmsg[key] = msg[key];\nfor(var key in msgDeviceInfo) mergedmsg[key] = msgDeviceInfo[key];\nmsg = mergedmsg;\n\nif (msg.cmd === undefined)\n    msg.cmd = {};\nmsg.cmd.cmd = msg.op;\nvar id = parseInt(flow.get(\"deviceID\").substring(2));\nmsg.items = [];\nmsg.items[0] = msg.allitems[id];\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\n\n//Prepare all HTTP requests for \"SET\" commands and put them in msg.url\nmsg.url = [];\nif (msg.cmd.value !== undefined) {\n   \tfor (var i = 0; i < msg.items.length; i++) {\n   \t\tif (msg.items[i].type === \"dimmers\") {\n   \t\t\tvar val = msg.cmd.value*2.55;\n   \t\t\tval = precisionRound(val, 1);\n   \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n   \t\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n   \t\t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n   \t\t} \n   \t\telse if (msg.cmd.value > 0) {\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n   \t\t}\n   \t\telse {\n\t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n   \t\t}\n\t}\n}\nelse if (msg.cmd.cmd === \"get\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tmsg.url[i] = [msg.proServIP, msg.items[i].getCurrentUrl];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n\t}\n}\nelse if (msg.cmd.cmd === \"on\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n\t}\n}\nelse if (msg.cmd.cmd === \"off\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n\t}\n} else if (msg.cmd.cmd !== \"on\" && msg.cmd.cmd !== \"off\" && msg.cmd.cmd !== \"increase\" && msg.cmd.cmd !== \"decrease\") {\n   msg.error = {\n        text: \"Sorry I did not understand your command\",\n        siteId: msg.cmd.siteId\n    }; \n}\n\nif (msg.url[0] === undefined && msg.error === undefined) {\n    msg.error = {\n        text: \"Sorry I can not find this device\"\n    };\n}\n//msg.payload = msg.url;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 705,
        "y": 860,
        "wires": [
            [
                "7e3a2684.0de168"
            ]
        ]
    },
    {
        "id": "302c08a4.2e1858",
        "type": "http request",
        "z": "f8db463f.066338",
        "name": "Send URL",
        "method": "GET",
        "ret": "obj",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 830,
        "y": 1050,
        "wires": [
            [
                "ac350385.db1da"
            ]
        ]
    },
    {
        "id": "f3eacc94.dcd55",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "Feedback",
        "func": "var name = msg.items[0].name.replace(\"  \",\"\");\n\nif( msg.op != \"get\" ){\n    var id = flow.get(\"deviceID\");\n    if (msg.payload.Result === true) {\n        var val = \"\";\n        if(msg.op === \"set\")\n            msg.payload = name + \" is set to \" + msg.cmd.value + '%   ' + id + '   /start';\n        else        \n            msg.payload = name + \" is \" + msg.op.toUpperCase() + '   ' + id + '   /start';\n    }\n    else if (msg.payload.Result === \"false\") {\n        msg.payload = \" The request failed.  /start\";\n    }\n    else {\n        msg.payload = \"The server is not responding  /start\";\n    }\n    msg.op = '';\n    return [msg, null, null];\n} else {\n    var txt = '';\n    var isDimmer = false;\n    if(msg.payload.Data[0].Value === true){\n        txt = name + \" is ON\";\n    }\n    else if(msg.payload.Data[0].Value === false){\n        txt = name + \" is OFF\";\n    }\n    else {\n        var val = Math.round(msg.payload.Data[0].Value*100/255);\n        txt = name + \" is set to \" + val + \" %\";\n        isDimmer = true;\n    }\n    msg.op = '';\n    msg.payload = txt;\n    if(isDimmer === true){\n        return [null, null, msg]\n    }\n    else {\n        return [null, msg, null]\n    }\n}\n\n",
        "outputs": "3",
        "noerr": 0,
        "x": 116,
        "y": 1300,
        "wires": [
            [
                "d20f847a.e85fb8"
            ],
            [
                "8ee91255.52a95",
                "33cdd455.aaceec"
            ],
            [
                "bf90c405.b12a28",
                "33cdd455.aaceec"
            ]
        ],
        "outputLabels": [
            "get",
            "ON/OFF",
            "Dimmer"
        ]
    },
    {
        "id": "88b8527b.6e9cf",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "on",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "on",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 495,
        "y": 899,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "749a0639.826b18",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "off",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "off",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 496,
        "y": 939,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "3371afb6.82a8a",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "get",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "get",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 493,
        "y": 860,
        "wires": [
            [
                "74396940.4b0958"
            ]
        ]
    },
    {
        "id": "bf90c405.b12a28",
        "type": "telegrambot-switch",
        "z": "f8db463f.066338",
        "name": "Dimmer",
        "bot": "4359293f.ca2928",
        "chatId": "",
        "question": "",
        "answers": [
            "0%",
            "25%",
            "50%",
            "75%",
            "100%",
            "Skip"
        ],
        "outputs": 7,
        "autoAnswerCallback": true,
        "timeoutValue": "20",
        "timeoutUnits": "s",
        "x": 271,
        "y": 1107,
        "wires": [
            [
                "c0042d57.6bfd2"
            ],
            [
                "6ea688bf.a39d18"
            ],
            [
                "f6de925a.50a83"
            ],
            [
                "164b1fda.11d08"
            ],
            [
                "b96e60f3.64601"
            ],
            [
                "eca02aa6.db88c8"
            ],
            [
                "ff19a742.9ba778"
            ]
        ],
        "outputLabels": [
            "0%",
            "25%",
            "50%",
            "75%",
            "100%",
            "Skip",
            ""
        ]
    },
    {
        "id": "6ea688bf.a39d18",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "25%",
        "rules": [
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "25",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 494,
        "y": 1017,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "ac350385.db1da",
        "type": "link out",
        "z": "f8db463f.066338",
        "name": "Send URL OUT",
        "links": [
            "69ad7e6d.1d2e"
        ],
        "x": 860,
        "y": 1085,
        "wires": []
    },
    {
        "id": "69ad7e6d.1d2e",
        "type": "link in",
        "z": "f8db463f.066338",
        "name": "Send URL IN",
        "links": [
            "ac350385.db1da"
        ],
        "x": 80,
        "y": 1225,
        "wires": [
            [
                "f3eacc94.dcd55"
            ]
        ]
    },
    {
        "id": "7e3a2684.0de168",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "url -> payload",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 770,
        "y": 910,
        "wires": [
            [
                "eb4bac42.2f1d5"
            ]
        ]
    },
    {
        "id": "eb4bac42.2f1d5",
        "type": "split",
        "z": "f8db463f.066338",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 785,
        "y": 955,
        "wires": [
            [
                "c3e3c4c8.a7b5c8"
            ]
        ]
    },
    {
        "id": "c3e3c4c8.a7b5c8",
        "type": "delay",
        "z": "f8db463f.066338",
        "name": "delay",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 800,
        "y": 1000,
        "wires": [
            [
                "302c08a4.2e1858"
            ]
        ]
    },
    {
        "id": "c0042d57.6bfd2",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "0%",
        "rules": [
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 496,
        "y": 977,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "164b1fda.11d08",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "75%",
        "rules": [
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "75",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 493,
        "y": 1099,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "b96e60f3.64601",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "100%",
        "rules": [
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "100",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 495,
        "y": 1140,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "f6de925a.50a83",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "50%",
        "rules": [
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "50",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 496,
        "y": 1058,
        "wires": [
            [
                "c0615465.9cbeb8"
            ]
        ]
    },
    {
        "id": "876ccd4c.4f829",
        "type": "comment",
        "z": "f8db463f.066338",
        "name": "Handler for /L command : Lights & Dimmers",
        "info": "",
        "x": 214,
        "y": 823,
        "wires": []
    },
    {
        "id": "33cdd455.aaceec",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "busy!",
        "func": "flow.set(\"isWaiting\", true);",
        "outputs": "0",
        "noerr": 0,
        "x": 285,
        "y": 1315,
        "wires": []
    },
    {
        "id": "a2b5abed.b59218",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "busy",
        "rules": [
            {
                "t": "set",
                "p": "telegram.chat",
                "pt": "msg",
                "to": "chat",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "Busy, waiting for reply!",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 485,
        "y": 1260,
        "wires": [
            [
                "d20f847a.e85fb8"
            ]
        ]
    },
    {
        "id": "13f9654e.e5687b",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "not busy",
        "func": "flow.set(\"isWaiting\", false);\n",
        "outputs": "0",
        "noerr": 0,
        "x": 730,
        "y": 1120,
        "wires": []
    },
    {
        "id": "c0615465.9cbeb8",
        "type": "link out",
        "z": "f8db463f.066338",
        "name": "set OUT",
        "links": [
            "c4faecd2.3b3f4"
        ],
        "x": 610,
        "y": 1015,
        "wires": []
    },
    {
        "id": "c4faecd2.3b3f4",
        "type": "link in",
        "z": "f8db463f.066338",
        "name": "set IN",
        "links": [
            "c0615465.9cbeb8"
        ],
        "x": 610,
        "y": 965,
        "wires": [
            [
                "74396940.4b0958",
                "13f9654e.e5687b"
            ]
        ]
    },
    {
        "id": "6444233a.7f001c",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "busy?",
        "func": "var isWaiting = flow.get(\"isWaiting\");\nif(isWaiting===true)\n    return [null, msg];\nelse\n    return [msg, null];",
        "outputs": "2",
        "noerr": 0,
        "x": 270,
        "y": 925,
        "wires": [
            [
                "6f29eaed.e912f4"
            ],
            [
                "a2b5abed.b59218"
            ]
        ],
        "outputLabels": [
            "continue",
            "iswaiting"
        ]
    },
    {
        "id": "4f1a1d4a.fa1084",
        "type": "debug",
        "z": "f8db463f.066338",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "true",
        "x": 960,
        "y": 260,
        "wires": []
    },
    {
        "id": "cb46f567.699948",
        "type": "link out",
        "z": "f8db463f.066338",
        "name": "Send URL OUT",
        "links": [
            "5a879407.61466c"
        ],
        "x": 900,
        "y": 625,
        "wires": []
    },
    {
        "id": "91935285.c54cb",
        "type": "http request",
        "z": "f8db463f.066338",
        "name": "Send URL",
        "method": "GET",
        "ret": "obj",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 1025,
        "y": 525,
        "wires": [
            [
                "e8c1bfee.31046"
            ]
        ]
    },
    {
        "id": "40e7f9b0.8bcd38",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "url -> payload",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 965,
        "y": 385,
        "wires": [
            [
                "f5324071.a059b"
            ]
        ]
    },
    {
        "id": "f5324071.a059b",
        "type": "split",
        "z": "f8db463f.066338",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 980,
        "y": 430,
        "wires": [
            [
                "d12f9c31.775e5"
            ]
        ]
    },
    {
        "id": "d12f9c31.775e5",
        "type": "delay",
        "z": "f8db463f.066338",
        "name": ".05s",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 990,
        "y": 475,
        "wires": [
            [
                "91935285.c54cb"
            ]
        ]
    },
    {
        "id": "ffabd8dd.cbbd08",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "-1",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "set",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "cmd.value",
                "pt": "msg",
                "to": "msg.oldTargetTemp-1",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 500,
        "y": 455,
        "wires": [
            [
                "e7f6bb55.d03118"
            ]
        ]
    },
    {
        "id": "e8c1bfee.31046",
        "type": "function",
        "z": "f8db463f.066338",
        "name": "Save cur temp",
        "func": "flow.set(\"currentTemp\", msg.payload.Data[0].Value);\nreturn msg;\n\n\n",
        "outputs": "1",
        "noerr": 0,
        "x": 1080,
        "y": 570,
        "wires": [
            [
                "f8fef309.7bf2c"
            ]
        ]
    },
    {
        "id": "c386091f.603aa8",
        "type": "change",
        "z": "f8db463f.066338",
        "name": "getTarget",
        "rules": [
            {
                "t": "set",
                "p": "op",
                "pt": "msg",
                "to": "getTarget",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 510,
        "y": 385,
        "wires": [
            [
                "3b9f7b94.cf49a4"
            ]
        ]
    },
    {
        "id": "f8fef309.7bf2c",
        "type": "link out",
        "z": "f8db463f.066338",
        "name": "Cur temp OUT",
        "links": [
            "be34fb65.f76d78"
        ],
        "x": 1120,
        "y": 620,
        "wires": []
    },
    {
        "id": "be34fb65.f76d78",
        "type": "link in",
        "z": "f8db463f.066338",
        "name": "Cur temp IN",
        "links": [
            "f8fef309.7bf2c"
        ],
        "x": 410,
        "y": 385,
        "wires": [
            [
                "c386091f.603aa8"
            ]
        ]
    },
    {
        "id": "4359293f.ca2928",
        "type": "telegrambot-config",
        "z": "f8db463f.066338",
        "botname": "proknx_bot",
        "usernames": "",
        "chatIds": "",
        "pollInterval": "300"
    }
]