[
    {
        "id": "66510db6.2b76b4",
        "type": "tab",
        "label": "Auto SNIPS V3"
    },
    {
        "id": "dd84dd95.a6ff8",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": true,
        "x": 830,
        "y": 160,
        "wires": [
            [
                "c7d37e1d.97bd3"
            ]
        ]
    },
    {
        "id": "da482acb.889ff8",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "=================================SNIPS INTENTS INPUT================================",
        "info": "",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "ffa7f398.f480f",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "endSession",
        "func": "msg.payload = {\n    \"sessionId\": msg.payload.sessionId    \n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 750,
        "y": 300,
        "wires": [
            [
                "94f2d122.43468"
            ]
        ]
    },
    {
        "id": "94f2d122.43468",
        "type": "mqtt out",
        "z": "66510db6.2b76b4",
        "name": "",
        "topic": "hermes/dialogueManager/endSession",
        "qos": "",
        "retain": "",
        "broker": "96de078e.0139e8",
        "x": 988.9999580383301,
        "y": 299.9999942779541,
        "wires": []
    },
    {
        "id": "3f040b54.97d394",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "",
        "pauseType": "delay",
        "timeout": "250",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 590,
        "y": 300,
        "wires": [
            [
                "ffa7f398.f480f"
            ]
        ]
    },
    {
        "id": "1fb215f6.bc6d9a",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "===================================================================================SNIPS CORE FUNCTIONS===================================================================================",
        "info": "",
        "x": 790,
        "y": 20,
        "wires": []
    },
    {
        "id": "2193cbba.c883e4",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "=================================================================================HOME AUTOMATION INTENTS===================================================================================",
        "info": "",
        "x": 2420,
        "y": 20,
        "wires": []
    },
    {
        "id": "989b8748.63cd28",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "===============================CLOSE SNIPS SESSION=================================",
        "info": "",
        "x": 790,
        "y": 240,
        "wires": []
    },
    {
        "id": "e443f6e.2335a08",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "TARGET ITEMS IN",
        "links": [
            "2a4143f9.e8a89c",
            "bacd1985.7dbcc8",
            "5874c56c.fbfe3c"
        ],
        "x": 1115,
        "y": 160,
        "wires": []
    },
    {
        "id": "bacd1985.7dbcc8",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "Session OUT",
        "links": [
            "e443f6e.2335a08"
        ],
        "x": 475,
        "y": 300,
        "wires": [
            [
                "3f040b54.97d394"
            ]
        ]
    },
    {
        "id": "837ccf37.508be",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "GET devices",
        "method": "GET",
        "ret": "txt",
        "url": "http://localhost:3000/rest/alexa/skill/items",
        "tls": "",
        "x": 930,
        "y": 520,
        "wires": [
            [
                "aa74904c.b910c"
            ]
        ]
    },
    {
        "id": "aa74904c.b910c",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 1070,
        "y": 520,
        "wires": [
            [
                "eb7c4fff.49a1b"
            ]
        ]
    },
    {
        "id": "e1d0067d.9cce48",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "List_devices",
        "func": "flow.set(\"msgDeviceList\", msg.payload); // save for later use\nflow.set(\"msgProServIP\", msg.proServIP); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "e37e2339.011eb",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "GET ProServIP",
        "method": "GET",
        "ret": "txt",
        "url": "http://{{{payload}}}:3000/proservip",
        "tls": "",
        "x": 560,
        "y": 520,
        "wires": [
            [
                "224f5848.8ebf88"
            ]
        ]
    },
    {
        "id": "224f5848.8ebf88",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "proServIP",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 520,
        "wires": [
            [
                "837ccf37.508be"
            ]
        ]
    },
    {
        "id": "8ec34fe0.26ebc",
        "type": "exec",
        "z": "66510db6.2b76b4",
        "command": "sudo ip addr show eth0 | grep \"inet\\b\" | awk '{print $2}' | cut -d/ -f1",
        "addpay": false,
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "oldrc": true,
        "name": "GET local IP",
        "x": 890,
        "y": 460,
        "wires": [
            [
                "38f4baaf.94dc06"
            ],
            [],
            []
        ]
    },
    {
        "id": "38f4baaf.94dc06",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Trim answer",
        "func": "msg.payload = msg.payload.trim();\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1050,
        "y": 460,
        "wires": [
            [
                "e37e2339.011eb"
            ]
        ]
    },
    {
        "id": "3078e31b.06506c",
        "type": "inject",
        "z": "66510db6.2b76b4",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 540,
        "y": 460,
        "wires": [
            [
                "1b241ce0.df5c83"
            ]
        ]
    },
    {
        "id": "71fbcb1b.487264",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "===============================GET LIST OF DEVICES==================================",
        "info": "",
        "x": 790,
        "y": 400,
        "wires": []
    },
    {
        "id": "2a4143f9.e8a89c",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "TARGET ITEMS OUT",
        "links": [
            "e443f6e.2335a08"
        ],
        "x": 1815,
        "y": 440,
        "wires": [
            [
                "d6fb4c68.15b43"
            ]
        ]
    },
    {
        "id": "c7d37e1d.97bd3",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Array_intent",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\nfunction precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nfunction findObjectByKey(array, key, value) {\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            return array[i];\n        }\n    }\n    return null;\n}\n\nvar rawCmd = findObjectByKey(msg.payload.slots, 'slotName', 'cmd');\nvar rawRoom = findObjectByKey(msg.payload.slots, 'slotName', 'room');\nvar rawDevice = findObjectByKey(msg.payload.slots, 'slotName', 'device');\nvar rawAll = findObjectByKey(msg.payload.slots, 'slotName', 'all');\nvar rawPercent = findObjectByKey(msg.payload.slots, 'slotName', 'percent');\nvar rawTemp = findObjectByKey(msg.payload.slots, 'slotName', 'temp');\nvar rawQuery = findObjectByKey(msg.payload.slots, 'slotName', 'query');\nvar rawType = findObjectByKey(msg.payload.slots, 'slotName', 'type');\n\nmsg.cmd = [];\nif (rawCmd !== null) { \n    msg.cmd.cmd = rawCmd.value.value.toLowerCase().sansAccent();\n} else {\n    msg.cmd.cmd = \"\";\n}\nif (rawRoom !== null) {\n\tmsg.cmd.room = rawRoom.value.value.toLowerCase().sansAccent();\n} else if (rawAll === null) {\n    msg.cmd.room = msg.payload.siteId;\n}\nif (rawDevice !== null) {\n\tmsg.cmd.device = rawDevice.value.value.toLowerCase().sansAccent();\n}\nif (rawAll !== null) {\n\tmsg.cmd.all = rawAll.value.value;\n}\nif (rawPercent !== null) {\n\tmsg.cmd.value = precisionRound(rawPercent.value.value, 1);\n}\nif (rawTemp !== null) {\n\tmsg.cmd.value = precisionRound(rawTemp.value.value, 1);\n}\nif (rawQuery !== null) {\n\tmsg.cmd.query = rawQuery.value.value;\n}\nif (rawType !== null) {\n    if (rawType.value.value.toLowerCase().sansAccent() === \"heating\" || rawType.value.value.toLowerCase().sansAccent() === \"heizung\" || rawType.value.value.toLowerCase().sansAccent() === \"chauffage\") {\n        msg.cmd.type = \"heating\";\n    } else if (rawType.value.value.toLowerCase().sansAccent() === \"lights\" || rawType.value.value.toLowerCase().sansAccent() === \"licht\" || rawType.value.value.toLowerCase().sansAccent() === \"lumieres\") {\n        msg.cmd.type = \"lights\";\n    } else if (rawType.value.value.toLowerCase().sansAccent() === \"blinds\" || rawType.value.value.toLowerCase().sansAccent() === \"fensterladen\" || rawType.value.value.toLowerCase().sansAccent() === \"volets\") {\n        msg.cmd.type = \"blinds\";\n    } else if (rawType.value.value.toLowerCase().sansAccent() === \"scenes\" || rawType.value.value.toLowerCase().sansAccent() === \"szene\") {\n        msg.cmd.type = \"scenes\";\n    }\n}\nmsg.cmd.siteId = msg.payload.siteId;\n\nmsg.deviceList = flow.get(\"msgDeviceList\");\nmsg.cmd.lang = flow.get(\"msgLang\");\nmsg.test_lights = flow.get(\"msg_test_lights\");\nmsg.test_dimmers = flow.get(\"msg_test_dimmers\");\nmsg.test_heating = flow.get(\"msg_test_heating\");\nmsg.test_blinds = flow.get(\"msg_test_blinds\");\nmsg.test_scenes = flow.get(\"msg_test_scenes\");\nmsg.test_aux = flow.get(\"msg_test_aux\");\nmsg.commandCat = flow.get(\"msgCommandCat\");\nmsg.proServIP = flow.get(\"msgProServIP\");\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 990,
        "y": 160,
        "wires": [
            [
                "e443f6e.2335a08"
            ]
        ]
    },
    {
        "id": "6a500388.ed60bc",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "=============================GET CURRENT LANGUAGE================================",
        "info": "",
        "x": 790,
        "y": 680,
        "wires": []
    },
    {
        "id": "eae88297.1e42b",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Check supported",
        "func": "function findCommandByType(array, cmd) {\n    for (var i = 0; i < array.length; i++) {\n        if (array[i] == cmd) {\n            msg.supported = true;\n            break;\n        } else {\n            msg.supported = false;\n        }\n    }\n\n    return null;\n}\n\nvar cptok=0;\nvar cpter=0;\nmsg.itemsok=[];\nmsg.itemser=[];\nfor (var i = 0; i < msg.items.length; i++) {\n    if (msg.items[i].type === \"lights\") {findCommandByType(msg.test_lights, msg.cmd.cmd);}\n    else if (msg.items[i].type === \"dimmers\") {findCommandByType(msg.test_dimmers, msg.cmd.cmd);}\n    else if (msg.items[i].type === \"heating\") {findCommandByType(msg.test_heating, msg.cmd.cmd);}\n    else if (msg.items[i].type === \"blinds\") {findCommandByType(msg.test_blinds, msg.cmd.cmd);}\n    else if (msg.items[i].type === \"scenes\") {findCommandByType(msg.test_scenes, msg.cmd.cmd);}\n    else if (msg.items[i].type === \"aux\") {findCommandByType(msg.test_aux, msg.cmd.cmd);}\n    if(msg.supported === true) {\n        if (msg.cmd.type === \"aux\" && msg.cmd.cmd === \"off\" && msg.items[i].setOffUrl === undefined) {\n            msg.itemser[cpter]=msg.items[i];\n            cpter++;\n        } else {\n            msg.itemsok[cptok]=msg.items[i];\n            cptok++;\n        }\n    } else {\n        msg.itemser[cpter]=msg.items[i];\n        cpter++;\n    }\n}\n\nmsg.items = msg.itemsok;\n\nif (msg.itemser.length > 0 && msg.itemsok.length === 0) {\n    if (msg.itemser.length > 1) {\n        if (msg.cmd.lang === \"de\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" und \";\n            text3 = msg.itemser.length-1;\n            text4 = \"  unterstütze das nicht\";\n            texttabl = [text1, text2, text3, text4];\n            var text = \"\".concat(...texttabl);            \n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" et \";\n            text3 = msg.itemser.length-1;\n            text4 = \" autres appareils ne supportent pas cette commande\";\n            texttabl = [text1, text2, text3, text4];\n            var text = \"\".concat(...texttabl);            \n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"fr-FR\"\n            };\n        } else {\n            text1 = msg.itemser[0].name;\n            text2 = \" and \";\n            text3 = msg.itemser.length-1;\n            text4 = \" other devices do not support this command\";\n            texttabl = [text1, text2, text3, text4];\n            var text = \"\".concat(...texttabl);            \n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"en-EN\"\n            };\n        }\n    } else {\n        if (msg.cmd.lang === \"de\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" unterstütze das nicht\";\n            texttabl = [text1, text2];\n            var text = \"\".concat(...texttabl);\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" ne supporte pas cette commande\";\n            texttabl = [text1, text2];\n            var text = \"\".concat(...texttabl);\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"fr-FR\"\n            };\n        } else {\n            text1 = msg.itemser[0].name;\n            text2 = \" does not support this command\";\n            texttabl = [text1, text2];\n            var text = \"\".concat(...texttabl);\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"en-EN\"\n            };\n        }\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2110,
        "y": 880,
        "wires": [
            [
                "8db53ab4.76bd68"
            ]
        ]
    },
    {
        "id": "d6fb4c68.15b43",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "All ?",
        "property": "cmd.all",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1890,
        "y": 440,
        "wires": [
            [
                "7cdb005a.fa8c2"
            ],
            [
                "129ccf00.a2d081"
            ]
        ]
    },
    {
        "id": "129ccf00.a2d081",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Room ?",
        "property": "cmd.room",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2060,
        "y": 600,
        "wires": [
            [
                "f9f27109.3298b"
            ],
            [
                "1594ee32.0ebda2"
            ]
        ]
    },
    {
        "id": "d549c136.dc341",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\n    function findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nif (msg.cmd.type === \"lights\") {\n    findSwitchByKey(msg.deviceList, 'type', 'lights');\n    findDimmerByKey(msg.deviceList, 'type', 'dimmers');\n    msg.items = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\n} else {\n    findTypeByKey(msg.deviceList, 'type', msg.cmd.type);\n}\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2680,
        "y": 360,
        "wires": [
            [
                "5033c24a.da306c"
            ]
        ]
    },
    {
        "id": "9ff2393e.6ca618",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type in this room",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\n   function findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nif (msg.cmd.type === \"lights\") {\n    findSwitchByKey(msg.deviceList, 'type', 'lights');\n    findDimmerByKey(msg.deviceList, 'type', 'dimmers');\n    msg.items = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\n} else {\n    findTypeByKey(msg.deviceList, 'type', msg.cmd.type);\n}\n\ntmp = [];\ntmp = msg.items;\nfindRoomByKey(tmp, 'name', msg.cmd.room);\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2720,
        "y": 200,
        "wires": [
            [
                "ae184a90.e69e18"
            ]
        ]
    },
    {
        "id": "7cdb005a.fa8c2",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Room ?",
        "property": "cmd.room",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2060,
        "y": 280,
        "wires": [
            [
                "71d08367.06bf2c"
            ],
            [
                "934f647e.26e0a8"
            ]
        ]
    },
    {
        "id": "934f647e.26e0a8",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Type ?",
        "property": "cmd.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2210,
        "y": 360,
        "wires": [
            [
                "ae796b13.446728"
            ],
            [
                "94c97705.4337c8"
            ]
        ]
    },
    {
        "id": "94c97705.4337c8",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 400,
        "wires": [
            [
                "37af5205.22fefe"
            ],
            [
                "3f778129.8d316e"
            ]
        ]
    },
    {
        "id": "71d08367.06bf2c",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Type ?",
        "property": "cmd.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2210,
        "y": 200,
        "wires": [
            [
                "a85dc1b9.b99e8"
            ],
            [
                "7e0c037.996c0fc"
            ]
        ]
    },
    {
        "id": "7e0c037.996c0fc",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 240,
        "wires": [
            [
                "34ed1646.bccf4a"
            ],
            [
                "4cb157fb.a545f8"
            ]
        ]
    },
    {
        "id": "531d2c6c.0ba374",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "This device in this room",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\ntmp = [];\nfindDeviceByKey(msg.deviceList, 'name', msg.cmd.device);\ntmp = msg.items;\nfindRoomByKey(tmp, 'name', msg.cmd.room);\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2690,
        "y": 520,
        "wires": [
            [
                "2fe4258.8369fda"
            ]
        ]
    },
    {
        "id": "a85dc1b9.b99e8",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 160,
        "wires": [
            [
                "776fbdec.254b14"
            ],
            [
                "a48a4fd1.29f4"
            ]
        ]
    },
    {
        "id": "c7e562db.00f41",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "All devices with this name",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfindDeviceByKey(msg.deviceList, 'name', msg.cmd.device);\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2690,
        "y": 440,
        "wires": [
            [
                "d89f20e4.802e"
            ]
        ]
    },
    {
        "id": "ae796b13.446728",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 320,
        "wires": [
            [
                "eca2e16a.fbd32"
            ],
            [
                "6f5658c5.f28968"
            ]
        ]
    },
    {
        "id": "591afef1.25a21",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type with this name",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\n   function findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nif (msg.cmd.type === \"lights\") {\n    findSwitchByKey(msg.deviceList, 'type', 'lights');\n    findDimmerByKey(msg.deviceList, 'type', 'dimmers');\n    msg.items = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\n} else {\n    findTypeByKey(msg.deviceList, 'type', msg.cmd.type);\n}\n\ntmp = [];\ntmp = msg.items;\nfindDeviceByKey(tmp, 'name', msg.cmd.device);\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2730,
        "y": 280,
        "wires": [
            [
                "53c1ebd3.6f7da4"
            ]
        ]
    },
    {
        "id": "61b19a2.3b68864",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Type ?",
        "property": "cmd.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2210,
        "y": 680,
        "wires": [
            [
                "5b3434ee.cb087c"
            ],
            [
                "101dfdc8.804702"
            ]
        ]
    },
    {
        "id": "f9f27109.3298b",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Type ?",
        "property": "cmd.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2210,
        "y": 520,
        "wires": [
            [
                "6cfcd9cc.d68998"
            ],
            [
                "94482f0a.eaee2"
            ]
        ]
    },
    {
        "id": "101dfdc8.804702",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 720,
        "wires": [
            [
                "b292be0e.f9cf4"
            ],
            [
                "b27db3a4.dc7cd"
            ]
        ]
    },
    {
        "id": "94482f0a.eaee2",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 560,
        "wires": [
            [
                "7c297d89.68bcf4"
            ],
            [
                "624841c1.1cc21"
            ]
        ]
    },
    {
        "id": "6cfcd9cc.d68998",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 480,
        "wires": [
            [
                "d7188c11.2df4d"
            ],
            [
                "76267a40.7839b4"
            ]
        ]
    },
    {
        "id": "5b3434ee.cb087c",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Device ?",
        "property": "cmd.device",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            },
            {
                "t": "null"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2360,
        "y": 640,
        "wires": [
            [
                "49ee0a21.0e4b64"
            ],
            [
                "8aa5810.af2ab8"
            ]
        ]
    },
    {
        "id": "1594ee32.0ebda2",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "siteID as room",
        "rules": [
            {
                "t": "set",
                "p": "cmd.room",
                "pt": "msg",
                "to": "cmd.siteId",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2160,
        "y": 640,
        "wires": [
            [
                "61b19a2.3b68864"
            ]
        ]
    },
    {
        "id": "a48a4fd1.29f4",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type in this room IN",
        "links": [
            "7a934495.0d2aec"
        ],
        "x": 2455,
        "y": 180,
        "wires": []
    },
    {
        "id": "7a934495.0d2aec",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type in this room OUT",
        "links": [
            "76267a40.7839b4",
            "a48a4fd1.29f4",
            "8aa5810.af2ab8"
        ],
        "x": 2555,
        "y": 200,
        "wires": [
            [
                "9ff2393e.6ca618"
            ]
        ]
    },
    {
        "id": "76267a40.7839b4",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type in this room IN",
        "links": [
            "7a934495.0d2aec"
        ],
        "x": 2455,
        "y": 500,
        "wires": []
    },
    {
        "id": "8aa5810.af2ab8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type in this room IN",
        "links": [
            "7a934495.0d2aec"
        ],
        "x": 2455,
        "y": 660,
        "wires": []
    },
    {
        "id": "679e106e.2393f",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "This device in this room OUT",
        "links": [
            "776fbdec.254b14",
            "34ed1646.bccf4a",
            "d7188c11.2df4d",
            "7c297d89.68bcf4",
            "b292be0e.f9cf4",
            "49ee0a21.0e4b64"
        ],
        "x": 2555,
        "y": 520,
        "wires": [
            [
                "531d2c6c.0ba374"
            ]
        ]
    },
    {
        "id": "776fbdec.254b14",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "This device in this room IN",
        "links": [
            "679e106e.2393f"
        ],
        "x": 2455,
        "y": 140,
        "wires": []
    },
    {
        "id": "34ed1646.bccf4a",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "This device in this room IN",
        "links": [
            "679e106e.2393f"
        ],
        "x": 2455,
        "y": 220,
        "wires": []
    },
    {
        "id": "d7188c11.2df4d",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "This device in this room IN",
        "links": [
            "679e106e.2393f"
        ],
        "x": 2455,
        "y": 460,
        "wires": []
    },
    {
        "id": "7c297d89.68bcf4",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "This device in this room IN",
        "links": [
            "679e106e.2393f"
        ],
        "x": 2455,
        "y": 540,
        "wires": []
    },
    {
        "id": "b292be0e.f9cf4",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "This device in this room IN",
        "links": [
            "679e106e.2393f"
        ],
        "x": 2455,
        "y": 700,
        "wires": []
    },
    {
        "id": "49ee0a21.0e4b64",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "This device in this room IN",
        "links": [
            "679e106e.2393f"
        ],
        "x": 2455,
        "y": 620,
        "wires": []
    },
    {
        "id": "b27db3a4.dc7cd",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices in this room IN",
        "links": [
            "a8608837.8b7348",
            "32326085.710c6"
        ],
        "x": 2455,
        "y": 740,
        "wires": []
    },
    {
        "id": "624841c1.1cc21",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices in this room IN",
        "links": [
            "a8608837.8b7348",
            "32326085.710c6"
        ],
        "x": 2455,
        "y": 580,
        "wires": []
    },
    {
        "id": "4cb157fb.a545f8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices in this room IN",
        "links": [
            "a8608837.8b7348",
            "32326085.710c6"
        ],
        "x": 2455,
        "y": 260,
        "wires": []
    },
    {
        "id": "3f778129.8d316e",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices IN",
        "links": [
            "387718a0.a17a58"
        ],
        "x": 2455,
        "y": 420,
        "wires": []
    },
    {
        "id": "dd0e1437.01c198",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type with this name OUT",
        "links": [
            "eca2e16a.fbd32"
        ],
        "x": 2555,
        "y": 280,
        "wires": [
            [
                "591afef1.25a21"
            ]
        ]
    },
    {
        "id": "eca2e16a.fbd32",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type with this name IN",
        "links": [
            "dd0e1437.01c198"
        ],
        "x": 2455,
        "y": 300,
        "wires": []
    },
    {
        "id": "6f5658c5.f28968",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type IN",
        "links": [
            "53afd8a5.c892c8"
        ],
        "x": 2455,
        "y": 340,
        "wires": []
    },
    {
        "id": "53afd8a5.c892c8",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "All devices of this type OUT",
        "links": [
            "6f5658c5.f28968"
        ],
        "x": 2555,
        "y": 360,
        "wires": [
            [
                "d549c136.dc341"
            ]
        ]
    },
    {
        "id": "705e031f.02c8cc",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "All devices with this name OUT",
        "links": [
            "37af5205.22fefe"
        ],
        "x": 2555,
        "y": 440,
        "wires": [
            [
                "c7e562db.00f41"
            ]
        ]
    },
    {
        "id": "37af5205.22fefe",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "All devices with this name IN",
        "links": [
            "705e031f.02c8cc"
        ],
        "x": 2455,
        "y": 380,
        "wires": []
    },
    {
        "id": "98e7129d.ed083",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "=========================================================================TARGET ITEMS===========================================================================",
        "info": "",
        "x": 2430,
        "y": 100,
        "wires": []
    },
    {
        "id": "f811a936.b07ca8",
        "type": "mqtt out",
        "z": "66510db6.2b76b4",
        "name": "",
        "topic": "hermes/tts/say",
        "qos": "",
        "retain": "",
        "broker": "96de078e.0139e8",
        "x": 2980,
        "y": 1840,
        "wires": []
    },
    {
        "id": "52fd153.1efd1ec",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Absolute command feedback",
        "func": "if (msg.payload[0].Result === true) {\n    msg.payload = {\n        text: \"Okay\",\n        siteId: msg.cmd.siteId\n    };\n} else if (msg.current[0].Result !== false || msg.target[0].Result !== false) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Der Server hat nicht korrekt reagiert\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Le serveur n'a pas répondu correctement\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"The server did not answer correctly\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n} else {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Der Server antwortet nicht\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Le serveur ne répond pas\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"The server did not respond\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2380,
        "y": 1880,
        "wires": [
            [
                "fd8f3732.fdf1c8"
            ]
        ]
    },
    {
        "id": "edcbc03d.cde41",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 1,
        "x": 1910,
        "y": 1840,
        "wires": [
            [
                "1671b5d9.955e8a"
            ]
        ]
    },
    {
        "id": "1671b5d9.955e8a",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "error",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2080,
        "y": 1840,
        "wires": [
            [
                "92a2f711.66dea8"
            ]
        ]
    },
    {
        "id": "92a2f711.66dea8",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "15",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": true,
        "x": 2780,
        "y": 1840,
        "wires": [
            [
                "f811a936.b07ca8"
            ]
        ]
    },
    {
        "id": "275f0988.c68ff6",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "======================================================================SPOKEN FEEDBACK==========================================================================",
        "info": "",
        "x": 2430,
        "y": 1780,
        "wires": []
    },
    {
        "id": "439f3f8d.b1db5",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "ERROR OUT",
        "links": [
            "a568cecd.16763",
            "1e302784.344688",
            "2c1a2714.a77688",
            "4582d88b.9820c8",
            "68b1a314.79cabc",
            "1b6064a1.0c399b",
            "93952b0f.bdd238",
            "4e5bb705.ff10d8",
            "f306efe3.21ad7",
            "c89ae23a.f6724",
            "5194b040.85fa1",
            "615bacc7.262204",
            "c1b01312.c2995",
            "213a7598.2987da",
            "d4195021.b237a",
            "99638a7c.1fe6a8",
            "7e45576d.07ab68",
            "1d025b6b.f6bc45",
            "a4604461.0ef998",
            "d10cbf07.a889f",
            "9d5564c.fb0ee98"
        ],
        "x": 1815,
        "y": 1840,
        "wires": [
            [
                "edcbc03d.cde41"
            ]
        ]
    },
    {
        "id": "ae184a90.e69e18",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 200,
        "wires": [
            [
                "84170b52.4be5a8"
            ],
            [
                "2c1a2714.a77688"
            ]
        ]
    },
    {
        "id": "38076f74.ab6e6",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK OUT",
        "links": [
            "84170b52.4be5a8",
            "de27588a.6c3868",
            "3f80568e.fbec2a",
            "bf7939de.b785c8",
            "87ba3bc.605efc8",
            "82d4fca8.7b09f",
            "eb1ea2bd.234d6",
            "f7157d5.e92c58"
        ],
        "x": 1815,
        "y": 920,
        "wires": [
            [
                "eeb89753.aac668"
            ]
        ]
    },
    {
        "id": "84170b52.4be5a8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 180,
        "wires": []
    },
    {
        "id": "2c1a2714.a77688",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 220,
        "wires": []
    },
    {
        "id": "53c1ebd3.6f7da4",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 280,
        "wires": [
            [
                "de27588a.6c3868"
            ],
            [
                "4582d88b.9820c8"
            ]
        ]
    },
    {
        "id": "de27588a.6c3868",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 260,
        "wires": []
    },
    {
        "id": "4582d88b.9820c8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 300,
        "wires": []
    },
    {
        "id": "5033c24a.da306c",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 360,
        "wires": [
            [
                "3f80568e.fbec2a"
            ],
            [
                "68b1a314.79cabc"
            ]
        ]
    },
    {
        "id": "3f80568e.fbec2a",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 340,
        "wires": []
    },
    {
        "id": "68b1a314.79cabc",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 380,
        "wires": []
    },
    {
        "id": "d89f20e4.802e",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 440,
        "wires": [
            [
                "bf7939de.b785c8"
            ],
            [
                "1b6064a1.0c399b"
            ]
        ]
    },
    {
        "id": "bf7939de.b785c8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 420,
        "wires": []
    },
    {
        "id": "1b6064a1.0c399b",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 460,
        "wires": []
    },
    {
        "id": "2fe4258.8369fda",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 520,
        "wires": [
            [
                "87ba3bc.605efc8"
            ],
            [
                "93952b0f.bdd238"
            ]
        ]
    },
    {
        "id": "87ba3bc.605efc8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 500,
        "wires": []
    },
    {
        "id": "93952b0f.bdd238",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 540,
        "wires": []
    },
    {
        "id": "783e66e2.5ea8d8",
        "type": "file in",
        "z": "66510db6.2b76b4",
        "name": "Get current langage",
        "filename": "/usr/share/snips/assistant/custom_asr/config.json",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "x": 740,
        "y": 740,
        "wires": [
            [
                "45e85322.73a7fc"
            ]
        ]
    },
    {
        "id": "45e85322.73a7fc",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 910,
        "y": 740,
        "wires": [
            [
                "1792c471.3d3a7c"
            ]
        ]
    },
    {
        "id": "ac71cb3b.aa2f48",
        "type": "inject",
        "z": "66510db6.2b76b4",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 540,
        "y": 740,
        "wires": [
            [
                "783e66e2.5ea8d8"
            ]
        ]
    },
    {
        "id": "1792c471.3d3a7c",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Store_language",
        "func": "flow.set(\"msgLang\", msg.payload.language); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1060,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "718de8c5.9631c8",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "========================================================================CHECK COMMAND=========================================================================",
        "info": "",
        "x": 2430,
        "y": 820,
        "wires": []
    },
    {
        "id": "6db94027.841e4",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2970,
        "y": 880,
        "wires": [
            [
                "14f82177.313c9f"
            ],
            [
                "f306efe3.21ad7"
            ]
        ]
    },
    {
        "id": "f306efe3.21ad7",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 900,
        "wires": []
    },
    {
        "id": "8a952c34.e9c0c",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Store supported commands",
        "func": "test_lights = [\"on\",\"off\",\"an\",\"aus\"];\ntest_dimmers = [\"on\",\"off\",\"set\",\"increase\",\"decrease\",\"lower\",\"dim\",\"brighten\",\"more\",\"less\",\"stelle\",\"dimme\",\"aus\",\"aus\",\"erhohe\",\"verringere\"];\ntest_heating = [\"set\",\"increase\",\"decrease\",\"warmer\",\"colder\",\"dim\",\"less\",\"more\",\"stelle\",\"erhohe\",\"verringere\"];\ntest_blinds = [\"open\",\"close\",\"set\",\"increase\",\"decrease\",\"higher\",\"lower\",\"offne\",\"schliesse\",\"stelle\",\"erhohe\",\"verringere\"];\ntest_scenes = [\"on\",\"activate\",\"aktiviere\",\"an\"];\ntest_aux = [\"on\",\"activate\",\"deactivate\",\"off\",\"set\",\"increase\",\"decrease\",\"more\",\"less\",\"aktiviere\",\"deaktiviere\",\"erhohe\",\"verringere\",\"aus\",\"an\"];\n\nmsg.commandCat = [\n    {\n        on: {\n            on:\"\",\n            activate:\"\",\n            open:\"\",\n            offne:\"\",\n            an:\"\",\n            aktiviere:\"\"\n        },\n        off: {\n            off:\"\",\n            deactivate:\"\",\n            close:\"\",\n            deaktiviere:\"\",\n            aus:\"\",\n            schliesse:\"\"\n        },\n        set: {\n            set:\"\",\n            stelle:\"\"\n        },\n        increase: {\n            increase:\"\",\n            higher:\"\",\n            warmer:\"\",\n            brighten:\"\",\n            more:\"\",\n            erhohe:\"\"\n        },\n        decrease: {\n            decrease:\"\",\n            lower:\"\",\n            colder:\"\",\n            darker:\"\",\n            dim:\"\",\n            less:\"\",\n            cooler:\"\",\n            abnehme:\"\",\n            dimme:\"\",\n            verringere:\"\"\n        }\n    }\n];\n\nflow.set(\"msg_test_lights\", test_lights); // save for later use\nflow.set(\"msg_test_dimmers\", test_dimmers); // save for later use\nflow.set(\"msg_test_heating\", test_heating); // save for later use\nflow.set(\"msg_test_blinds\", test_blinds); // save for later use\nflow.set(\"msg_test_scenes\", test_scenes); // save for later use\nflow.set(\"msg_test_aux\", test_aux); // save for later use\nflow.set(\"msgCommandCat\", msg.commandCat); // save for later use\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 880,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "7e3ae789.27b908",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "===========================GET SUPPORTED COMMANDS===============================",
        "info": "",
        "x": 790,
        "y": 820,
        "wires": []
    },
    {
        "id": "a2034fad.81cc9",
        "type": "inject",
        "z": "66510db6.2b76b4",
        "name": "Start GET",
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "repeat": "",
        "crontab": "",
        "once": true,
        "x": 660,
        "y": 880,
        "wires": [
            [
                "8a952c34.e9c0c"
            ]
        ]
    },
    {
        "id": "acd7ca01.cbedf8",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "=======================================================================EXECUTE COMMAND========================================================================",
        "info": "",
        "x": 2430,
        "y": 1060,
        "wires": []
    },
    {
        "id": "4067a933.11e7c8",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Simplify/Translate",
        "func": "function simplifyCommandByType(array, key, value) {\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key][value];\n        if (x !== undefined) {\n            msg.cat = key;\n        }\n    }\n    return null;\n}\n\nmsg.cat = \"\";\n\nsimplifyCommandByType(msg.commandCat, \"on\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"off\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"set\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"increase\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"decrease\", msg.cmd.cmd);\n\nmsg.cmd.cmd = msg.cat;\n\nif (msg.cmd.cmd === \"set\" && msg.cmd.value === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        text = \"Ich habe den Wert nicht verstanden\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        text = \"Je n'ai pas compris la valeur\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"fr-FR\"\n        };\n    } else {\n        text = \"I did not understand the value\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2810,
        "y": 880,
        "wires": [
            [
                "6db94027.841e4"
            ]
        ]
    },
    {
        "id": "14f82177.313c9f",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND EXECUTION IN",
        "links": [
            "86c1660c.171aa8"
        ],
        "x": 3055,
        "y": 860,
        "wires": []
    },
    {
        "id": "86c1660c.171aa8",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "COMMAND EXECUTION OUT",
        "links": [
            "14f82177.313c9f",
            "c3dc35f5.c94108"
        ],
        "x": 1815,
        "y": 1220,
        "wires": [
            [
                "a6f38403.28ca88"
            ]
        ]
    },
    {
        "id": "8db53ab4.76bd68",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2270,
        "y": 880,
        "wires": [
            [
                "1dcad66c.f12c2a"
            ],
            [
                "c89ae23a.f6724"
            ]
        ]
    },
    {
        "id": "c89ae23a.f6724",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2355,
        "y": 900,
        "wires": []
    },
    {
        "id": "1dcad66c.f12c2a",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Test command",
        "func": "    function findSwitchByKey(array, key, value) {\n    msg.payload.switch_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.switch_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDimmerByKey(array, key, value) {\n    msg.payload.dimmer_lights = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        if (array[i][key] === value) {\n            msg.payload.dimmer_lights[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction simplifyCommandByType(array, key, value) {\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key][value];\n        if (x !== undefined) {\n            msg.cat = key;\n        }\n    }\n    return null;\n}\n\nmsg.cat = \"\";\n\nsimplifyCommandByType(msg.commandCat, \"on\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"off\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"set\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"increase\", msg.cmd.cmd);\nsimplifyCommandByType(msg.commandCat, \"decrease\", msg.cmd.cmd);\n\nif (msg.cmd.type === undefined) {\n    if (msg.items.length > 1) {\n        findSwitchByKey(msg.items, 'type', 'lights');\n        findDimmerByKey(msg.items, 'type', 'dimmers');\n        msg.items = msg.payload.switch_lights.concat(msg.payload.dimmer_lights);\n        msg.cmd.type = \"lights\";\n    }\n    else if (msg.items[0].type === \"dimmers\") {\n        msg.cmd.type = \"lights\";\n    }\n    else {\n        msg.cmd.type = msg.items[0].type;\n    }\n}\n\nif (msg.cat === \"\") {\n    if (msg.cmd.lang === \"de\") {\n        text = \"Entschuldigung, Ich habe deine Anweisung nicht verstanden\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        text = \"Désolé, je n'ai pas compris la commande\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"fr-FR\"\n        };\n    } else {\n        text = \"Sorry, I do not understand your command\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2460,
        "y": 880,
        "wires": [
            [
                "f149c9b7.8ba848"
            ]
        ]
    },
    {
        "id": "f149c9b7.8ba848",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2610,
        "y": 880,
        "wires": [
            [
                "4067a933.11e7c8"
            ],
            [
                "5194b040.85fa1"
            ]
        ]
    },
    {
        "id": "5194b040.85fa1",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2695,
        "y": 900,
        "wires": []
    },
    {
        "id": "5a01ac0a.9ab694",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Prepare request",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.url = [];\n\nif (msg.cmd.type === \"heating\") {\n   \tfor (var i = 0; i < msg.items.length; i++) {\n   \t\tvar val = msg.cmd.value;\n   \t\tif (val < 18){\n\t            val = 18;\n        \t} else if (val > 28) {\n        \t    val = 28;\n\t        } else {\n    \t        val = val;\n\t        }\n   \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, val];\n   \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n   \t\t\n\t}\n} else if (msg.cmd.type === \"lights\") {\n    if (msg.cmd.value !== undefined) {\n       \tfor (var i = 0; i < msg.items.length; i++) {\n       \t\tif (msg.items[i].type === \"dimmers\" && msg.cmd.cmd !== \"off\") {\n       \t\t\tvar val = msg.cmd.value*2.55;\n       \t\t\tval = precisionRound(val, 1);\n       \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n       \t\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n       \t\t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n       \t\t} \n       \t\telse if (msg.cmd.value > 0) {\n    \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n       \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n       \t\t}\n       \t\telse {\n    \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n       \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n       \t\t}\n    \t}\n    }\n    else if (msg.cmd.cmd === \"on\") {\n    \tfor (var i = 0; i < msg.items.length; i++) {\n    \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n       \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t}\n    }\n    else if (msg.cmd.cmd === \"off\") {\n    \tfor (var i = 0; i < msg.items.length; i++) {\n    \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n       \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t}\n    }\n} else if (msg.cmd.type === \"blinds\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \tif (msg.cmd.cmd === \"on\" && msg.cmd.value === undefined) {\n        \tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n    \t    msg.url[i] = \"\".concat(...msg.url[i]);\n    \t}\n    \telse if (msg.cmd.cmd === \"off\" && msg.cmd.value === undefined) {\n        \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n    \t    msg.url[i] = \"\".concat(...msg.url[i]);\n        }\n        else if (msg.cmd.value !== undefined && msg.cmd.cmd !== \"off\") {\n       \t\tvar val = (100-msg.cmd.value)*2.55;\n       \t\tval = precisionRound(val, 1);\n       \t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n       \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n       \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n        }\n    }\n} else if (msg.cmd.type === \"aux\" || msg.cmd.type === \"scenes\") {\n    if (msg.cmd.cmd === \"on\" || msg.cmd.cmd === \"set\") {\n        if (msg.cmd.value !== undefined) {\n           \tfor (var i = 0; i < msg.items.length; i++) {\n           \t\tif (msg.items[i].setDimUrl !== undefined) {\n           \t\t\tvar val = msg.cmd.value*2.55;\n           \t\t\tval = precisionRound(val, 1);\n           \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n           \t\t\tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, val];\n           \t\t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n           \t\t} \n           \t\telse if (msg.cmd.value > 0) {\n        \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n           \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n           \t\t}\n           \t\telse {\n        \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n           \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n           \t\t}\n        \t}\n        }\n        else {\n    \t    for (var i = 0; i < msg.items.length; i++) {\n    \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setOnUrl];\n       \t    \tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n        }\n    }\n    else if (msg.cmd.cmd === \"off\") {\n    \tfor (var i = 0; i < msg.items.length; i++) {\n    \t\tif (msg.items[i].setOffUrl !== undefined) {\n        \t\tmsg.url[i] = [msg.proServIP, msg.items[i].setOffUrl];\n           \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n        \t}\n    \t}\n    }\n}\n\nreturn msg; ",
        "outputs": 1,
        "noerr": 0,
        "x": 1960,
        "y": 1120,
        "wires": [
            [
                "aa2f67de.1b6e98"
            ]
        ]
    },
    {
        "id": "aa2f67de.1b6e98",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2110,
        "y": 1120,
        "wires": [
            [
                "31871981.9004b6"
            ],
            [
                "615bacc7.262204"
            ]
        ]
    },
    {
        "id": "615bacc7.262204",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2195,
        "y": 1140,
        "wires": []
    },
    {
        "id": "de4d260c.d660c8",
        "type": "split",
        "z": "66510db6.2b76b4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2450,
        "y": 1120,
        "wires": [
            [
                "4b8483ca.6ae6dc"
            ]
        ]
    },
    {
        "id": "31871981.9004b6",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2300,
        "y": 1120,
        "wires": [
            [
                "de4d260c.d660c8"
            ]
        ]
    },
    {
        "id": "4b8483ca.6ae6dc",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "50ms",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2570,
        "y": 1120,
        "wires": [
            [
                "15317fdb.7a2b2"
            ]
        ]
    },
    {
        "id": "a6f38403.28ca88",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Cmd ?",
        "property": "cmd.cmd",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "set",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "increase",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "decrease",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 5,
        "x": 1910,
        "y": 1220,
        "wires": [
            [
                "5a01ac0a.9ab694"
            ],
            [
                "5a01ac0a.9ab694"
            ],
            [
                "5a01ac0a.9ab694"
            ],
            [
                "382b89.1f198478"
            ],
            [
                "382b89.1f198478"
            ]
        ]
    },
    {
        "id": "eeb89753.aac668",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Query ?",
        "property": "cmd.query",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1920,
        "y": 920,
        "wires": [
            [
                "eae88297.1e42b"
            ],
            [
                "5add6dc5.71c3d4"
            ]
        ]
    },
    {
        "id": "5add6dc5.71c3d4",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Set type for custom answer",
        "func": "msg.cmd.type = msg.items[0].type;\nif (msg.cmd.type === \"dimmers\") {\n    msg.cmd.type = \"lights\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2140,
        "y": 960,
        "wires": [
            [
                "f669de4c.d88f7"
            ]
        ]
    },
    {
        "id": "d1c7a07f.27183",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "QUERY EXECUTION IN",
        "links": [
            "3eed48bd.ab5308"
        ],
        "x": 2495,
        "y": 960,
        "wires": []
    },
    {
        "id": "585438cd.dc2408",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "FEEDBACK OUT",
        "links": [
            "38c20aa3.c5dbd6",
            "f5194c71.11e09",
            "a44d34dd.dfd5e8"
        ],
        "x": 1815,
        "y": 1940,
        "wires": [
            [
                "a6a1ffd5.0f98c"
            ]
        ]
    },
    {
        "id": "78cbf03c.7997d",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Type ?",
        "property": "cmd.type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "heating",
                "vt": "str"
            },
            {
                "t": "neq",
                "v": "heating",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1910,
        "y": 1540,
        "wires": [
            [
                "5f177861.1cd698"
            ],
            [
                "693236c0.4fa058"
            ]
        ]
    },
    {
        "id": "382b89.1f198478",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "GET Current",
        "func": "msg.url = [];\n\nif (msg.items[0].type === \"heating\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \tmsg.url[i] = [msg.proServIP, msg.items[i].getTargetUrl];\n    \tmsg.url[i] = \"\".concat(...msg.url[i]);\n    }\n} else if (msg.cmd.type === \"aux\" || msg.cmd.type === \"scenes\" || msg.cmd.type === \"lights\" || msg.cmd.type === \"dimmers\") {\n    var cptok=0;\n    var cpter=0;\n    msg.itemsok=[];\n    msg.itemser=[];\n    for (var i = 0; i < msg.items.length; i++) {\n        if(msg.items[i].getCurrentUrl !== undefined && msg.items[i].setDimUrl !== undefined) {\n            msg.itemsok[cptok]=msg.items[i];\n            cptok++;\n        } else {\n            msg.itemser[cpter]=msg.items[i];\n            cpter++;\n        }\n    }\n    if (msg.itemsok[0] !== undefined) {\n        for (var i = 0; i < msg.itemsok.length; i++) {\n        \tmsg.url[i] = [msg.proServIP, msg.itemsok[i].getCurrentUrl];\n        \tmsg.url[i] = \"\".concat(...msg.url[i]);\n        }\n    }\n}\n\n\nif (msg.itemser.length > 0 && msg.itemsok.length === 0) {\n    if (msg.itemser.length > 1) {\n        if (msg.cmd.lang === \"de\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" und \";\n            text3 = msg.itemser.length-1;\n            text4 = \" \";\n            texttabl = [text1, text2, text3, text4];\n            var text = \"\".concat(...texttabl);            \n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" et \";\n            text3 = msg.itemser.length-1;\n            text4 = \" autres appareils ne supportent pas cette commande\";\n            texttabl = [text1, text2, text3, text4];\n            var text = \"\".concat(...texttabl);            \n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"fr-FR\"\n            };\n        } else {\n            text1 = msg.itemser[0].name;\n            text2 = \" and \";\n            text3 = msg.itemser.length-1;\n            text4 = \" other devices do not support this command\";\n            texttabl = [text1, text2, text3, text4];\n            var text = \"\".concat(...texttabl);            \n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"en-EN\"\n            };\n        }\n    } else {\n        if (msg.cmd.lang === \"de\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" \";\n            texttabl = [text1, text2];\n            var text = \"\".concat(...texttabl);\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            text1 = msg.itemser[0].name;\n            text2 = \" ne supporte pas cette commande\";\n            texttabl = [text1, text2];\n            var text = \"\".concat(...texttabl);\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"fr-FR\"\n            };\n        } else {\n            text1 = msg.itemser[0].name;\n            text2 = \" does not support this command\";\n            texttabl = [text1, text2];\n            var text = \"\".concat(...texttabl);\n            msg.error = {\n                text: text,\n                siteId: msg.cmd.siteId,\n                lang: \"en-EN\"\n            };\n        }\n    }\n}\n \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2090,
        "y": 1200,
        "wires": [
            [
                "843adbf0.a65298"
            ]
        ]
    },
    {
        "id": "3f57e5ce.74e44a",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "GET Current",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2830,
        "y": 1200,
        "wires": [
            [
                "b0cfd96c.51c088"
            ]
        ]
    },
    {
        "id": "4294443a.2e46ac",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "50ms",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2690,
        "y": 1200,
        "wires": [
            [
                "3f57e5ce.74e44a"
            ]
        ]
    },
    {
        "id": "c3bd5482.8daab8",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "move msg.payload",
        "rules": [
            {
                "t": "set",
                "p": "target",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "current",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2250,
        "y": 1260,
        "wires": [
            [
                "7288f8ef.7f18a8"
            ]
        ]
    },
    {
        "id": "72ff4bee.104eb4",
        "type": "split",
        "z": "66510db6.2b76b4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2570,
        "y": 1200,
        "wires": [
            [
                "4294443a.2e46ac"
            ]
        ]
    },
    {
        "id": "e552216d.5bb69",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2420,
        "y": 1200,
        "wires": [
            [
                "72ff4bee.104eb4"
            ]
        ]
    },
    {
        "id": "e4462ceb.209ca",
        "type": "join",
        "z": "66510db6.2b76b4",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2090,
        "y": 1260,
        "wires": [
            [
                "c3bd5482.8daab8"
            ]
        ]
    },
    {
        "id": "b0cfd96c.51c088",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 2970,
        "y": 1200,
        "wires": [
            [
                "e4462ceb.209ca"
            ]
        ]
    },
    {
        "id": "7288f8ef.7f18a8",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Prepare_request",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.url = [];\nmsg.newVal= [];\n\nif (msg.items[0].type === \"heating\" && msg.cmd.cmd === \"decrease\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tif (msg.cmd.value !== undefined) {\n\t\t    var val = msg.cmd.value;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target-val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t\telse {\n\t\t    var val = 2;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target-val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t}\n} else if (msg.items[0].type === \"heating\" && msg.cmd.cmd === \"increase\") {\n\tfor (var i = 0; i < msg.items.length; i++) {\n\t\tif (msg.cmd.value !== undefined) {\n\t\t    var val = msg.cmd.value;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target+val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t\telse {\n\t\t    var val = 2;\n\t\t    var target = msg.target[i].Data[0].Value;\n\t\t    var newVal = target+val;\n\t\t    if (newVal < 18){\n\t            newVal = 18;\n        \t} else if (newVal > 28) {\n        \t    newVal = 28;\n\t        } else {\n    \t        newVal = newVal;\n\t        }\n\t\t    msg.newVal[i] = newVal;\n\t\t    msg.url[i] = [msg.proServIP, msg.items[i].setTargetUrl, newVal];\n   \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n\t\t}\n\t}\n} else if (msg.cmd.type === \"lights\" && msg.cmd.cmd ===\"increase\") {\n    cptok = 0;\n    for (var i = 0; i < msg.items.length; i++) {\n        if (msg.items[i].type === \"dimmers\") {\n    \t    if (msg.cmd.value !== undefined){\n    \t\t    var val = msg.cmd.value*2.55;\n    \t\t    val = precisionRound(val, 1);\n    \t\t    var newVal = msg.current[i].Data[0].Value+val;\n    \t\t    if (newVal > 255) {\n    \t    \t    newVal = 255;\n    \t        }\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[cptok] = \"\".concat(...msg.url[cptok]);\n    \t\t    cptok++;\n    \t    }\n    \t    else {\n    \t        var newVal = msg.current[i].Data[0].Value+51;\n    \t\t    if (newVal > 255) {\n    \t    \t    newVal = 255;\n    \t        }\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[cptok] = \"\".concat(...msg.url[cptok]);\n    \t\t    cptok++;\n    \t    }\n        }\n    }\n} else if (msg.cmd.type === \"lights\" && msg.cmd.cmd ===\"decrease\") {\n    cptok = 0;\n    for (var i = 0; i < msg.items.length; i++) {\n        if (msg.items[i].type === \"dimmers\") {\n       \t\tif (msg.cmd.value !== undefined) {\n       \t\t    var val = msg.cmd.value*2.55;\n       \t\t    val = precisionRound(val, 1);\n       \t\t    var newVal = msg.current[i].Data[0].Value-val;\n       \t\t    if (newVal < 0) {\n       \t\t        newVal = 0;\n       \t\t    }\n       \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n       \t\t    msg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n       \t    \tmsg.url[cptok] = \"\".concat(...msg.url[cptok]);\n       \t    \tcptok++;\n       \t\t} else {\n                var newVal = msg.current[i].Data[0].Value-51;\n       \t\t    if (newVal < 0) {\n       \t\t        newVal = 0;\n       \t\t    }\n       \t\t\tmsg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n            \tmsg.url[cptok] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n        \t\tmsg.url[cptok] = \"\".concat(...msg.url[cptok]);\n        \t\tcptok++;\n       \t\t}\n        }\n    }\n} else if (msg.items[0].type === \"blinds\" && msg.cmd.cmd ===\"decrease\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \t    if (msg.cmd.value !== undefined){\n    \t\t    var val = msg.cmd.value*2.55;\n    \t\t    val = precisionRound(val, 1);\n    \t\t    var newVal = msg.current[i].Data[0].Value+val;\n    \t\t    if (newVal > 255) {\n    \t    \t    newVal = 255;\n    \t        }\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n    \t    else {\n    \t        var newVal = msg.current[i].Data[0].Value+51;\n    \t\t    if (newVal > 255) {\n    \t    \t    newVal = 255;\n    \t        }\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t\t    msg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n    \t\t    msg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n        \n    }\n\n} else if (msg.items[0].type === \"blinds\" && msg.cmd.cmd ===\"increase\") {\n    \n    \t    if (msg.cmd.value !== undefined) {\n    \t        var val = msg.cmd.value*2.55;\n    \t    \tval = precisionRound(val, 1);\n    \t    \tvar newVal = msg.current[i].Data[0].Value-val;\n    \t    \tif (newVal < 0) {\n    \t    \t    newVal = 0;\n    \t    \t}\n    \t\t    msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n    \t    \tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n        \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n    \t    }\n    \t    else {\n    \t        var newVal = msg.current[i].Data[0].Value-51;\n    \t    \tif (newVal < 0) {\n    \t    \t    newVal = 0;\n        \t    }\n                msg.items[i].setDimUrl = msg.items[i].setDimUrl.replace(\"${intensity.byte}\", '');\n            \tmsg.url[i] = [msg.proServIP, msg.items[i].setDimUrl, newVal];\n        \t\tmsg.url[i] = \"\".concat(...msg.url[i]);\n        \t}\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2450,
        "y": 1260,
        "wires": [
            [
                "f5993371.9f148"
            ]
        ]
    },
    {
        "id": "235dd6c3.eded3a",
        "type": "split",
        "z": "66510db6.2b76b4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2793.5713958740234,
        "y": 1260.0001573562622,
        "wires": [
            [
                "dc581612.5b4a28"
            ]
        ]
    },
    {
        "id": "f5993371.9f148",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2640.714286804199,
        "y": 1260.0000867843628,
        "wires": [
            [
                "235dd6c3.eded3a"
            ]
        ]
    },
    {
        "id": "dc581612.5b4a28",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "50ms",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2916.4287452697754,
        "y": 1260.0001392364502,
        "wires": [
            [
                "4db40013.8e377"
            ]
        ]
    },
    {
        "id": "38c20aa3.c5dbd6",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "FEEDBACK IN",
        "links": [
            "585438cd.dc2408"
        ],
        "x": 3055,
        "y": 1320,
        "wires": []
    },
    {
        "id": "f5194c71.11e09",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "FEEDBACK IN",
        "links": [
            "585438cd.dc2408"
        ],
        "x": 3055,
        "y": 1120,
        "wires": []
    },
    {
        "id": "843adbf0.a65298",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2230,
        "y": 1200,
        "wires": [
            [
                "e552216d.5bb69"
            ],
            [
                "213a7598.2987da"
            ]
        ]
    },
    {
        "id": "213a7598.2987da",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2315,
        "y": 1220,
        "wires": []
    },
    {
        "id": "5f177861.1cd698",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "GET_Target",
        "func": "//Prepare all HTTP requests for GET Current Temp and put them in msg.url\n\nmsg.url = [];\n\nfor (var i = 0; i < msg.items.length; i++) {\n\tmsg.url[i] = [msg.proServIP, msg.items[i].getTargetUrl];\n\tmsg.url[i] = \"\".concat(...msg.url[i]);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2090,
        "y": 1480,
        "wires": [
            [
                "e3f77a54.af47c8"
            ]
        ]
    },
    {
        "id": "120499d7.0d23e6",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "GET Target",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2710,
        "y": 1480,
        "wires": [
            [
                "6d9411bf.4978f"
            ]
        ]
    },
    {
        "id": "15c9c1b6.988c3e",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2550,
        "y": 1480,
        "wires": [
            [
                "120499d7.0d23e6"
            ]
        ]
    },
    {
        "id": "c304ea79.b5d108",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "target",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2550,
        "y": 1540,
        "wires": [
            [
                "693236c0.4fa058"
            ]
        ]
    },
    {
        "id": "efa8d871.97f0b8",
        "type": "split",
        "z": "66510db6.2b76b4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2410,
        "y": 1480,
        "wires": [
            [
                "15c9c1b6.988c3e"
            ]
        ]
    },
    {
        "id": "e3f77a54.af47c8",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2260,
        "y": 1480,
        "wires": [
            [
                "efa8d871.97f0b8"
            ]
        ]
    },
    {
        "id": "ad372e76.0889d",
        "type": "join",
        "z": "66510db6.2b76b4",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2970,
        "y": 1480,
        "wires": [
            [
                "c304ea79.b5d108"
            ]
        ]
    },
    {
        "id": "6d9411bf.4978f",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 2848.571357727051,
        "y": 1480.0000076293945,
        "wires": [
            [
                "ad372e76.0889d"
            ]
        ]
    },
    {
        "id": "693236c0.4fa058",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "GET_Current",
        "func": "msg.url = [];\n\nif (msg.cmd.type === \"heating\") {\n    for (var i = 0; i < msg.items.length; i++) {\n    \tmsg.url[i] = [msg.proServIP, msg.items[i].getCurrentUrl];\n    \tmsg.url[i] = \"\".concat(...msg.url[i]);\n    }\n} else if (msg.cmd.type === \"aux\" || msg.cmd.type === \"scenes\" || msg.cmd.type === \"lights\" || msg.cmd.type === \"dimmers\" || msg.cmd.type === \"blinds\") {\n    var cptok=0;\n    var cpter=0;\n    msg.itemsok=[];\n    msg.itemser=[];\n    for (var i = 0; i < msg.items.length; i++) {\n        if(msg.items[i].getCurrentUrl !== undefined) {\n            msg.itemsok[cptok]=msg.items[i];\n            cptok++;\n        } else {\n            msg.itemser[cpter]=msg.items[i];\n            cpter++;\n        }\n    }\n    \n    if (msg.itemsok[0] !== undefined) {\n        for (var i = 0; i < msg.itemsok.length; i++) {\n        \tmsg.url[i] = [msg.proServIP, msg.itemsok[i].getCurrentUrl];\n        \tmsg.url[i] = \"\".concat(...msg.url[i]);\n        }\n    }\n    \n    if (msg.itemser.length > 0 && msg.itemsok.length === 0) {\n        if (msg.itemser.length > 1) {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" und \";\n                text3 = msg.itemser.length-1;\n                text4 = \" \";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" et \";\n                text3 = msg.itemser.length-1;\n                text4 = \" autres appareils ne supportent pas cette commande\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemser[0].name;\n                text2 = \" and \";\n                text3 = msg.itemser.length-1;\n                text4 = \" other devices do not support this command\";\n                texttabl = [text1, text2, text3, text4];\n                var text = \"\".concat(...texttabl);            \n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        } else {\n            if (msg.cmd.lang === \"de\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" \";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            } else if (msg.cmd.lang === \"fr\") {\n                text1 = msg.itemser[0].name;\n                text2 = \" ne supporte pas cette commande\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            } else {\n                text1 = msg.itemser[0].name;\n                text2 = \" does not support this command\";\n                texttabl = [text1, text2];\n                var text = \"\".concat(...texttabl);\n                msg.error = {\n                    text: text,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2080,
        "y": 1600,
        "wires": [
            [
                "40115ea.0f480a"
            ]
        ]
    },
    {
        "id": "ed9c1228.9814b",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "GET Current",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2930,
        "y": 1600,
        "wires": [
            [
                "de62d3a1.1294"
            ]
        ]
    },
    {
        "id": "913f4359.d92f6",
        "type": "delay",
        "z": "66510db6.2b76b4",
        "name": "",
        "pauseType": "delay",
        "timeout": "50",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 2747.857280731201,
        "y": 1600.000051498413,
        "wires": [
            [
                "ed9c1228.9814b"
            ]
        ]
    },
    {
        "id": "82da82.d99b958",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "current",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2390,
        "y": 1680,
        "wires": [
            [
                "a44d34dd.dfd5e8"
            ]
        ]
    },
    {
        "id": "37d9c863.6a6798",
        "type": "split",
        "z": "66510db6.2b76b4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2590,
        "y": 1600,
        "wires": [
            [
                "913f4359.d92f6"
            ]
        ]
    },
    {
        "id": "18609fc0.36964",
        "type": "change",
        "z": "66510db6.2b76b4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "url",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2420,
        "y": 1600,
        "wires": [
            [
                "37d9c863.6a6798"
            ]
        ]
    },
    {
        "id": "c979b054.7baa",
        "type": "join",
        "z": "66510db6.2b76b4",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2210,
        "y": 1680,
        "wires": [
            [
                "82da82.d99b958"
            ]
        ]
    },
    {
        "id": "de62d3a1.1294",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 2070,
        "y": 1680,
        "wires": [
            [
                "c979b054.7baa"
            ]
        ]
    },
    {
        "id": "a44d34dd.dfd5e8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "FEEDBACK IN",
        "links": [
            "585438cd.dc2408"
        ],
        "x": 2515,
        "y": 1680,
        "wires": []
    },
    {
        "id": "40115ea.0f480a",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2230,
        "y": 1600,
        "wires": [
            [
                "18609fc0.36964"
            ],
            [
                "d4195021.b237a"
            ]
        ]
    },
    {
        "id": "d4195021.b237a",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2315,
        "y": 1620,
        "wires": []
    },
    {
        "id": "3eed48bd.ab5308",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "QUERY EXECUTION OUT",
        "links": [
            "d1c7a07f.27183"
        ],
        "x": 1815,
        "y": 1540,
        "wires": [
            [
                "78cbf03c.7997d"
            ]
        ]
    },
    {
        "id": "15317fdb.7a2b2",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "Send URL",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2710,
        "y": 1120,
        "wires": [
            [
                "6911e714.f526d8"
            ]
        ]
    },
    {
        "id": "ebfa77d4.b3bea8",
        "type": "join",
        "z": "66510db6.2b76b4",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2970,
        "y": 1120,
        "wires": [
            [
                "f5194c71.11e09"
            ]
        ]
    },
    {
        "id": "6911e714.f526d8",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 2850,
        "y": 1120,
        "wires": [
            [
                "ebfa77d4.b3bea8"
            ]
        ]
    },
    {
        "id": "4db40013.8e377",
        "type": "http request",
        "z": "66510db6.2b76b4",
        "name": "Send URL",
        "method": "GET",
        "ret": "txt",
        "url": "{{{payload}}}",
        "tls": "",
        "x": 2710,
        "y": 1320,
        "wires": [
            [
                "3979991b.4e3a66"
            ]
        ]
    },
    {
        "id": "f44c1857.26c248",
        "type": "join",
        "z": "66510db6.2b76b4",
        "name": "",
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "joinerType": "str",
        "accumulate": false,
        "timeout": "",
        "count": "",
        "x": 2970,
        "y": 1320,
        "wires": [
            [
                "38c20aa3.c5dbd6"
            ]
        ]
    },
    {
        "id": "3979991b.4e3a66",
        "type": "json",
        "z": "66510db6.2b76b4",
        "name": "",
        "pretty": false,
        "x": 2850,
        "y": 1320,
        "wires": [
            [
                "f44c1857.26c248"
            ]
        ]
    },
    {
        "id": "40f0298c.2fdbd8",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "========================================================================EXECUTE QUERY==========================================================================",
        "info": "",
        "x": 2430,
        "y": 1420,
        "wires": []
    },
    {
        "id": "a6a1ffd5.0f98c",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Query ?",
        "property": "cmd.query",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1920,
        "y": 1940,
        "wires": [
            [
                "267d056d.6d757a"
            ],
            [
                "a7da2dc7.72335"
            ]
        ]
    },
    {
        "id": "267d056d.6d757a",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "",
        "property": "cmd.cmd",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "set",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "increase",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "decrease",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 5,
        "x": 2170,
        "y": 1900,
        "wires": [
            [
                "52fd153.1efd1ec"
            ],
            [
                "52fd153.1efd1ec"
            ],
            [
                "52fd153.1efd1ec"
            ],
            [
                "a69595c0.bf0338"
            ],
            [
                "a69595c0.bf0338"
            ]
        ]
    },
    {
        "id": "a69595c0.bf0338",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Relative command feedback",
        "func": "if (msg.cmd.type === \"aux\" && msg.cmd.type === \"lights\" && msg.cmd.type === \"blinds\") {\n    if (msg.payload[0].Result === true) {\n        msg.payload = {\n            text: \"Okay\",\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n} else if (msg.cmd.type === \"heating\") {\n    msg.text = [];\n    if (msg.cmd.lang === \"fr\") {\n        for (var i = 0; i < msg.payload.length; i++) {\n            if (msg.payload[i].Result === true) {\n                var room = msg.items[i].zone;\n                var target = msg.newVal[i];\n                var text1 = \"Okay, le thermostat est réglé sur \";\n                var text2 = \" dégrés dans la zone \";\n                msg.text[i] = [text1, target, text2, room];\n                var endText = \"\".concat(...msg.text[i]);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"de\") {\n        for (var i = 0; i < msg.payload.length; i++) {\n            if (msg.payload[i].Result === true) {\n                var room = msg.items[i].zone;\n                var target = msg.newVal[i];\n                var text1 = \"Okay, die Heizung ist aus \";\n                var text2 = \" Grad im \";\n                var text3 = \" eingestellt\";\n                msg.text[i] = [text1, target, text2, room, text3];\n                var endText = \"\".concat(...msg.text[i]);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else {\n        for (var i = 0; i < msg.payload.length; i++) {\n            if (msg.payload[i].Result === true) {\n                var room = msg.items[i].zone;\n                var target = msg.newVal[i];\n                var text1 = \"Okay, setting the heating to \";\n                var text2 = \" degrees in the \";\n                msg.text[i] = [text1, target, text2, room];\n                var endText = \"\".concat(...msg.text[i]);\n                msg.payload = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2380,
        "y": 1920,
        "wires": [
            [
                "708b9362.3494bc"
            ]
        ]
    },
    {
        "id": "6e1bf30e.81fcfc",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Query feedback",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.payload = [];\nmsg.text = [];\n\nif (msg.cmd.type === \"lights\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.lang === \"fr\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Die Helligkeit von \";\n                    var text3 = \" ist auf \";\n                    var text4 = \" Prozent eingestellt\";\n                    msg.text[i] = [text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"'s luminosity is set to  \";\n                    var text3 = \" percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} else if (msg.cmd.type === \"heating\" && msg.current !== undefined && msg.target !== undefined) {\n    if (msg.cmd.lang === \"fr\"){\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Le thermostat est réglé sur \";\n                var text2 = \" dans la zone \";\n                var text3 = \" pour une température actuelle de \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Die Heizung ist auf \";\n                var text2 = \" grad im \";\n                var text3 = \" eingestellt bei einer aktuellen Temperatur von \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n                var text1 = \"Heating is set to \";\n                var text2 = \" degrees in the \";\n                var text3 = \", with a current temperature of \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n} if (msg.cmd.type === \"aux\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Das Gerät \";\n                    var text3 = \"ist auf \";\n                    var text4 = \"Prozent eingestellt\";\n                    msg.text[i] = [text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is set to  \";\n                    var text3 = \"percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} if (msg.cmd.type === \"blinds\" && msg.current !== undefined){\n    if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist geoffnet\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \"ist geschlossen\"; \n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist auf \";\n                    var text3 = \" Prozent gestellt\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"fr\") {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text3 = \"L'appareil \";\n                    var text2 = \"est éteint\"; \n                    msg.text[i] = [text1, text3, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est réglé sur \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is fully open\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is closed\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (typeof(current) !== \"boolean\" && current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is \";\n                    var text3 = \" percent open\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang:\"en-EN\"\n                };\n            }\n        }\n    }\n\n\n} else if ((msg.cmd.type === \"heating\" && (msg.current === undefined || msg.target === undefined))|| \n(msg.current === undefined && msg.cmd.type !== \"heating\")) {\n    msg.error = [];\n    if (msg.current[0].Result !== false || msg.target[0].Result !== false) {\n        if (msg.cmd.lang === \"de\") {\n            msg.error = {\n                text: \"Der Server hat nicht korrekt reagiert\",\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            msg.error = {\n                text: \"Le serveur n'a pas répondu correctement\",\n                siteId: msg.cmd.siteId,\n                lang:\"fr-FR\"\n            };\n        } else {\n            msg.error = {\n                text: \"The server did not react correctly\",\n                siteId: msg.cmd.siteId,\n                lang:\"en-EN\"\n            };\n        }\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2300,
        "y": 1960,
        "wires": [
            [
                "da749ffa.28648"
            ]
        ]
    },
    {
        "id": "a5f5231.27acae",
        "type": "mqtt in",
        "z": "66510db6.2b76b4",
        "name": "",
        "topic": "hermes/intent/ProKNX:home_control",
        "qos": "2",
        "broker": "96de078e.0139e8",
        "x": 580,
        "y": 160,
        "wires": [
            [
                "dd84dd95.a6ff8"
            ]
        ]
    },
    {
        "id": "a8608837.8b7348",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "All devices in this room OUT",
        "links": [
            "624841c1.1cc21",
            "b27db3a4.dc7cd",
            "4cb157fb.a545f8"
        ],
        "x": 2555,
        "y": 680,
        "wires": [
            [
                "b0d6901d.d3cc9"
            ]
        ]
    },
    {
        "id": "b0d6901d.d3cc9",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "All devices in this room",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfindRoomByKey(msg.deviceList, 'name', msg.cmd.room);\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2680,
        "y": 680,
        "wires": [
            [
                "4409b57f.47f8ec"
            ]
        ]
    },
    {
        "id": "4409b57f.47f8ec",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 680,
        "wires": [
            [
                "eb1ea2bd.234d6"
            ],
            [
                "99638a7c.1fe6a8"
            ]
        ]
    },
    {
        "id": "eb1ea2bd.234d6",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 660,
        "wires": []
    },
    {
        "id": "99638a7c.1fe6a8",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 700,
        "wires": []
    },
    {
        "id": "eb7c4fff.49a1b",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "test ProSerIP",
        "func": "if (msg.proServIP === \"\" || msg.proServIP === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        text = \"Bitte überprüfen Sie die adresse von ProServ\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        text = \"Veuillez vérifier l'adresse du Proserv\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"fr-FR\"\n        };\n    } else {\n        text = \"Please check the configuration of the ProServ address\";\n        msg.error = {\n            text: text,\n            siteId: msg.cmd.siteId,\n            lang: \"en-EN\"\n        };\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 580,
        "wires": [
            [
                "e4fdedca.043b6"
            ]
        ]
    },
    {
        "id": "e4fdedca.043b6",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 770,
        "y": 580,
        "wires": [
            [
                "e1d0067d.9cce48"
            ],
            [
                "7e45576d.07ab68"
            ]
        ]
    },
    {
        "id": "7e45576d.07ab68",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 855,
        "y": 600,
        "wires": []
    },
    {
        "id": "fd8f3732.fdf1c8",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2570,
        "y": 1880,
        "wires": [
            [
                "92a2f711.66dea8"
            ],
            [
                "1d025b6b.f6bc45"
            ]
        ]
    },
    {
        "id": "1d025b6b.f6bc45",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2655,
        "y": 1900,
        "wires": []
    },
    {
        "id": "708b9362.3494bc",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2570,
        "y": 1920,
        "wires": [
            [
                "92a2f711.66dea8"
            ],
            [
                "a4604461.0ef998"
            ]
        ]
    },
    {
        "id": "a4604461.0ef998",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2655,
        "y": 1940,
        "wires": []
    },
    {
        "id": "3ca89ded.d7cbd2",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Error ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2570,
        "y": 1960,
        "wires": [
            [
                "f811a936.b07ca8"
            ],
            [
                "d10cbf07.a889f"
            ]
        ]
    },
    {
        "id": "d10cbf07.a889f",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 2655,
        "y": 1980,
        "wires": []
    },
    {
        "id": "da749ffa.28648",
        "type": "split",
        "z": "66510db6.2b76b4",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 2450,
        "y": 1960,
        "wires": [
            [
                "3ca89ded.d7cbd2"
            ]
        ]
    },
    {
        "id": "c6dd4960.394bc8",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "All devices",
        "func": "String.prototype.sansAccent = function() {\n    var accent = [\n        /[\\300-\\306]/g, /[\\340-\\346]/g, // A, a\n        /[\\310-\\313]/g, /[\\350-\\353]/g, // E, e\n        /[\\314-\\317]/g, /[\\354-\\357]/g, // I, i\n        /[\\322-\\330]/g, /[\\362-\\370]/g, // O, o\n        /[\\331-\\334]/g, /[\\371-\\374]/g, // U, u\n        /[\\321]/g, /[\\361]/g, // N, n\n        /[\\307]/g, /[\\347]/g, // C, c\n    ];\n    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];\n     \n    var str = this;\n    for(var i = 0; i < accent.length; i++){\n        str = str.replace(accent[i], noaccent[i]);\n    }\n     \n    return str;\n};\n\n//put an array of objets located in the room given in parameters in msg.room\nfunction findRoomByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key].toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[0] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findDeviceByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        x = x.toLowerCase().sansAccent();\n        x = x.split(\"   \");\n        if (x[1] === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nfunction findTypeByKey(array, key, value) {\n    msg.items = [];\n    var cpt = 0;\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key];\n        if (x === value) {\n            msg.items[cpt] = array[i];\n            cpt ++;\n        }\n    }\n    return null;\n}\n\nmsg.items = [];\nmsg.items = msg.deviceList;\n\nif (msg.items[0] === undefined) {\n    if (msg.cmd.lang === \"de\") {\n        msg.error = {\n            text: \"Entschuldigung, ich kann dieses Gerät nicht finden\",\n            siteId: msg.cmd.siteId,\n            lang: \"de-DE\"\n        };\n    } else if (msg.cmd.lang === \"fr\") {\n        msg.error = {\n            text: \"Désolé je n'ai pas pu trouver cet appareil\",\n            siteId: msg.cmd.siteId,\n            lang:\"fr-FR\"\n        };\n    } else {\n        msg.error = {\n            text: \"Sorry I can not find this device\",\n            siteId: msg.cmd.siteId,\n            lang:\"en-EN\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2650,
        "y": 600,
        "wires": [
            [
                "c33abaa6.fa7098"
            ]
        ]
    },
    {
        "id": "c33abaa6.fa7098",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Items ?",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2960,
        "y": 600,
        "wires": [
            [
                "f7157d5.e92c58"
            ],
            [
                "9d5564c.fb0ee98"
            ]
        ]
    },
    {
        "id": "f7157d5.e92c58",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "COMMAND CHECK IN",
        "links": [
            "38076f74.ab6e6"
        ],
        "x": 3055,
        "y": 580,
        "wires": []
    },
    {
        "id": "9d5564c.fb0ee98",
        "type": "link out",
        "z": "66510db6.2b76b4",
        "name": "ERROR IN",
        "links": [
            "439f3f8d.b1db5"
        ],
        "x": 3055,
        "y": 620,
        "wires": []
    },
    {
        "id": "387718a0.a17a58",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "All devices OUT",
        "links": [
            "3f778129.8d316e"
        ],
        "x": 2555,
        "y": 600,
        "wires": [
            [
                "c6dd4960.394bc8"
            ]
        ]
    },
    {
        "id": "5874c56c.fbfe3c",
        "type": "link in",
        "z": "66510db6.2b76b4",
        "name": "TARGET ITEMS OUT",
        "links": [
            "e443f6e.2335a08"
        ],
        "x": 655,
        "y": 1220,
        "wires": [
            [
                "f0581a8c.9822f8",
                "cd51839e.60687",
                "1c9abf17.8a0f81",
                "27753d89.c72732",
                "b4860e6e.e16e6",
                "14f553e3.7388bc",
                "e1e37e69.e4627",
                "dd20711a.541da",
                "75972daa.2cb514",
                "cb37e6a7.fd46e8",
                "92ed3742.31ce18",
                "464ed67e.b61148"
            ]
        ]
    },
    {
        "id": "75972daa.2cb514",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.room",
        "x": 800,
        "y": 1200,
        "wires": []
    },
    {
        "id": "cb37e6a7.fd46e8",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.cmd",
        "x": 800,
        "y": 1160,
        "wires": []
    },
    {
        "id": "dd20711a.541da",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.device",
        "x": 800,
        "y": 1240,
        "wires": []
    },
    {
        "id": "e1e37e69.e4627",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.value",
        "x": 800,
        "y": 1280,
        "wires": []
    },
    {
        "id": "14f553e3.7388bc",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.query",
        "x": 800,
        "y": 1320,
        "wires": []
    },
    {
        "id": "92ed3742.31ce18",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.lang",
        "x": 800,
        "y": 1120,
        "wires": []
    },
    {
        "id": "cd51839e.60687",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "deviceList",
        "x": 799.8571341378347,
        "y": 1080,
        "wires": []
    },
    {
        "id": "b4860e6e.e16e6",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "commandList",
        "x": 810,
        "y": 1360,
        "wires": []
    },
    {
        "id": "27753d89.c72732",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.type",
        "x": 800,
        "y": 1400,
        "wires": []
    },
    {
        "id": "1c9abf17.8a0f81",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "proServIP",
        "x": 800,
        "y": 1440,
        "wires": []
    },
    {
        "id": "f0581a8c.9822f8",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "cmd.all",
        "x": 790,
        "y": 1040,
        "wires": []
    },
    {
        "id": "464ed67e.b61148",
        "type": "debug",
        "z": "66510db6.2b76b4",
        "name": "",
        "active": false,
        "console": "false",
        "complete": "false",
        "x": 790,
        "y": 1480,
        "wires": []
    },
    {
        "id": "9e4576af.101498",
        "type": "comment",
        "z": "66510db6.2b76b4",
        "name": "================================DEBUGGING TOOLS===================================",
        "info": "",
        "x": 790,
        "y": 980,
        "wires": []
    },
    {
        "id": "1b241ce0.df5c83",
        "type": "trigger",
        "z": "66510db6.2b76b4",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "pay",
        "duration": "1",
        "extend": false,
        "units": "min",
        "reset": "",
        "name": "",
        "x": 710,
        "y": 460,
        "wires": [
            [
                "8ec34fe0.26ebc"
            ]
        ]
    },
    {
        "id": "f669de4c.d88f7",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Simplify/Translate",
        "func": "function simplifyCommandByType(array, key, value) {\n    for (var i = 0; i < array.length; i++) {\n        var x = array[i][key][value];\n        if (x !== undefined) {\n            msg.cat = key;\n        }\n    }\n    return null;\n}\n\nif (msg.cmd.cmd !== undefined) {\n    msg.cat = \"\";\n    simplifyCommandByType(msg.commandCat, \"on\", msg.cmd.cmd);\n    simplifyCommandByType(msg.commandCat, \"off\", msg.cmd.cmd);\n    msg.cmd.cmd = msg.cat;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2370,
        "y": 960,
        "wires": [
            [
                "d1c7a07f.27183"
            ]
        ]
    },
    {
        "id": "a7da2dc7.72335",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "Cmd ?",
        "property": "cmd.cmd",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "on",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "off",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 3,
        "x": 2050,
        "y": 1960,
        "wires": [
            [
                "6e1bf30e.81fcfc"
            ],
            [
                "6e1bf30e.81fcfc"
            ],
            [
                "6e1bf30e.81fcfc"
            ]
        ]
    },
    {
        "id": "ff56efbc.77613",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Query feedback",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.payload = [];\nmsg.text = [];\n\nif (msg.cmd.type === \"lights\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.cmd === \"on\" && (msg.current[0].Data[0].Value === true || (msg.current[0].Data[0].Value > 0 && msg.current[0].Data[0].Value <256) )) {\n            msg.true = true;\n        } else if (msg.current[0].Data[0].Value === false || msg.current[0].Data[0].Value === 0) {\n            msg.true = false;\n        }\n        if (msg.cmd.lang === \"fr\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text4, text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Die Helligkeit des \";\n                    var text3 = \"ist auf \";\n                    var text4 = \"Prozent eingestellt\";\n                    msg.text[i] = [text4, text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current !== false && current !== true && (current > 0 && current <256)){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"'s luminosity is set to  \";\n                    var text3 = \"percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} else if (msg.cmd.type === \"heating\" && msg.current !== undefined && msg.target !== undefined) {\n    if (msg.cmd.lang === \"fr\"){\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Le thermostat est réglé sur \";\n                var text2 = \" dans la zone \";\n                var text3 = \" pour une température actuelle de \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Die Heizung ist auf \";\n                var text2 = \" grad im \";\n                var text3 = \" eingestellt bei einer aktuellen Temperatur von \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n                var text1 = \"Heating is set to \";\n                var text2 = \" degrees in the \";\n                var text3 = \", with a current temperature of \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n} if (msg.cmd.type === \"aux\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.cmd === \"on\" && (msg.current[0].Data[0].Value === true || (msg.current[0].Data[0].Value > 0 && msg.current[0].Data[0].Value <256) )) {\n            msg.true = true;\n        } else if (msg.current[0].Data[0].Value === false || msg.current[0].Data[0].Value === 0) {\n            msg.true = false;\n        }\n        if (msg.cmd.lang === \"fr\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text4, text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Das Gerät \";\n                    var text3 = \"ist auf \";\n                    var text4 = \"Prozent eingestellt\";\n                    msg.text[i] = [text4, text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is set to  \";\n                    var text3 = \"percent\";\n                    msg.text[i] = [text4, text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} if (msg.cmd.type === \"blinds\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.cmd === \"on\" && (msg.current[0].Data[0].Value === true || (msg.current[0].Data[0].Value > 0 && msg.current[0].Data[0].Value <256) )) {\n            msg.true = true;\n        } else if (msg.current[0].Data[0].Value === false || msg.current[0].Data[0].Value === 0) {\n            msg.true = false;\n        }\n        if (msg.cmd.lang === \"de\") {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist geoffnet\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \"ist geschlossen\"; \n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <255){\n                    if (msg.true === true) { var text4 = \"Ja, \";} else if (msg.true === false) { var text4 = \"Nein, \";} else {var text4 = \"\";}\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist auf \";\n                    var text3 = \" Prozent gestellt\";\n                    msg.text[i] = [text4, text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else if (msg.cmd.lang === \"fr\") {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text3 = \"L'appareil \";\n                    var text2 = \"est éteint\"; \n                    msg.text[i] = [text4, text1, text3, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <255){\n                    if (msg.true === true) { var text4 = \"Oui, \";} else if (msg.true === false) { var text4 = \"Non, \";} else {var text4 = \"\";}\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est réglé sur \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text4, text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is fully open\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is closed\";\n                    msg.text[i] = [text4, text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <255){\n                    if (msg.true === true) { var text4 = \"Yes, \";} else if (msg.true === false) { var text4 = \"No, \";} else {var text4 = \"\";}\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is \";\n                    var text3 = \" percent open\";\n                    msg.text[i] = [text4, text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang:\"en-EN\"\n                };\n            }\n        }\n    }\n\n\n} else if ((msg.cmd.type === \"heating\" && (msg.current === undefined || msg.target === undefined))|| \n(msg.current === undefined && msg.cmd.type !== \"heating\")) {\n    msg.error = [];\n    if (msg.current[0].Result !== false || msg.target[0].Result !== false) {\n        if (msg.cmd.lang === \"de\") {\n            msg.error = {\n                text: \"Der Server hat nicht korrekt reagiert\",\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            msg.error = {\n                text: \"Le serveur n'a pas répondu correctement\",\n                siteId: msg.cmd.siteId,\n                lang:\"fr-FR\"\n            };\n        } else {\n            msg.error = {\n                text: \"The server did not react correctly\",\n                siteId: msg.cmd.siteId,\n                lang:\"en-EN\"\n            };\n        }\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2300,
        "y": 2000,
        "wires": [
            [
                "da749ffa.28648"
            ]
        ]
    },
    {
        "id": "f25a6b30.1937c8",
        "type": "switch",
        "z": "66510db6.2b76b4",
        "name": "",
        "property": "items[1]",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2150,
        "y": 2020,
        "wires": [
            [
                "ff56efbc.77613"
            ],
            [
                "6680cc35.cdc7b4"
            ]
        ]
    },
    {
        "id": "6680cc35.cdc7b4",
        "type": "function",
        "z": "66510db6.2b76b4",
        "name": "Query feedback",
        "func": "function precisionRound(number, precision) {\n  var factor = Math.pow(10, precision);\n  return Math.round(number * factor) / factor;\n}\n\nmsg.payload = [];\nmsg.text = [];\n\nif (msg.cmd.type === \"lights\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.lang === \"fr\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Die Leuchtkraft des \";\n                    var text3 = \"ist auf \";\n                    var text4 = \"Prozent eingestellt\";\n                    msg.text[i] = [text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current !== false && current !== true && (current > 0 && current <256)){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"'s luminosity is set to  \";\n                    var text3 = \"percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} else if (msg.cmd.type === \"heating\" && msg.current !== undefined && msg.target !== undefined) {\n    if (msg.cmd.lang === \"fr\"){\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Le thermostat est réglé sur \";\n                var text2 = \" dans la zone \";\n                var text3 = \" pour une température actuelle de \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n           \t\tvar text1 = \"Die Heizung ist auf \";\n                var text2 = \" grad im \";\n                var text3 = \" eingestellt bei einer aktuellen Temperatur von \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true && msg.target[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var target = msg.target[i].Data[0].Value;\n                var current = precisionRound(msg.current[i].Data[0].Value, 0);\n                var room = msg.items[i].zone;\n                var text1 = \"Heating is set to \";\n                var text2 = \" degrees in the \";\n                var text3 = \", with a current temperature of \";\n                msg.text[i] = [text1, target, text2, room, text3, current];\n           \t\tvar endText = \"\".concat(...msg.text[i]);\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    }\n} if (msg.cmd.type === \"aux\" && msg.current !== undefined){\n    if (msg.current[0].Result === true) {\n        if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est éteint\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumée à \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        } else if (msg.cmd.lang === \"de\"){\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist aus\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist an\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \"Das Gerät \";\n                    var text3 = \"ist auf \";\n                    var text4 = \"Prozent eingestellt\";\n                    msg.text[i] = [text2, text1, text3, current, text4];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        } else {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is off\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is on\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <256){\n                    var current = precisionRound(current/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is set to  \";\n                    var text3 = \"percent\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"en-EN\"\n                };\n            }\n        }\n    } \n} if (msg.cmd.type === \"blinds\" && msg.current !== undefined){\n    if (msg.cmd.lang === \"de\") {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist geoffnet\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \"ist geschlossen\"; \n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" ist auf \";\n                    var text3 = \" Prozent gestellt\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"de-DE\"\n                };\n            }\n        }\n    } else if (msg.cmd.lang === \"fr\") {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est allumé\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text3 = \"L'appareil \";\n                    var text2 = \"est éteint\"; \n                    msg.text[i] = [text1, text3, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" est réglé sur \";\n                    var text3 = \" pourcents\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang: \"fr-FR\"\n                };\n            }\n        }\n    } else {\n        if (msg.current[0].Result === true) {\n            for (var i = 0; i < msg.items.length; i++) {\n                var current = msg.current[i].Data[0].Value;\n                if (current === false || current === 0){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is fully open\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current === true || current === 255){\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is closed\";\n                    msg.text[i] = [text1, text2];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                if (current > 0 && current <255){\n                    var current = precisionRound((255-current)/2.55, 0);\n                    var text1 = msg.items[i].name;\n                    var text2 = \" is \";\n                    var text3 = \" percent open\";\n                    msg.text[i] = [text1, text2, current, text3];\n                    msg.text[i] = [text1, text2, current, text3];\n                    var endText = \"\".concat(...msg.text[i]);\n                }\n                msg.payload[i] = {\n                    text: endText,\n                    siteId: msg.cmd.siteId,\n                    lang:\"en-EN\"\n                };\n            }\n        }\n    }\n\n\n} else if ((msg.cmd.type === \"heating\" && (msg.current === undefined || msg.target === undefined))|| \n(msg.current === undefined && msg.cmd.type !== \"heating\")) {\n    msg.error = [];\n    if (msg.current[0].Result !== false || msg.target[0].Result !== false) {\n        if (msg.cmd.lang === \"de\") {\n            msg.error = {\n                text: \"Der Server hat nicht korrekt reagiert\",\n                siteId: msg.cmd.siteId,\n                lang: \"de-DE\"\n            };\n        } else if (msg.cmd.lang === \"fr\") {\n            msg.error = {\n                text: \"Le serveur n'a pas répondu correctement\",\n                siteId: msg.cmd.siteId,\n                lang:\"fr-FR\"\n            };\n        } else {\n            msg.error = {\n                text: \"The server did not react correctly\",\n                siteId: msg.cmd.siteId,\n                lang:\"en-EN\"\n            };\n        }\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2300,
        "y": 2040,
        "wires": [
            [
                "da749ffa.28648"
            ]
        ]
    },
    {
        "id": "96de078e.0139e8",
        "type": "mqtt-broker",
        "z": "66510db6.2b76b4",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "usetls": false,
        "compatmode": true,
        "keepalive": "60",
        "cleansession": true,
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": ""
    }
]
